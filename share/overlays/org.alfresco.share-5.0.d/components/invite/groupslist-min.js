(function(){var a=YAHOO.util.Dom,r=YAHOO.util.Event,m=YAHOO.util.Element;var n=Alfresco.util.encodeHTML;Alfresco.GroupsList=function(t){Alfresco.GroupsList.superclass.constructor.call(this,"Alfresco.GroupsList",t,["button","container","datasource","datatable","json"]);this.listWidgets=[];this.uniqueRecordId=1;YAHOO.Bubbling.on("itemSelected",this.onItemSelected,this);return this};YAHOO.extend(Alfresco.GroupsList,Alfresco.component.Base,{options:{siteId:"",roles:[]},listWidgets:null,uniqueRecordId:null,onReady:function s(){if(YAHOO.env.ua.webkit>0){a.setStyle(this.id+"-backTo","vertical-align","sub")}this.widgets.addButton=Alfresco.util.createYUIButton(this,"add-button",this.addButtonClick);this.widgets.allRolesSelect=Alfresco.util.createYUIButton(this,"selectallroles-button",this.onSelectAllRoles,{type:"menu",menu:"selectallroles-menu"});this.widgets.dataSource=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});this._setupDataTable();this._enableDisableAddButton();var u=this,v=function t(x,w){u.removeItem.call(u,w[1].anchor);w[1].stop=true;return true};YAHOO.Bubbling.addDefaultAction("remove-item-button",v);a.setStyle(this.id+"-invitationBar","visibility","visible")},_setupDataTable:function q(){var z=this;var t=function v(E,C,F,G){var D=C.getData("itemName"),B=C.getData("displayName");E.innerHTML='<h3 class="itemname">'+n(B)+' <span class="lighter theme-color-1">('+n(D)+")</span></h3>"};var x=function y(N,P,L,C){a.setStyle(N.parentNode,"width",L.width+"px");a.setStyle(N,"overflow","visible");var O=new m(N),D=P.getData("id"),M=z.id+"-roleselector-"+D;var J=a.get(z.id+"-role-column-template"),E=J.cloneNode(true);E.setAttribute("id","actionsDiv"+D);a.setStyle(E,"display","");var K=[],H;for(var G=0,F=z.options.roles.length;G<F;G++){H=z.options.roles[G];K.push({text:z.msg("role."+H),value:H,onclick:{fn:z.onRoleSelect,obj:{record:P,role:H},scope:z}})}O.appendChild(E);var B=a.getElementsByClassName("role-selector-button","button",E);var I=new YAHOO.widget.Button(B[0],{type:"menu",name:M,label:z.getRoleLabel(P)+" "+Alfresco.constants.MENU_ARROW_SYMBOL,menu:K});z.listWidgets[D]={button:I}};var u=function w(C,B,D,F){a.setStyle(C.parentNode,"width",D.width+"px");var E='<span id="'+z.id+'-removeItem">  <a href="#" class="remove-item-button"><span class="removeIcon">&nbsp;</span></a></span>';C.innerHTML=E};var A=[{key:"item",label:"Item",sortable:false,formatter:t},{key:"role",label:"Role",sortable:false,formatter:x,width:140},{key:"remove",label:"Remove",sortable:false,formatter:u,width:30}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-inviteelist",A,this.widgets.dataSource,{MSG_EMPTY:this.msg("groupslist.empty-list")})},getRoleLabel:function e(t){if(t.getData("role")!==undefined){return this.msg("role."+t.getData("role"))}return this.msg("groupslist.selectrole")},onItemSelected:function k(v,u){var w=u[1],t={id:this.uniqueRecordId++,itemName:w.itemName,displayName:w.displayName};this.widgets.dataTable.addRow(t);this._enableDisableAddButton()},removeItem:function c(u){var t=this.widgets.dataTable.getRecord(u);YAHOO.Bubbling.fire("itemDeselected",{itemName:t.getData("itemName")});this.widgets.dataTable.deleteRow(t);this._enableDisableAddButton()},onSelectAllRoles:function i(w,v,u){var t=v[1].value;if(t===""){return}this._setAllRolesImpl(t);this._enableDisableAddButton();r.preventDefault(v[0])},onRoleSelect:function f(x,w,v){var u=v.role,t=v.record;this._setRoleForRecord(t,u);this._enableDisableAddButton();r.preventDefault(w[0])},_setAllRolesImpl:function d(t){var x=this.widgets.dataTable.getRecordSet(),u;for(var v=0,w=x.getLength();v<w;v++){u=x.getRecord(v);this._setRoleForRecord(u,t)}this._enableDisableAddButton()},_setRoleForRecord:function g(t,u){t.setData("role",u);this.listWidgets[t.getData("id")].button.set("label",this.getRoleLabel(t)+" "+Alfresco.constants.MENU_ARROW_SYMBOL)},_checkAllRolesSet:function h(){var w=this.widgets.dataTable.getRecordSet(),t;for(var v=0,u=w.getLength();v<u;v++){t=w.getRecord(v);if(t.getData("role")===undefined){return false}}return true},_enableDisableAddButton:function b(){var t=this.widgets.dataTable.getRecordSet().getLength()>0&&this._checkAllRolesSet();this.widgets.addButton.set("disabled",!t)},addButtonClick:function l(y){var w=this.widgets.dataTable.getRecordSet();if(w.getLength()<0||!this._checkAllRolesSet()){this._enableDisableAddButton();return}this.widgets.addButton.set("disabled",true);this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:this.msg("message.please-wait"),spanClass:"wait",displayTime:0});var x=[];for(var v=0,u=w.getLength();v<u;v++){x.push(w.getRecord(v))}var t={recs:x,size:x.length,index:0,successes:[],failures:[]};this._processResultData(t)},_processResultData:function p(t){if(t.index>=t.size){this._finalizeResults(t);return}this._doAddResult(t)},_doAddResult:function o(w){var t=w.recs[w.index];var y=function x(z){w.successes.push(w.index);w.index++;this._processResultData(w)};var v=function u(z){w.failures.push(w.index);w.index++;this._processResultData(w)};Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/sites/"+this.options.siteId+"/memberships",method:"POST",requestContentType:"application/json",responseContentType:"application/json",dataObj:{group:{fullName:t.getData("itemName")},role:t.getData("role")},successCallback:{fn:y,scope:this},failureCallback:{fn:v,scope:this}})},_finalizeResults:function j(t){for(var u=t.successes.length-1;u>=0;u--){this.widgets.dataTable.deleteRow(t.successes[u])}this.widgets.feedbackMessage.destroy();Alfresco.util.PopupManager.displayMessage({text:this.msg("message.result",t.successes.length,t.failures.length)});this.widgets.addButton.set("disabled",false)}})})();