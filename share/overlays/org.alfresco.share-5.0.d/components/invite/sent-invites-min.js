(function(){var g=YAHOO.util.Dom;var f=Alfresco.util.encodeHTML;Alfresco.SentInvites=function(m){Alfresco.SentInvites.superclass.constructor.call(this,"Alfresco.SentInvites",m,["button","container","datasource","datatable","json"]);this.actionButtons={};this.searchTerm="";this.isSearching=false;return this};YAHOO.extend(Alfresco.SentInvites,Alfresco.component.Base,{options:{siteId:"",minSearchTermLength:0,maxSearchResults:100,setFocus:false},actionButtons:null,searchTerm:null,isSearching:null,onReady:function j(){var r=this;var s=g.get(this.id+"-search-text");var n=new YAHOO.util.KeyListener(s,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:function(){r.onSearchClick()},scope:this,correctScope:true},"keydown");n.enable();if(this.options.setFocus){s.focus()}this.widgets.searchButton=Alfresco.util.createYUIButton(this,"search-button",this.onSearchClick);var p=Alfresco.constants.PROXY_URI+"api/invites?";this.widgets.dataSource=new YAHOO.util.DataSource(p,{responseType:YAHOO.util.DataSource.TYPE_JSON,responseSchema:{resultsList:"invites"}});this.widgets.dataSource.doBeforeParseData=function t(F,K){var y=K;if(K){var E=[];if(r.searchTerm.length>0){var x=r.searchTerm.toLowerCase();var w=x;var L=["/","\\\\","\\?","\\+","\\$","\\.","\\^","\\(","\\)"];for(var I=0,H=L.length;I<H;I++){w=w.replace(new RegExp(L[I],"g"),L[I])}var G=w.search("\\*")==0;if(G){w=w.substring(1)}w=w.replace(new RegExp("\\*","g"),".*");var J=new RegExp(w,"i");var C,z,u,D,N;var v,A,B,M;for(var I=0,H=K.invites.length;I<H;I++){C=K.invites[I].invitee;z=(C.userName||"").toLowerCase();u=(C.firstName||"").toLowerCase();D=(C.lastName||"").toLowerCase();N=(u+" "+D).toLowerCase();v=J.exec(z);A=J.exec(u);B=J.exec(D);M=J.exec(N);if((v!=null&&v[0]!="")||(A!=null&&A[0]!="")||(B!=null&&B[0]!="")||(v=null&&M[0]!="")){if(G){E.push(K.invites[I])}else{if((v!=null&&v.index==0)||(A!=null&&A.index==0)||(B!=null&&B.index==0)||(v=null&&M.index==0)){E.push(K.invites[I])}}}}}else{E=K.invites}E.sort(function(P,O){var R=P.invitee.firstName+P.invitee.lastName,Q=O.invitee.firstName+O.invitee.lastName;return(R>Q)?1:(R<Q)?-1:0});y={invites:E}}return y};this._setupDataTable();if(this.options.setFocus){g.get(this.id+"-search-text").focus()}var o=function q(v,u){r.onSearchClick.call(r,u,null);return false};var m=new YAHOO.util.KeyListener(this.id+"-search-button",{keys:YAHOO.util.KeyListener.KEY.ENTER},o,"keydown");m.enable()},_setupDataTable:function k(){var t=this;var p=function o(x,w,z,A){g.setStyle(x.parentNode,"width",z.width+"px");var v=Alfresco.constants.URL_RESCONTEXT+"components/images/no-user-photo-64.png",y=w.getData("invitee");if(y.avatar!==undefined){v=Alfresco.constants.PROXY_URI+y.avatar+"?c=queue&ph=true"}x.innerHTML='<img class="avatar" src="'+v+'" alt="avatar" />'};var q=function(y){var x=y.userName,z=y.firstName,w=y.lastName,v="";if((z!==undefined)||(w!==undefined)){x=z?z+" ":"";x+=w?w:"";v=' <span class="lighter">('+f(y.userName)+")</span>"}return Alfresco.util.userProfileLink(y.userName,x)+v};var n=function s(x,w,z,C){var y=w.getData("invitee"),v=Alfresco.util.formatDate(w.getData("sentInviteDate")),B=t.msg("role."+w.getData("role"));var A='<div class="to-invitee"><span class="attr-label">'+t.msg("info.to")+": </span>";A+='<span class="attr-value">'+q(y)+"</span>";A+="</div>";A+="<div>";A+='<span class="attr-label">'+t.msg("info.sent")+": </span>";A+='<span class="attr-value">'+f(v)+"</span>";A+='<span class="separator"> | </span>';A+='<span class="attr-label">'+t.msg("info.role")+": </span>";A+='<span class="attr-value">'+f(B)+"</span>";A+="</div>";x.innerHTML=A};var m=function u(y,w,A,B){g.setStyle(y.parentNode,"width",A.width+"px");var x=w.getData("invitee").userName;y.innerHTML='<span id="'+t.id+"-action-"+x+'"></span>';var z;if(w.getData("invitationStatus")=="pending"){z=t.msg("button.cancel")}else{z=t.msg("button.clear")}var v=new YAHOO.widget.Button({type:"button",label:z,name:t.id+"-selectbutton-"+x,container:t.id+"-action-"+x,onclick:{fn:t.onActionClick,obj:w,scope:t}});t.actionButtons[x]=v};var r=[{key:"avatar",label:"Avatar",sortable:false,formatter:p,width:70},{key:"person",label:"Description",sortable:false,formatter:n},{key:"actions",label:"Actions",sortable:false,formatter:m,width:100}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",r,this.widgets.dataSource,{renderLoopSize:32,initialLoad:false,MSG_EMPTY:this.msg("message.empty")});this.widgets.dataTable.subscribe("rowMouseoverEvent",this.widgets.dataTable.onEventHighlightRow);this.widgets.dataTable.subscribe("rowMouseoutEvent",this.widgets.dataTable.onEventUnhighlightRow);if(this.options.minSearchTermLength<=0){this._performSearch("")}},clearResults:function a(){if(this.widgets.dataTable){var m=this.widgets.dataTable.getRecordSet().getLength();if(m>0){this.widgets.dataTable.deleteRows(0,m)}}g.get(this.id+"-search-text").value=""},cancelInvite:function i(n){this.actionButtons[n.getData("invitee").userName].set("disabled",true);this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:this.msg("message.removing"),spanClass:"wait",displayTime:0});var r=function m(s){this.widgets.feedbackMessage.destroy();var t=this.widgets.dataTable.getRecordIndex(n);if(t!==null){this.widgets.dataTable.deleteRow(t)}};var p=function q(s){this.widgets.feedbackMessage.destroy();this.actionButtons[n.getData("invitee").userName].set("disabled",true)};var o=Alfresco.constants.PROXY_URI+"api/invite/cancel";Alfresco.util.Ajax.request({url:o,method:"GET",dataObj:{inviteId:n.getData("inviteId"),siteShortName:encodeURIComponent(this.options.siteId)},responseContentType:"application/json",successMessage:this.msg("message.cancel.success"),successCallback:{fn:r,scope:this},failureMessage:this.msg("message.cancel.failure"),failureCallback:{fn:p,scope:this}})},onActionClick:function d(m,n){this.cancelInvite(n)},onSearchClick:function c(n,o){var m=YAHOO.lang.trim(g.get(this.id+"-search-text").value);if(m.replace(/\*/g,"").length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.minimum-length",this.options.minSearchTermLength)});return}this._performSearch(m)},_setDefaultDataTableErrors:function e(m){var n=Alfresco.util.message;m.set("MSG_EMPTY",n("message.empty","Alfresco.SentInvites"));m.set("MSG_ERROR",n("message.error","Alfresco.SentInvites"))},_performSearch:function l(m){if(!this.isSearching){this.isSearching=true;this._setDefaultDataTableErrors(this.widgets.dataTable);var p=this.widgets.dataTable.getRecordSet().getLength();if(p>0){this.widgets.dataTable.deleteRows(0,p)}var n=function r(s,t,u){this._enableSearchUI();this._setDefaultDataTableErrors(this.widgets.dataTable);if(t.results.length>0){this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,s,t,u)}};var o=function q(t,u){this._enableSearchUI();if(u.status==401){window.location.reload()}else{try{var s=YAHOO.lang.JSON.parse(u.responseText);this.widgets.dataTable.set("MSG_ERROR",s.message);this.widgets.dataTable.showTableMessage(s.message,YAHOO.widget.DataTable.CLASS_ERROR)}catch(v){this._setDefaultDataTableErrors(this.widgets.dataTable)}}};this.searchTerm=m;this.widgets.dataSource.sendRequest(this._buildSearchParams(m),{success:n,failure:o,scope:this});this.widgets.searchButton.set("disabled",true);YAHOO.lang.later(2000,this,function(){if(this.isSearching){if(!this.widgets.feedbackMessage){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.searching",this.name),spanClass:"wait",displayTime:0})}else{if(!this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.show()}}}})}},_enableSearchUI:function b(){if(this.widgets.feedbackMessage&&this.widgets.feedbackMessage.cfg.getProperty("visible")){this.widgets.feedbackMessage.hide()}this.widgets.searchButton.set("disabled",false);this.isSearching=false},_buildSearchParams:function h(m){return YAHOO.lang.substitute("siteShortName={siteShortName}",{siteShortName:encodeURIComponent(this.options.siteId)})}})})();