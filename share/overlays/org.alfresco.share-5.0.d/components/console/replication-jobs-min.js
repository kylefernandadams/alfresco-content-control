(function(){var e=YAHOO.util.Dom,E=YAHOO.util.Event,y=YAHOO.util.Selector;var w=Alfresco.util.encodeHTML,z=Alfresco.util.siteURL;var i="org.alfresco.share.admin.replicationJobs",m=i+".sortBy";var g="Cancelled",t="CancelRequested",s="Completed",k="Failed",B="New",l="Pending",d="Running";Alfresco.ConsoleReplicationJobs=function(F){this.name="Alfresco.ConsoleReplicationJobs";Alfresco.ConsoleReplicationJobs.superclass.constructor.call(this,F);Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["button","container","json","history"],this.onComponentsLoaded,this);var H=this;this.jobList=[];this.jobListIdToName={};this.jobListNameToId={};this.selectedJob=null;this.summaryStatusOrder=[k,s,d,g,B];this.summaryStatusMap={};this.summaryStatusMap[k]=k;this.summaryStatusMap[s]=s;this.summaryStatusMap[d]=d;this.summaryStatusMap[l]=d;this.summaryStatusMap[t]=d;this.summaryStatusMap[g]=g;this.summaryStatusMap[B]=B;ReplicationPanelHandler=function G(){ReplicationPanelHandler.superclass.constructor.call(this,"replication")};YAHOO.extend(ReplicationPanelHandler,Alfresco.ConsolePanelHandler,{onLoad:function I(){H.widgets.createJob=Alfresco.util.createYUIButton(H,"create",null,{type:"link"});H.widgets.sortBy=Alfresco.util.createYUIButton(H,"sortBy",H.onSortJobs,{type:"menu",menu:"sortBy-menu",lazyloadmenu:false});H.widgets.sortBy.getMenu().subscribe("click",function(K,J){var L=J[1];if(L){H.widgets.sortBy.set("label",H.msg("button.sort-by",L.cfg.getProperty("text")));H.onSortByChanged.call(H,J[1])}});H.widgets.sortBy.value="status";H.widgets.runJob=Alfresco.util.createYUIButton(H,"run",H.onRunJob,{disabled:true});H.widgets.cancelJob=Alfresco.util.createYUIButton(H,"cancel",H.onCancelJob,{disabled:true});H.widgets.editJob=Alfresco.util.createYUIButton(H,"edit",H.onEditJob,{disabled:true});H.widgets.deleteJob=Alfresco.util.createYUIButton(H,"delete",H.onDeleteJob,{disabled:true})}});new ReplicationPanelHandler();return this};YAHOO.extend(Alfresco.ConsoleReplicationJobs,Alfresco.ConsoleTool,{jobList:null,jobListIdToName:null,jobListNameToId:null,selectedJob:null,summaryStatusOrder:null,summaryStatusMap:null,options:{jobName:"",targetGroupPath:""},onReady:function D(){Alfresco.ConsoleReplicationJobs.superclass.onReady.call(this);this.services.preferences=new Alfresco.service.Preferences();var G=this.services.preferences.get();var I=Alfresco.util.findValueByDotNotation(G,m,null);if(I!=null&&this.widgets.sortBy!=null){this.widgets.sortBy.value=I;var H=this.widgets.sortBy.getMenu().getItems();for(var F in H){if(H.hasOwnProperty(F)){if(H[F].value===I){this.widgets.sortBy.set("label",this.msg("button.sort-by",H[F].cfg.getProperty("text")));break}}}}this.populateJobsList(true)},populateJobsList:function h(F){Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"api/replication-definitions",dataObj:{sort:this.widgets.sortBy!=null?this.widgets.sortBy.value:null},successCallback:{fn:function G(H){if(H&&H.json&&H.json.data){this.jobList=H.json.data;if(F&&this.options.jobName===""&&this.jobList.length>0){this.options.jobName=this.jobList[0].name}this.renderJobsList();this.updateSummaryPanel()}else{Alfresco.util.PopupManager.displayPrompt({text:this._msg("message.invalid-data.failure",H.config.url)})}},scope:this},failureMessage:this._msg("message.get-definitions.failure")})},renderJobsList:function n(){if(!YAHOO.lang.isArray(this.jobList)){return}var Q=this,L=this.jobList,I=e.get(this.id+"-jobsList"),F="selected";I.innerHTML="";this.jobListIdToName={};this.jobListNameToId={};var R=function S(){return function W(){var X=y.query("li",I);e.removeClass(X,F);e.addClass(this,F);if(Q.jobListIdToName.hasOwnProperty(this.id)){Q.onJobSelected(Q.jobListIdToName[this.id])}return false}};try{var N=null,K,G,J,P,T,U,H;if(L.length===0){I.innerHTML='<div class="no-jobs">'+this.msg("label.no-jobs")+"</div>"}else{G=document.createElement("ul");I.appendChild(G);for(var M=0,V=L.length;M<V;M++){K=L[M];J=document.createElement("li");J.className=K.enabled?"enabled":"disabled";J.title=this._msg("job."+J.className);if(this.selectedJob!==null&&this.selectedJob.name==K.name){J.className+=" selected"}J.onclick=R();H=Alfresco.util.generateDomId(J);this.jobListIdToName[H]=K.name;this.jobListNameToId[K.name]=H;P=document.createElement("a");P.className=(K.status||"none").toLowerCase();P.href="#";T=document.createElement("span");U=document.createTextNode(K.name);T.appendChild(U);P.appendChild(T);J.appendChild(P);G.appendChild(J);if(K.name==this.options.jobName){e.addClass(J,"selected");this.options.jobName=null;YAHOO.lang.later(100,this,this.onJobSelected,[K.name,false])}else{if(this.selectedJob&&this.selectedJob.name==K.name){e.addClass(J,"selected")}}}}}catch(O){I.innerHTML='<span class="error">'+this.msg("message.error-unknown")+"</span>"}},findJobIndexByName:function o(H){for(var F=0,G=this.jobList.length;F<G;F++){if(this.jobList[F].name==H){return F}}return null},onJobSelected:function a(I,G){var F=this.findJobIndexByName(I);if(F===null){return}Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"api/replication-definition/"+encodeURIComponent(I),successCallback:{fn:function H(J){if(J&&J.json&&J.json.data){this.jobList[F]=J.json.data;this.selectedJob=this.jobList[F];this.renderJobDetail();if(G==true){Alfresco.util.Anim.fadeIn(this.id+"-jobStatus",{period:0.2})}else{e.setStyle(this.id+"-jobStatus","opacity",1)}}else{Alfresco.util.PopupManager.displayPrompt({text:this._msg("message.invalid-data.failure",J.config.url)})}},scope:this},failureMessage:this._msg("message.get-job-details.failure",I)})},renderJobDetail:function A(){var H=e.get(this.id+"-jobDetail");if(this.selectedJob===null){H.innerHTML='<div class="message">'+this._msg("label.no-job-selected")+"</div>"}else{var K=Alfresco.util.deepCopy(this.selectedJob),J=e.get(this.id+"-jobTemplate"),G="",R="",S="",X="",O="",F="";K.name=w(K.name);K.description=w(K.description);K.enabledClass=K.enabled?"enabled":"disabled";K.enabledText=this._msg("job."+K.enabledClass);if(K.startedAt&&K.startedAt.iso8601){G=this._msg("label.started-at",Alfresco.util.formatDate(Alfresco.util.fromISO8601(K.startedAt.iso8601)))}if(K.endedAt&&K.endedAt.iso8601){R=this._msg("label.ended-at",Alfresco.util.formatDate(Alfresco.util.fromISO8601(K.endedAt.iso8601)))}S=(K.status||"none").toLowerCase();X='<div class="'+w(S)+'">'+this._msg("label.status."+S,G,R)+"</div>";X+=K.failureMessage?'<div class="warning">'+w(K.failureMessage)+"</div>":"";K.statusText=X;var T=y.query("a",this.jobListNameToId[K.name])[0];if(T!==null){T.className=w(S)}K.viewReportLocalLink="#";K.viewReportRemoteLink="#";if(K.transferLocalReport!==null){K.viewReportLocalLink=z("document-details?nodeRef="+w(K.transferLocalReport))}if(K.transferRemoteReport!==null){K.viewReportRemoteLink=z("document-details?nodeRef="+w(K.transferRemoteReport))}var V=K.schedule;if(V){var I=Alfresco.util.formatDate(Alfresco.util.fromISO8601(V.start.iso8601)),W=V.intervalCount,N=this._msg("date-unit."+(W===1?"single.":"plural.")+V.intervalPeriod.toLowerCase());K.scheduleHTML=this._msg("label.schedule.details",I,(W===1?"":W+" "),N)}else{K.scheduleHTML=this._msg("label.schedule.none")}if(K.targetName===null){K.targetNameClass="warning";K.targetHTML=this._msg("label.transfer-target.none")}else{O=z("repository?file={file}&filter=path&filterData={path}",{file:encodeURIComponent(K.targetName),path:encodeURIComponent(this.options.targetGroupPath)});K.targetNameClass=K.targetExists?"server":"warning ";K.targetHTML='<a href="'+O+'">'+w(K.targetName)+"</a>"}var L="",P,Q=Alfresco.util.bind(function(Y){return Alfresco.util.siteURL((Y.isFolder?"folder":"document")+"-details?nodeRef="+w(Y.nodeRef))},this);if(K.payload&&K.payload.length>0){for(var U=0,M=K.payload.length;U<M;U++){P=K.payload[U];L+='<div class="'+(P.isFolder?"folder":"document")+'"><a href="'+Q(P)+'" title="'+w(P.path)+'">'+w(P.name)+"</a></div>"}}else{L='<div class="warning">'+this.msg("label.payload.none")+"</div>"}K.payloadHTML=L;F=YAHOO.lang.substitute(window.unescape(J.innerHTML),K);if(this.widgets.refreshJob instanceof YAHOO.widget.Button){this.widgets.refreshJob.destroy();this.widgets.refreshJob=null}if(this.widgets.viewReportLocal instanceof YAHOO.widget.Button){this.widgets.viewReportLocal.destroy();this.widgets.viewReportLocal=null}if(this.widgets.viewReportRemote instanceof YAHOO.widget.Button){this.widgets.viewReportRemote.destroy();this.widgets.viewReportRemote=null}H.innerHTML=F;this.widgets.refreshJob=Alfresco.util.createYUIButton(this,"refresh",this.onRefreshJob);this.widgets.viewReportLocal=Alfresco.util.createYUIButton(this,"viewReportLocal",this.onViewReportLocal,{type:"link"});if(K.transferLocalReport===null){e.addClass(this.id+"-viewReportLocal","yui-button-disabled")}else{e.removeClass(this.id+"-viewReportLocal","yui-button-disabled")}this.widgets.viewReportRemote=Alfresco.util.createYUIButton(this,"viewReportRemote",this.onViewReportRemote,{type:"link"});if(K.transferRemoteReport===null){e.addClass(this.id+"-viewReportRemote","yui-button-disabled")}else{e.removeClass(this.id+"-viewReportRemote","yui-button-disabled")}}this.updateButtonStatus();this.updateSummaryPanel()},updateButtonStatus:function j(){if(this.selectedJob===null){this.widgets.runJob.set("disabled",true);this.widgets.cancelJob.set("disabled",true);this.widgets.editJob.set("disabled",true);this.widgets.deleteJob.set("disabled",true);return}var F=this.selectedJob.status,G=this.selectedJob.enabled;this.widgets.runJob.set("disabled",F===d||F===t||F===l||!G);this.widgets.cancelJob.set("disabled",F!==d||this.selectedJob.executionDetails===null);this.widgets.editJob.set("disabled",false);this.widgets.deleteJob.set("disabled",false)},updateSummaryPanel:function b(){var H=e.get(this.id+"-jobSummary"),I=this.jobList.length,L="";if(H===null){return}if(I===0){L='<div class="job-count">'+this._msg("label.no-jobs")+"</div>"}else{var F={},M,K,G,J;fnSumStatus=function(O,N){O[N]=(O.hasOwnProperty(N)?++O[N]:1)};L='<div class="job-count">'+this._msg("label.summary.job-count",I)+"</div>";for(K=0;K<I;K++){M=this.jobList[K];fnSumStatus(F,this.summaryStatusMap[M.status])}L+="<ul>";for(K=0;K<this.summaryStatusOrder.length;K++){G=this.summaryStatusOrder[K];if(F.hasOwnProperty(G)){J=G.toLowerCase();L+='<li class="'+w(J)+'">'+this._msg("label.summary."+J,F[G])+"</li>"}}}H.innerHTML=L},onSortByChanged:function C(F){this.widgets.sortBy.value=F.value;this.populateJobsList();this.services.preferences.set(m,this.widgets.sortBy.value)},onRunJob:function x(G,H){if(this.selectedJob===null){this.updateButtonStatus();return}Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI+"api/running-replication-actions?name="+encodeURIComponent(this.selectedJob.name),successCallback:{fn:function F(){this.onRefreshJob()},scope:this},failureMessage:this._msg("message.run.failure",this.selectedJob.name)})},onCancelJob:function r(G,I){if(this.selectedJob===null||this.selectedJob.executionDetails===null){this.updateButtonStatus();return}Alfresco.util.Ajax.jsonDelete({url:Alfresco.constants.PROXY_URI+encodeURI(this.selectedJob.executionDetails),successCallback:{fn:function F(){this.onRefreshJob()},scope:this},failureCallback:{fn:function H(J){var K=this._msg("message.unknown-error");if(J&&J.json&&J.json.message){K=J.json.message}Alfresco.util.PopupManager.displayPrompt({title:this._msg("message.cancel.failure",this.selectedJob.name),text:K});this.onRefreshJob()},scope:this}})},onEditJob:function c(G,H){if(this.selectedJob===null){this.updateButtonStatus();return}var F=Alfresco.util.uriTemplate("consolepage",{pageid:"replication-job"});F+="?jobName="+encodeURIComponent(this.selectedJob.name);window.location.href=F},onDeleteJob:function v(H,J){if(this.selectedJob===null){this.updateButtonStatus();return}var G=this;Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.delete.title"),text:this.msg("message.confirm.delete",this.selectedJob.name),buttons:[{text:this.msg("button.delete"),handler:function I(){this.destroy();G._onDeleteJobConfirm.call(G)}},{text:this.msg("button.cancel"),handler:function F(){this.destroy()},isDefault:true}]})},_onDeleteJobConfirm:function f(){if(this.selectedJob===null){return}Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.DELETE,url:Alfresco.constants.PROXY_URI+"api/replication-definition/"+encodeURIComponent(this.selectedJob.name),successCallback:{fn:function F(){this.selectedJob=null;this.renderJobDetail();this.populateJobsList()},scope:this},failureMessage:this._msg("message.delete.failure",this.selectedJob.name)})},onRefreshJob:function q(G,H){if(this.selectedJob===null){this.widgets.refreshJob.set("disabled",true);return}Alfresco.util.Anim.fadeOut(this.id+"-jobStatus",{adjustDisplay:false,callback:function F(){this.onJobSelected(this.selectedJob.name,true)},scope:this,period:0.2})},onViewReport:function p(F,G){if(this.selectedJob===null||this.selectedJob.transferLocalReport===null){this.updateButtonStatus();E.preventDefault(F)}},_msg:function u(F){return Alfresco.util.message.call(this,F,"Alfresco.ConsoleReplicationJobs",Array.prototype.slice.call(arguments).slice(1))}})})();