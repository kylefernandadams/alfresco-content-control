(function(){var c=YAHOO.util.Dom,F=YAHOO.util.Event,x=YAHOO.util.Element,q=YAHOO.util.KeyListener;var y=Alfresco.util.encodeHTML,r=Alfresco.util.parseURL;Alfresco.ConsoleChannels=function(G){this.name="Alfresco.ConsoleChannels";Alfresco.ConsoleChannels.superclass.constructor.call(this,G);Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["button","container","datasource","datatable","paginator","json","history"],this.onComponentsLoaded,this);var I=this;ListPanelHandler=function J(){ListPanelHandler.superclass.constructor.call(this,"list")};YAHOO.extend(ListPanelHandler,Alfresco.ConsolePanelHandler,{onLoad:function H(){}});new ListPanelHandler();return this};YAHOO.extend(Alfresco.ConsoleChannels,Alfresco.ConsoleTool,{setOptions:function u(G){this.options=YAHOO.lang.merge(this.options,G);return this},isWaiting:{state:false,callback:"",reauth:false,channelId:"",set:function s(I,H,G){this.state=true;this.callback=I;this.channelId=H;if(G){this.reauth=G}},reset:function h(){this.state=false;this.callback=this.channelId="";this.reauth=false}},authWindow:null,options:{iframeComms:false,acceptMessagesFrom:""},insituEditors:[],onReady:function t(){Alfresco.ConsoleChannels.superclass.onReady.call(this);this.widgets.newChannelButton=new YAHOO.widget.Button(this.id+"-new-button",{type:"menu",menu:this.id+"-newChannel-menu",lazyloadmenu:false});F.on(this.id+"-channelTypes","click",this.onCreateChannel,this,true);F.on(this.id+"-datatable","click",this.onChannelInteraction,this,true);this.widgets.channelDataTable=new Alfresco.util.DataTable({dataSource:{url:Alfresco.constants.PROXY_URI+"api/publishing/channels",doBeforeParseData:this.bind(function(K,H){var J=[],L=H.data.publishChannels,I=H.data.statusUpdateChannels;J=L.concat(I);return({data:J})})},dataTable:{container:this.id+"-datatable",columnDefinitions:[{key:"channel",sortable:false,formatter:this.bind(this.renderCellChannel)}],config:{MSG_EMPTY:this.msg("channelAdmin.noChannels")}}});var G=this.widgets.channelDataTable.widgets.dataTable;G.subscribe("cellClickEvent",this.onChannelInteraction,this,true);G.subscribe("renderEvent",this.onRenderEvent,this,true);this.widgets.iframe=c.get(this.id+"-iframe");if(typeof(window.postMessage)==="function"){this.options.iframeComms=true}},renderCellChannel:function D(H,G,I,J){H.innerHTML=this.renderChannel(G)},renderChannel:function n(Q){var M=Q.getData(),P=' rel="'+M.id+'"',G=y(this.msg("channelAdmin.editNode.tooltip",M.title)),R='<a href="#" class="channelAction delete" '+P+' title="'+this.msg("channelAdmin.delete.tooltip")+'">'+this.msg("channelAdmin.delete")+"</a>",L='<a href="#" class="channelAction permissions" '+P+' title="'+this.msg("channelAdmin.permissions.tooltip")+'">'+this.msg("channelAdmin.permissions")+"</a>",J='<a href="#" class="channelAction reauth" '+P+' title="'+this.msg("channelAdmin.reauth.tooltip")+'">'+this.msg("channelAdmin.reauth")+"</a>",I="authorised",N=this.msg("channelAdmin.authorised.tooltip"),H='<a href="#" class="channelAction editNode"'+P+' title="'+G+'"><img class="editNode" src="'+Alfresco.constants.PROXY_URI+M.channelType.icon+'/64" title="'+G+'"/></a> ',O=this.id+"-channelName-"+Q.getId(),K="";if(M.authorised!==true){I="notAuthorised";N=this.msg("channelAdmin.notAuthorised.tooltip")}K+='<div class="channel '+I+'" title="'+N+'" rel="'+M.id+'">'+H+'<div class="channelName" id="'+O+'">'+y(M.name)+'</div><span class="channelActions">'+L+J+R+"</span></div>";this.insituEditors.push({context:O,params:{type:"textBox",nodeRef:M.id,name:"prop_cm_name",value:M.name,validations:[{type:Alfresco.forms.validation.nodeName,when:"keyup",message:this.msg("validation-hint.nodeName")},{type:Alfresco.forms.validation.length,args:{min:1,max:255,crop:true},when:"keyup",message:this.msg("validation-hint.length.min.max",1,255)}],title:this.msg("channelAdmin.insitu-edit.tooltip"),errorMessage:this.msg("channelAdmin.insitu-edit.failure")},callback:{fn:this.onChannelRename,scope:this,obj:M}});return K},onCreateChannel:function E(M,J){var H=F.getTarget(M),I=c.getAttribute(H,"rel"),K=Alfresco.constants.PROXY_URI+"api/publishing/channels",G=this.newChannelName(YAHOO.lang.trim(H.innerHTML)),N="?channelType="+I+"&channelName="+G;Alfresco.util.Ajax.request({url:K+N,method:Alfresco.util.Ajax.POST,successCallback:{fn:this.onCreateChannelSuccess,scope:this},failureCallback:{fn:function L(O){Alfresco.util.PopupManager.displayMessage({text:this.msg("channelAdmin.createChannel.failure")})},scope:this}})},onCreateChannelSuccess:function e(G){this.authoriseChannel(G,false)},authoriseChannel:function o(L,P){var O=L.json.data.authoriseUrl,S=L.json.data.authCallbackUrl,J=L.json.data.channelId,G=L.json.data.authRedirectUrl,T=function K(Z,X){var Y=r(Z),W=r(X);return(Y.protocol===W.protocol&&Y.host===W.host)};P=P||false;if(T(G,window.location.href)){this.authWindow=window.open(O)}else{if(!this.options.iframeComms){var N=r(O);N.queryParams.state=S;O=N.getUrl();this.authWindow=window.open(O)}else{if(T(G,this.options.acceptMessagesFrom)){this.widgets.iframe.contentWindow.postMessage(O,"*");var R=this,V=function I(W){if(W.origin===R.options.acceptMessagesFrom){window.location.hash=W.data}};F.addListener(window,"message",V,false)}else{var Q;if(!T(G,window.location.href)){var U=r(window.location.href),M=r(window.location.href),H=r(G);M.protocol=H.protocol;M.host=H.host;Q=this.msg("channelAdmin.auth.failure.url",U.getDomain(),M.getDomain(),M.getUrl())}else{Q=this.msg("channelAdmin.auth.failure.browser")}Alfresco.util.PopupManager.displayPrompt({text:Q,noEscape:true});this.refresh()}}}this.isWaiting.set(S,J,P)},newChannelName:function l(I){var L=c.getElementsByClassName("channelName","div",this.id),H=this.msg("channelAdmin.new-channel",I),M=H,K=[],G=0;for(var J=0;J<L.length;J++){K.push(L[J].innerHTML.toLowerCase())}while(Alfresco.util.arrayContains(K,M.toLowerCase())){++G;M=H+" "+G}return M},onChannelInteraction:function z(H,G){if(YAHOO.util.Selector.test(F.getTarget(H.event),"a.delete")){this.onDeleteChannel(H.event,G)}else{if(YAHOO.util.Selector.test(F.getTarget(H.event),"a.reauth")){this.onReauthChannel(H.event,G)}else{if(YAHOO.util.Selector.test(F.getTarget(H.event),"a.permissions")){this.onPermissionsClick(H.event,G)}else{if(YAHOO.util.Selector.test(F.getTarget(H.event),".editNode")){this.onEditNode(H.event,G)}}}}},onRenderEvent:function m(K,I){var G;for(var J=0,H=this.insituEditors.length;J<H;J++){G=this.insituEditors[J];Alfresco.util.createInsituEditor(G.context,G.params,G.callback)}},onChannelRename:function d(H,G){this.refresh()},onDeleteChannel:function k(J,G){var I=this,H=c.getAttribute(F.getTarget(J),"rel");Alfresco.util.PopupManager.displayPrompt({title:I.msg("channelAdmin.delete.title"),text:I.msg("channelAdmin.delete.confirm"),buttons:[{text:I.msg("button.ok"),handler:function(){this.destroy();var K=Alfresco.constants.PROXY_URI+"api/publishing/channels/"+H.replace("://","/");Alfresco.util.Ajax.request({url:K,method:Alfresco.util.Ajax.DELETE,successCallback:{fn:I.onDeleteChannelSuccess,scope:I},failureCallback:{fn:function L(M){Alfresco.util.PopupManager.displayPrompt({text:I.msg("channelAdmin.delete.failure")})},scope:I}})}},{text:I.msg("button.cancel"),handler:function(){this.destroy()},isDefault:true}]})},onDeleteChannelSuccess:function a(G){Alfresco.util.PopupManager.displayMessage({text:this.msg("channelAdmin.delete.success")});this.refresh()},onReauthChannel:function j(J,H){var I=c.getAttribute(F.getTarget(J),"rel"),G=Alfresco.constants.PROXY_URI+"api/publishing/channels/"+I.replace("://","/")+"/reauthorise";Alfresco.util.Ajax.request({url:G,method:Alfresco.util.Ajax.POST,successCallback:{fn:this.onReauthSuccess,scope:this},failureCallback:{fn:function K(L){Alfresco.util.PopupManager.displayMessage({text:this.msg("channelAdmin.auth.failure")})},scope:this}})},onReauthSuccess:function f(G){this.authoriseChannel(G,true)},onPermissionsClick:function A(I,G){var H=c.getAttribute(F.getTarget(I),"rel");Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/manage-permissions/manage-permissions?nodeRef="+H+"&htmlid="+this.id,successCallback:{fn:this.onPermissionsTemplateLoaded,scope:this},failureMessage:Alfresco.util.message("channelAdmin.template.error",this.name),execScripts:true})},onPermissionsTemplateLoaded:function C(J){var G=c.get(this.id+"-managepermissions"),I=c.get(this.id+"-body"),M=Alfresco.util.ComponentManager.findFirst("Alfresco.component.ManagePermissions").options.nodeRef;var K;if(M.uri){K=Alfresco.constants.PROXY_URI+"slingshot/doclib/node/"+M.uri}else{var H=Alfresco.util.NodeRef(M);K=Alfresco.constants.PROXY_URI+"slingshot/doclib/node/"+H.storeType+"/"+H.storeId+"/"+H.id}G.innerHTML=J.serverResponse.responseText;c.addClass(I,"managePermissions");Alfresco.util.Ajax.jsonGet({url:K,successCallback:{fn:function L(O){if(O.json!==undefined){var N=O.json.item;YAHOO.Bubbling.fire("nodeDetailsAvailable",{nodeDetails:N,metadata:O.json.metadata})}},scope:this},failureMessage:"Failed to load data for permission details"});Alfresco.component.ManagePermissions.prototype._navigateForward=function(){c.removeClass(I,"managePermissions");G.innerHTML=""}},onStateChanged:function w(){var H=window.location.hash.substring(1),G=this.isWaiting.callback;if(H!==""&&this.isWaiting.state){if(H!=="complete"&&G!==""){this.onAuthCallback(H,G)}else{this.onAuthComplete()}}},onAuthCallback:function v(J,H){localUrl=Alfresco.constants.PROXY_URI+H.split(Alfresco.constants.PROXY_URI_RELATIVE)[1];var K=J.split("&");for(var I=0;I<K.length;I++){param=K[I].split("=");if(param[1]!=="undefined"){param[1]=encodeURIComponent(param[1])}K[I]=param.join("=")}J=K.join("&");Alfresco.util.Ajax.request({url:localUrl+"?"+J,successCallback:{fn:this.onAuthComplete,scope:this},failureCallback:{fn:function G(L){Alfresco.util.PopupManager.displayMessage({text:this.msg("channelAdmin.auth.failure")})},scope:this}})},onAuthComplete:function B(){if(!this.isWaiting.reauth){Alfresco.util.PopupManager.displayMessage({text:this.msg("channelAdmin.createChannel.success")})}this.isWaiting.reset();this.refresh()},onEditNode:function i(H,I){var N=c.getAttribute(F.getTarget(H),"rel")||c.getAttribute(c.getAncestorByTagName(F.getTarget(H),"a"),"rel");if(N){var K=this.id+"-editNode",M=new Alfresco.module.SimpleDialog(K),O=document.createElement("div");O.innerHTML="<h2>"+this.msg("channelAdmin.editNode.header")+"</h2>";c.addClass(O,"yui-g");var P=function L(Q,R){c.get(K+"-form-container_h").innerHTML=this.msg("channelAdmin.editNode.title");c.insertBefore(O,c.get(K+"-form-fields"))};M.setOptions({width:"33em",templateUrl:YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true",{itemKind:"node",itemId:N,mode:"edit",submitType:"json"}),actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:P,scope:this},onSuccess:{fn:function G(Q){this.onEditNodeFinished();Alfresco.util.PopupManager.displayMessage({text:this.msg("channelAdmin.editNode.success")})},scope:this},onFailure:{fn:function J(Q){if(Q){Alfresco.util.PopupManager.displayMessage({text:this.msg("channelAdmin.editNode.failure")})}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.failure")})}},scope:this}}).show()}H.preventDefault()},onEditNodeFinished:function g(){this.refresh()},refresh:function b(){var G=this.widgets.channelDataTable.widgets.dataTable;window.location.hash="";this.insituEditors=[];G.getDataSource().sendRequest("",{success:G.onDataReturnInitializeTable,scope:G})},_showPanel:function p(){this.widgets.escapeListener.enable();this.widgets.panel.show()}})})();