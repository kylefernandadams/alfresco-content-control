(function(){var b=YAHOO.util.Dom,r=YAHOO.util.Event;var j=Alfresco.util.encodeHTML;Alfresco.component.ReplicationJob=function(s){Alfresco.component.ReplicationJob.superclass.constructor.call(this,"Alfresco.component.ReplicationJob",s,["button","menu","container","json"]);return this};YAHOO.extend(Alfresco.component.ReplicationJob,Alfresco.component.Base,{form:null,controlsLoadedDeferred:null,payload:null,targetName:null,options:{jobName:"",payload:[],targetName:"",scheduleStart:""},isCreateMode:function c(){return(this.options.jobName=="")},onReady:function k(){var s=this;this.widgets.submitButton=Alfresco.util.createYUIButton(this,"form-submit",null,{type:"submit"});this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"form-cancel",this.onCancel);this.controlsLoadedDeferred=new Alfresco.util.Deferred(["onPayloadControl","onTransferTargetControl","onScheduleStartControl"],{fn:this.onFormControlsLoaded,scope:this});this.createPayloadControl(this.id+"-payloadContainer");this.createTransferTargetControl(this.id+"-transferTargetContainer");this.createScheduleStartControl(this.id+"-scheduleStartContainer");this.widgets.scheduleCheckbox=b.get(this.id+"-scheduleEnabled");this.widgets.scheduleContainer=b.get(this.id+"-scheduleContainer");r.addListener(this.widgets.scheduleCheckbox,"click",this.onScheduleChange,this,true);YAHOO.Bubbling.on("mandatoryControlValueUpdated",this.onDatePickerMandatoryControlValueUpdated,this);YAHOO.Bubbling.on("registerValidationHandler",this.onRegisterValidationHandler,this)},createPayloadControl:function n(u){this.widgets.payload=new Alfresco.module.ControlWrapper(Alfresco.util.generateDomId()).setOptions({name:"payload",type:"association",container:b.get(u),label:this.msg("label.source-items"),value:this.options.payload.join(","),controlParams:{displayMode:"list",multipleSelectMode:true},fnValueChanged:{fn:function t(v){this.payload=null;if(v.selectedItems.length>0){this.payload=v.selectedItems}},scope:this}});this.widgets.payload.render({fn:function s(){this.controlsLoadedDeferred.fulfil("onPayloadControl")},scope:this})},createTransferTargetControl:function g(u){this.widgets.transferTarget=new Alfresco.module.ControlWrapper(Alfresco.util.generateDomId()).setOptions({name:"targetName",type:"association",container:b.get(u),label:this.msg("label.transfer-to"),value:this.options.targetName,controlParams:{startLocation:"/app:company_home/app:dictionary/app:transfers/app:transfer_groups/cm:default",valueType:"xpath;/app:company_home/app:dictionary/app:transfers/app:transfer_groups//cm:%VALUE%"},field:{endpointType:"trx:transferTarget",endpointMany:false},fnValueChanged:{fn:function s(v){this.targetName=null;if(v.selectedItems.length===1){this.targetName=v.selectedItemsMetaData[v.selectedItems[0]].name}},scope:this}});this.widgets.transferTarget.render({fn:function t(){this.controlsLoadedDeferred.fulfil("onTransferTargetControl")},scope:this})},createScheduleStartControl:function f(t){this.widgets.scheduleStart=new Alfresco.module.ControlWrapper(Alfresco.util.generateDomId()).setOptions({name:"schedule.start.iso8601",type:"date",container:b.get(t),label:this.msg("label.start-date"),value:this.options.scheduleStart,controlParams:{showTime:"true"},field:{mandatory:true}});this.widgets.scheduleStart.render({fn:function s(){this.controlsLoadedDeferred.fulfil("onScheduleStartControl")},scope:this})},onFormControlsLoaded:function e(){var u=this;this.form=new Alfresco.forms.Form(this.id+"-form");this.form.addValidation(this.id+"-prop_name",Alfresco.forms.validation.mandatory,null,"blur");this.form.addValidation(this.id+"-prop_name",Alfresco.forms.validation.nodeName,null,"keyup");this.form.addValidation(this.id+"-prop_name",Alfresco.forms.validation.length,{max:100,crop:true},"keyup");this.form.addValidation(this.id+"-prop_description",Alfresco.forms.validation.length,{max:512,crop:true},"keyup");this.form.addValidation(this.id+"-prop_intervalCount",Alfresco.forms.validation.length,{max:4,crop:true},"keyup");this.form.addValidation(this.id+"-prop_intervalCount",function v(B,x,A,z,w,y){return !(u.isScheduleEnabled()&&isNaN(parseInt(B.value)))},null,"blur");this.form.addValidation(this.id+"-prop_intervalPeriod",function s(B,x,A,z,w,y){return !(u.isScheduleEnabled()&&B.options[B.selectedIndex].value=="-")},null,"change");this.form.addValidation(this.widgets.scheduleStart.id+"_schedule.start.iso8601",function t(B,x,A,z,w,y){return !(u.isScheduleEnabled()&&!Alfresco.forms.validation.mandatory(B,x,A,z,w,y))},null,"blur");this.form.setSubmitElements(this.widgets.submitButton);this.form.setAJAXSubmit(true,{successCallback:{fn:this.onSuccess,scope:this},failureCallback:{fn:this.onFailure,scope:this}});this.form.setSubmitAsJSON(true);this.form.setAjaxSubmitMethod(this.isCreateMode()?"POST":"PUT");this.form.doBeforeAjaxRequest={fn:this.doBeforeAjaxRequest,scope:this};this.form.init();this.onScheduleChange();b.get(this.id+"-prop_name").focus()},doBeforeAjaxRequest:function p(s){s.dataObj.payload=this.payload||[];delete s.dataObj.payload_added;delete s.dataObj.payload_removed;if(this.targetName!==null){s.dataObj.targetName=this.targetName}delete s.dataObj.targetName_added;delete s.dataObj.targetName_removed;s.dataObj.enabled=(s.dataObj.enabled=="true");if(!this.isScheduleEnabled()){s.dataObj.schedule=null}return true},isScheduleEnabled:function o(){return(this.widgets.scheduleCheckbox.checked)},onScheduleChange:function i(s){if(this.isScheduleEnabled()){b.removeClass(this.widgets.scheduleContainer,"hidden")}else{b.addClass(this.widgets.scheduleContainer,"hidden")}this.form.validate()},onDatePickerMandatoryControlValueUpdated:function d(t,s){this.form.validate()},onRegisterValidationHandler:function l(v,u){var t=u[1];if(t&&t.fieldId){var w=this;this.form.addValidation(t.fieldId,function s(C,y,B,A,x,z){return !(w.isScheduleEnabled()&&!Alfresco.forms.validation.validDateTime(C,y,B,A,x,z))},t.args,t.when,t.message)}},onCancel:function a(t,s){this._navigateForward()},onSuccess:function m(s){this._navigateForward(s.json.data.name)},onFailure:function q(s){Alfresco.util.PopupManager.displayPrompt({title:this.msg("header."+this.isCreateMode()?"create":"edit"),text:(s.json&&s.json.message?s.json.message:this.msg("message.unknown-error"))})},_navigateForward:function h(t){var s=Alfresco.util.uriTemplate("consoletoolpage",{pageid:"admin-console",toolid:"replication-jobs"});if(YAHOO.lang.isString(t)){s+="?jobName="+encodeURIComponent(t)}else{if(history.length>1){history.go(-1)}}window.location.href=s}})})();