(function(){var e=YAHOO.util.Dom;var x=Alfresco.util.encodeHTML,C=Alfresco.util.siteURL;Alfresco.component.ManagePermissions=function(G){Alfresco.component.ManagePermissions.superclass.constructor.call(this,"Alfresco.component.ManagePermissions",G,["button","menu","container","datasource","datatable","paginator","json"]);YAHOO.Bubbling.on("nodeDetailsAvailable",this.onNodeDetailsAvailable,this);YAHOO.Bubbling.on("itemSelected",this.onAuthoritySelected,this);this.deferredReady=new Alfresco.util.Deferred(["onPermissionsLoaded","onNodeDetailsAvailable"],{fn:this.onDeferredReady,scope:this});this.nodeData=null;this.settableRoles=null;this.settableRolesMenuData=null;this.permissions={isInherited:false,inherited:[],current:[]};this.showingAuthorityFinder=false;this.inheritanceWarning=false;return this};YAHOO.extend(Alfresco.component.ManagePermissions,Alfresco.component.Base,{deferredReady:null,nodeData:null,settableRoles:null,settableRolesMenuData:null,permissions:null,sitePermissions:{},showingAuthorityFinder:null,inheritanceWarning:null,options:{nonEditableRoles:["SiteManager"],unDeletableRoles:["_SiteManager$","_SiteCollaborator$","_SiteContributor$","_SiteConsumer$"],showGroups:true},onReady:function o(){this.widgets.inherited=Alfresco.util.createYUIButton(this,"inheritedButton",this.onInheritedButton);this.widgets.saveButton=Alfresco.util.createYUIButton(this,"okButton",this.onSaveButton);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancelButton",this.onCancelButton);this._setupDataSources();this._setupDataTables();Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/people-finder/authority-finder",dataObj:{htmlid:this.id+"-authorityFinder"},successCallback:{fn:this.onAuthorityFinderLoaded,scope:this},failureMessage:this.msg("message.authorityFinderFail"),execScripts:true});if(this.options.site){Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/sites/"+encodeURIComponent(this.options.site)+"/memberships/",successCallback:{fn:function(H){for(var G=0;G<H.json.length;G++){this.sitePermissions[H.json[G].authority.fullName]=H.json[G].role}},scope:this}})}e.setStyle(this.id+"-body","visibility","visible")},onInheritedButton:function w(I,K){var G=this;if(this.permissions.isInherited&&!this.inheritanceWarning){Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.inheritance.title"),text:this.msg("message.confirm.inheritance.description"),noEscape:true,buttons:[{text:this.msg("button.yes"),handler:function J(){this.destroy();G.inheritanceWarning=true;G.permissions.isInherited=!G.permissions.isInherited;G._updateInheritedUI()}},{text:this.msg("button.no"),handler:function H(){this.destroy()},isDefault:true}]})}else{this.permissions.isInherited=!this.permissions.isInherited;this._updateInheritedUI()}},_updateInheritedUI:function n(){var G=this.permissions.isInherited;e.removeClass(this.id+"-inheritedButtonContainer","inherited-"+(G?"off":"on"));e.addClass(this.id+"-inheritedButtonContainer","inherited-"+(G?"on":"off"));if(G){e.removeClass(this.id+"-inheritedContainer","hidden")}else{e.addClass(this.id+"-inheritedContainer","hidden")}},onAuthorityFinderLoaded:function v(H){var G=e.get(this.id+"-authorityFinder");if(G){G.innerHTML=H.serverResponse.responseText;this.widgets.authorityFinder=G;this.modules.authorityFinder=Alfresco.util.ComponentManager.get(this.id+"-authorityFinder");this.modules.authorityFinder.setOptions({dataWebScript:Alfresco.constants.URL_SERVICECONTEXT+"components/people-finder/authority-query",viewMode:Alfresco.AuthorityFinder.VIEW_MODE_COMPACT,siteId:this.options.site,singleSelectMode:true,minSearchTermLength:3,authorityType:(this.options.showGroups)?Alfresco.AuthorityFinder.AUTHORITY_TYPE_ALL:Alfresco.AuthorityFinder.AUTHORITY_TYPE_USERS});this.widgets.addUserGroup=Alfresco.util.createYUIButton(this,"addUserGroupButton",this.onAddUserGroupButton,{label:(this.options.showGroups)?this.msg("button.addUserGroup"):this.msg("button.addUser")});var I=e.getRegion(this.id+"-addUserGroupButton");e.setStyle(this.widgets.authorityFinder,"top",(I.bottom+4)+"px")}Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI+"slingshot/doclib/permissions/"+Alfresco.util.NodeRef(this.options.nodeRef).uri,successCallback:{fn:this.onPermissionsLoaded,scope:this},failureMessage:this.msg("message.permissionsGetFail")})},onNodeDetailsAvailable:function l(H,G){this.nodeData=G[1].nodeDetails;this.deferredReady.fulfil("onNodeDetailsAvailable")},onPermissionsLoaded:function a(G){var J=G.json;this.permissions={originalIsInherited:J.isInherited,isInherited:J.isInherited,canReadInherited:J.canReadInherited,inherited:J.inherited,original:Alfresco.util.deepCopy(J.direct),current:Alfresco.util.deepCopy(J.direct)};if(!this.permissions.canReadInherited){this.widgets.dtInherited.set("MSG_EMPTY",this.msg("message.empty.no-permission"))}this.inheritanceWarning=!J.isInherited;this.settableRoles=J.settable;this.settableRolesMenuData=[];for(var H=0,I=J.settable.length;H<I;H++){this.settableRoles[J.settable[H]]=true;this.settableRolesMenuData.push({text:J.settable[H],value:J.settable[H]})}this.deferredReady.fulfil("onPermissionsLoaded")},onDeferredReady:function d(){e.get(this.id+"-title").innerHTML=this.msg("title",this.nodeData.displayName);var H=this;var G=function I(L,K){var J=YAHOO.Bubbling.getOwnerByTagName(K[1].anchor,"div");if(J!==null){if(typeof H[J.className]=="function"){K[1].stop=true;var M=H.widgets.dtDirect.getRecord(K[1].target.offsetParent).getData();H[J.className].call(H,M,J)}}return true};YAHOO.Bubbling.addDefaultAction("action-link",G);this.render()},onAddUserGroupButton:function E(H,G){if(!this.showingAuthorityFinder){this.modules.authorityFinder.clearResults();e.addClass(this.widgets.authorityFinder,"active");e.addClass(this.id+"-inheritedContainer","table-mask");e.addClass(this.id+"-directContainer","table-mask");e.get(this.id+"-authorityFinder-search-text").focus();this.showingAuthorityFinder=true}else{e.removeClass(this.widgets.authorityFinder,"active");e.removeClass(this.id+"-inheritedContainer","table-mask");e.removeClass(this.id+"-directContainer","table-mask");this.showingAuthorityFinder=false}},onAuthoritySelected:function r(I,G){var H=this.sitePermissions[G[1].itemName];if(H==null){H=this.settableRoles[this.settableRoles.length-1]}this.permissions.current.push({authority:{name:G[1].itemName,displayName:G[1].displayName,iconUrl:G[1].iconUrl},role:H,created:true});this.widgets.addUserGroup.set("checked",false);e.removeClass(this.widgets.authorityFinder,"active");e.removeClass(this.id+"-inheritedContainer","table-mask");e.removeClass(this.id+"-directContainer","table-mask");this.showingAuthorityFinder=false;this.render()},fnRenderCellAuthorityIcon:function z(){var H=this;return function G(K,J,M,O){e.setStyle(K,"width",M.width+"px");e.setStyle(K.parentNode,"width",M.width+"px");var L=J.getData("authority"),N=L.name.indexOf("GROUP_")===0,I=Alfresco.constants.URL_RESCONTEXT+"components/images/"+(N?"group":"no-user-photo")+"-64.png";if(L.avatar&&L.avatar.length!==0){I=Alfresco.constants.PROXY_URI+L.avatar+"?c=queue&ph=true"}else{if(L.iconUrl){I=L.iconUrl}}K.innerHTML='<img class="icon32" src="'+I+'" alt="icon" />'}},fnRenderCellText:function g(){var G=this;return function H(J,I,K,L){e.setStyle(J,"width",K.width+"px");e.setStyle(J.parentNode,"width",K.width+"px");J.innerHTML=x(L)}},fnRenderPermissionCellText:function B(){var G=this;return function H(J,I,K,L){J.innerHTML=x(L)}},_i18nRole:function j(G){return this.msg("roles."+G.toLowerCase())},fnRenderCellRoleText:function c(J,I,K,L){var H=this;return function G(N,M,O,P){arguments[3]=H._i18nRole(arguments[3]);H.fnRenderCellText().apply(H,arguments)}},fnRenderCellRole:function u(){var G=this;return function H(R,S,O,I){e.setStyle(R,"width",O.width+"px");e.setStyle(R.parentNode,"width",O.width+"px");var L=S.getData("role"),P=S.getData("index"),Q="roles-"+S.getId(),N=[];if(!G._isRoleEditable(L)||!G.settableRoles.hasOwnProperty(L)){R.innerHTML="<span>"+x(G._i18nRole(S.getData("role")))+"</span>"}else{N=N.concat(G.settableRolesMenuData);for(var K=0,M=N.length;K<M;K++){N[K].text=G._i18nRole(N[K].value)}R.innerHTML='<span id="'+Q+'"></span>';var J=new YAHOO.widget.Button({container:Q,type:"menu",menu:N});J.getMenu().subscribe("click",function(U,T){return function V(Y,X){var W=T[1];if(W){Y.set("label",G._i18nRole(W.value));G.onRoleChanged.call(G,T[1],X)}}(J,P)});J.set("label",x(G._i18nRole(S.getData("role"))))}}},fnRenderCellActions:function m(){var G=this;return function H(K,J,L,N){var M=J.getData("role");e.setStyle(K,"width",L.width+"px");e.setStyle(K.parentNode,"width",L.width+"px");var I='<div id="'+G.id+"-actions-"+J.getId()+'" class="hidden action-set">';if(G._isRoleEditable(M)&&G._isGroupDeletable(J)){I+='<div class="onActionDelete"><a class="action-link" title="'+G.msg("button.delete")+'"><span>'+G.msg("button.delete")+"</span></a></div>"}I+="</div>";K.innerHTML=I}},render:function i(){this._updateInheritedUI();this.widgets.dsInherited.sendRequest(this.permissions.inherited,{success:this.widgets.dtInherited.onDataReturnInitializeTable,failure:this.widgets.dtInherited.onDataReturnInitializeTable,scope:this.widgets.dtInherited});this.widgets.dsDirect.sendRequest(this.permissions.current,{success:this.widgets.dtDirect.onDataReturnInitializeTable,failure:this.widgets.dtDirect.onDataReturnInitializeTable,scope:this.widgets.dtDirect})},generateData:function h(K){var L=[],J;for(var H=0,I=K.length;H<I;H++){J=K[H];if(!J.removed&&!(J.authority.name==="GROUP_EVERYONE"&&J.role==="ReadPermissions")){L.push({index:H,authority:J.authority,displayName:J.authority.displayName,isGroup:J.authority.name.indexOf("GROUP_")==0,role:J.role})}}function G(N,M){return(!N.isGroup&&M.isGroup)?1:(N.isGroup&&!M.isGroup)?-1:(N.displayName>M.displayName)?1:(N.displayName<M.displayName)?-1:0}return L.sort(G)},_setupDataSources:function p(){this.widgets.dsInherited=new YAHOO.util.DataSource(this.generateData,{responseType:YAHOO.util.DataSource.TYPE_JSFUNCTION,scope:this});this.widgets.dsDirect=new YAHOO.util.DataSource(this.generateData,{responseType:YAHOO.util.DataSource.TYPE_JSFUNCTION,scope:this})},_setupDataTables:function b(){var G=(this.options.showGroups)?this.msg("column.authority"):this.msg("column.user");var H=[{key:"icon",label:"",sortable:false,formatter:this.fnRenderCellAuthorityIcon(),width:32},{key:"displayName",label:G,sortable:false,formatter:this.fnRenderPermissionCellText()},{key:"role",label:this.msg("column.role"),sortable:false,formatter:this.fnRenderCellRoleText(),width:240}];this.widgets.dtInherited=new YAHOO.widget.DataTable(this.id+"-inheritedPermissions",H,this.widgets.dsInherited,{initialLoad:false,MSG_EMPTY:this.msg("message.empty"),MSG_LOADING:this.msg("message.loading")});H=[{key:"icon",label:"",sortable:false,formatter:this.fnRenderCellAuthorityIcon(),width:32},{key:"displayName",label:G,sortable:false,formatter:this.fnRenderPermissionCellText()},{key:"role",label:this.msg("column.role"),sortable:false,formatter:this.fnRenderCellRole(),width:240},{key:"actions",label:this.msg("column.actions"),sortable:false,formatter:this.fnRenderCellActions(),width:120}];this.widgets.dtDirect=new YAHOO.widget.DataTable(this.id+"-directPermissions",H,this.widgets.dsDirect,{initialLoad:false,MSG_EMPTY:this.msg("message.empty"),MSG_LOADING:this.msg("message.loading")});this.widgets.dtDirect.subscribe("rowMouseoverEvent",this.onEventHighlightRow,this,true);this.widgets.dtDirect.subscribe("rowMouseoutEvent",this.onEventUnhighlightRow,this,true)},_isRoleEditable:function k(G){return this.permissions.isInherited||!Alfresco.util.arrayContains(this.options.nonEditableRoles,G)},_isGroupDeletable:function F(H){if(this.permissions.isInherited){return true}var I=H.getData("authority").name;if(H.getData("isGroup")==true){for(var G=0;G<this.options.unDeletableRoles.length;G++){if(I.search(this.options.unDeletableRoles[G])!==-1){return false}}}return true},onEventHighlightRow:function t(G){this.widgets.dtDirect.onEventHighlightRow.call(this.widgets.dtDirect,G);e.removeClass(this.id+"-actions-"+G.target.id,"hidden")},onEventUnhighlightRow:function A(G){this.widgets.dtDirect.onEventUnhighlightRow.call(this.widgets.dtDirect,G);e.addClass(this.id+"-actions-"+G.target.id,"hidden")},onRoleChanged:function q(J,I){var H=this.permissions.current[I],G=this.permissions.original;H.role=J.value;H.modified=(I<=G.length&&G[I]!=null&&H.role!==G[I].role)},onActionDelete:function y(H){var G=this.permissions.current[H.index];G.removed=true;this.render()},onSaveButton:function f(L,G){this.widgets.saveButton.set("disabled",true);var K=[],J;for(var H=0,I=this.permissions.current.length;H<I;H++){J=this.permissions.current[H];if((J.created&&!J.removed)||(!J.created&&(J.removed||J.modified))){K.push({authority:J.authority.name,role:J.role,remove:J.removed});if(J.modified&&!J.created){K.push({authority:J.authority.name,role:this.permissions.original[H].role,remove:true})}}}if(K.length>0||this.permissions.isInherited!==this.permissions.originalIsInherited){Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI+"slingshot/doclib/permissions/"+Alfresco.util.NodeRef(this.options.nodeRef).uri,dataObj:{permissions:K,isInherited:this.permissions.isInherited},successCallback:{fn:function(M){this._navigateForward()},scope:this},failureCallback:{fn:function(M){var N=Alfresco.util.parseJSON(M.serverResponse.responseText);Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.failure"),text:this.msg("message.permissionsSaveFail",N.message)});this.widgets.saveButton.set("disabled",false)},scope:this}})}else{this._navigateForward()}},onCancelButton:function s(H,G){this.widgets.cancelButton.set("disabled",true);this._navigateForward()},_navigateForward:function D(){window.history.go(-1)}})})();