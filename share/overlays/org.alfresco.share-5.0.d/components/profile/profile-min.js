(function(){var f=YAHOO.util.Dom,k=YAHOO.util.Event,c=YAHOO.util.Element;Alfresco.UserProfile=function(m){Alfresco.UserProfile.superclass.constructor.call(this,"Alfresco.UserProfile",m,["button"]);return this};YAHOO.extend(Alfresco.UserProfile,Alfresco.component.Base,{options:{userId:"",profile:{}},fileUpload:null,onReady:function a(){if(this.options.profile.isEditable){this.widgets.upload=Alfresco.util.createYUIButton(this,"button-upload",this.onUpload);this.widgets.clearphoto=Alfresco.util.createYUIButton(this,"button-clearphoto",this.onClearPhoto);this.widgets.edit=Alfresco.util.createYUIButton(this,"button-edit",this.onEditProfile);this.widgets.save=Alfresco.util.createYUIButton(this,"button-save",null,{type:"submit"});this.widgets.cancel=Alfresco.util.createYUIButton(this,"button-cancel",this.onCancel);var m=new Alfresco.forms.Form(this.id+"-form");this.widgets.form=m;m.setSubmitElements(this.widgets.save);m.setSubmitAsJSON(true);m.setAJAXSubmit(true,{successCallback:{fn:this.onSuccess,scope:this}});m.addValidation(this.id+"-input-firstName",Alfresco.forms.validation.mandatory,null,"keyup");m.init()}if(this.options.profile.isEditable&&window.location.hash=="#edit"){this.onEditProfile()}else{f.removeClass(this.id+"-readview","hidden")}this.widgets.following=Alfresco.util.createYUIButton(this,"button-following",this.onFollowing)},onEditProfile:function l(o,q){f.addClass(this.id+"-readview","hidden");var n=this.options.profile,m=this.id+"-input-";f.get(m+"lastName").value=n.lastName;f.get(m+"firstName").value=n.firstName;f.get(m+"jobtitle").value=n.jobtitle;f.get(m+"location").value=n.location;f.get(m+"bio").value=n.bio;f.get(m+"telephone").value=n.telephone;f.get(m+"mobile").value=n.mobile;f.get(m+"email").value=n.email;f.get(m+"skype").value=n.skype;f.get(m+"instantmsg").value=n.instantmsg;f.get(m+"googleusername").value=n.googleusername;f.get(m+"organization").value=n.organization;f.get(m+"companyaddress1").value=n.companyaddress1;f.get(m+"companyaddress2").value=n.companyaddress2;f.get(m+"companyaddress3").value=n.companyaddress3;f.get(m+"companypostcode").value=n.companypostcode;f.get(m+"companytelephone").value=n.companytelephone;f.get(m+"companyfax").value=n.companyfax;f.get(m+"companyemail").value=n.companyemail;this.widgets.form.validate();f.removeClass(this.id+"-editview","hidden")},onUpload:function j(n,o){if(this.fileUpload===null){this.fileUpload=Alfresco.getFileUploadInstance()}var m={flashUploadURL:"slingshot/profile/uploadavatar",htmlUploadURL:"slingshot/profile/uploadavatar.html",username:this.options.userId,mode:this.fileUpload.MODE_SINGLE_UPLOAD,onFileUploadComplete:{fn:this.onFileUploadComplete,scope:this}};this.fileUpload.show(m);k.preventDefault(n)},onClearPhoto:function d(m,n){Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"slingshot/profile/resetavatar/"+encodeURIComponent(this.options.userId),method:Alfresco.util.Ajax.PUT,requestContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:function(o){var p=f.getElementsByClassName("photoimg","img");for(i in p){p[i].src=Alfresco.constants.URL_RESCONTEXT+"components/images/no-user-photo-64.png"}},scope:this}})},onFileUploadComplete:function e(m){var q=m.successful.length;if(q>0){var p=m.successful[0].nodeRef;var r=f.getElementsByClassName("photoimg","img");for(i in r){r[i].src=Alfresco.constants.PROXY_URI+"api/node/"+p.replace("://","/")+"/content/thumbnails/avatar?c=force"}var o={};o[this.id+"-photoref"]=p;var n={method:"POST",url:f.get(this.id+"-form").attributes.action.nodeValue,dataObj:o};Alfresco.util.Ajax.jsonRequest(n)}},onSuccess:function b(m){if(m){if(window.location.hash=="#edit"){window.location=window.location.href.replace(/#.*/,"")}else{location.reload(true)}}else{Alfresco.util.PopupManager.displayPrompt({text:Alfresco.util.message("message.failure",this.name)})}},onCancel:function h(m,n){f.addClass(this.id+"-editview","hidden");f.removeClass(this.id+"-readview","hidden")},onFollowing:function g(n,o){var m="/api/subscriptions/"+encodeURIComponent(Alfresco.constants.USERNAME)+"/"+(this.options.follows?"unfollow":"follow");Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI+m,dataObj:[this.options.profile.name],successCallback:{fn:function(){window.location.reload()},scope:this}})}})})();