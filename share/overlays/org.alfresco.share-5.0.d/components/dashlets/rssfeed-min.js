(function(){var g=YAHOO.util.Dom,c=YAHOO.util.Event;Alfresco.dashlet.RssFeed=function a(i){Alfresco.dashlet.RssFeed.superclass.constructor.call(this,"Alfresco.dashlet.RssFeed",i);this.configDialog=null;return this};YAHOO.extend(Alfresco.dashlet.RssFeed,Alfresco.component.Base,{options:{componentId:"",feedURL:"",limit:"all",target:"_self"},titleElement:null,feedElement:null,onReady:function f(){this.titleElement=g.get(this.id+this.options.titleElSuffix);this.feedElement=g.get(this.id+this.options.targetElSuffix);this._loadFeed()},_loadFeed:function b(){var k=this.options.feedURL;var l="http://";var j=this.options.feedURL.indexOf("://");if(j!=-1){l=this.options.feedURL.substring(0,j);k=this.options.feedURL.substring(j+3)}if(k.indexOf(location.host+"/")!=0){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_CONTEXT+"service/components/dashlets/async-rssfeed/protocol/"+l+"/limit/"+this.options.limit+"/target/"+this.options.target+"?feed-url="+encodeURIComponent(k)+"",method:Alfresco.util.Ajax.GET,requestContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:this.onLoadFeedSuccess,scope:this},failureCallback:{fn:this.onLoadFeedFailure,scope:this}})}else{var i=this.options.feedURL.replace("/feedservice/","/page/").replace("/proxy/alfresco-feed/","/proxy/alfresco/");if(i.indexOf("?")>0){i+="&loopback=1"}else{i+="?loopback=1"}Alfresco.util.Ajax.request({url:i,method:Alfresco.util.Ajax.GET,successCallback:{fn:function(m){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_CONTEXT+"service/components/dashlets/async-rssfeed/protocol/"+l+"/limit/"+this.options.limit+"/target/"+this.options.target+"?feed-url="+encodeURIComponent(k)+"",method:Alfresco.util.Ajax.POST,dataStr:m.serverResponse.responseText,requestContentType:"text/xml",successCallback:{fn:this.onLoadFeedSuccess,scope:this},failureCallback:{fn:this.onLoadFeedFailure,scope:this}})},scope:this},failureCallback:{fn:this.onLoadFeedFailure,scope:this},noReloadOnAuthFailure:true})}},onLoadFeedSuccess:function e(i){var j=Alfresco.util.parseJSON(i.serverResponse.responseText);this.feedElement.innerHTML=j.html;this.titleElement.innerHTML=j.title},onLoadFeedFailure:function h(i){this.titleElement.innerHTML=this.msg("title.error.unavailable");this.feedElement.innerHTML=this.msg("label.noItems")},onConfigFeedClick:function d(m){c.stopEvent(m);var k=Alfresco.constants.URL_SERVICECONTEXT+"modules/feed/config/"+encodeURIComponent(this.options.componentId);if(!this.configDialog){this.configDialog=new Alfresco.module.SimpleDialog(this.id+"-configDialog").setOptions({width:"50em",templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/feed/config",onSuccess:{fn:function l(n){var o=n.json;this.options.feedURL=(o&&o.feedURL)?o.feedURL:this.options.feedURL;this.options.limit=o.limit;this.options.target=o.target;if(o.content){this.feedElement.innerHTML=o.content;this.titleElement.innerHTML=o.title}else{this._loadFeed()}},scope:this},doSetupFormsValidation:{fn:function i(t){t.addValidation(this.configDialog.id+"-url",Alfresco.forms.validation.mandatory,null,"keyup");t.addValidation(this.configDialog.id+"-url",Alfresco.forms.validation.url,null,"keyup");g.get(this.configDialog.id+"-url").value=this.options.feedURL;g.get(this.configDialog.id+"-new_window").checked=(this.options.target=="_blank");var n=g.get(this.configDialog.id+"-limit"),p=n.options,s,r,o;var q=g.get(this.configDialog.id+"-new_window");q.defaultChecked=q.checked;for(r=0,o=p.length;r<o;r++){s=p[r];if(s.value===this.options.limit){s.selected=true;break}}},scope:this}})}this.configDialog.onCancel=function j(){this.hide();var n=this.dialog.form.new_window;n.checked=n.defaultChecked};this.configDialog.setOptions({actionUrl:k}).show()}})})();