(function(){var d=YAHOO.util.Dom,g=Alfresco.util.fromISO8601,j=Alfresco.util.toISO8601,n=Alfresco.util.message,m=Alfresco.util.formatDate;var o=Alfresco.util.encodeHTML;var c=24*60*60*1000,i={SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6};Alfresco.dashlet.MiniCalendar=function f(u){return Alfresco.dashlet.MiniCalendar.superclass.constructor.call(this,"Alfresco.dashlet.MiniCalendar",u,["calendar"])};YAHOO.extend(Alfresco.dashlet.MiniCalendar,Alfresco.component.Base,{onReady:function e(){YAHOO.util.Connect.asyncRequest("GET",Alfresco.constants.PROXY_URI+"calendar/eventList?site="+this.options.siteId+"&from=now",{success:this.onSuccess,failure:this.onFailure,scope:this})},onSuccess:function s(A){var J='<div class="dashlet-padding"><h3>'+this.msg("label.no-items")+"</h3></div>",D="",z=false;try{var u=new Date();u.setHours(0,0,0,0);var v=YAHOO.lang.JSON.parse(A.responseText);v=this.getAllEvents(v);var x=[];for(var C=0;C<v.length;C++){var G=v[C];if(G.recurrenceRule!=null){var L=this.getNextEventStartDates(G,u);if(L.length>0){var w=j(L[0])}G.startAt.iso8601=G.endAt.iso8601=w;x.push(G)}else{if(g(G.startAt.iso8601)>=u||g(G.endAt.iso8601)>=u){x.push(G)}}}var I={};for(var B=0;B<x.length;B++){var y=x[B],H=j(g(y.startAt.iso8601)).split("T")[0],F=I[H]||[];F.push(y);I[H]=F}for(var K in I){D+=this.renderDay(K,I)}}catch(E){D="Could not load calendar data"}d.get(this.id+"-eventsContainer").innerHTML=x.length>0?D:J},renderDay:function k(x,E){var J=E[x];var A="",I;if(J&&J.length>0){var D=m(g(x),n("date-format.fullDate"));var u=Alfresco.constants.URL_PAGECONTEXT+"site/"+this.options.siteId+"/calendar?view=day&date="+x;A+='<div class="detail-list-item">';A+='<div class="icon"><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/calendar/images/calendar-16.png" alt="day" /></div>';A+='<div class="details2"><h4><a href="'+u+'" class="theme-color-1">'+D+"</a></h4>";for(var z=0,H=J.length;z<H;z++){I=J[z];var w=m(g(I.startAt.iso8601),n("date-format.shortTime")),B=m(g(I.endAt.iso8601),n("date-format.shortTime"));var K=o(I.name);if(I.startAt.iso8601===I.endAt.iso8601){A+='<div><span><a href="'+u+'">'+K+"</a></span></div>"}else{var G=w,F=B,v="";var C=m(g(I.startAt.iso8601),"dd-mm-yyyy"),y=m(g(I.endAt.iso8601),"dd-mm-yyyy");if(y!==C){if(m(g(I.startAt.iso8601),"HH:MM")==="00:00"&&m(g(I.endAt.iso8601),"HH:MM")==="00:00"){G=F=""}v=" ("+this.msg("label.until")+": "+m(g(I.endAt.iso8601),n("date-format.fullDate"))+" "+F+")"}else{G+=" - "+F}A+="<div><span>"+G+' <a href="'+u+'">'+K+"</a>"+v+"</span></div>"}}A+="</div></div>"}return A},getAllEvents:function(z){var u=[];for(var x in z){var w=z[x];if(w&&w.length>0){for(var v=0,y=w.length;v<y;v++){u.push(w[v])}}}return u},onFailure:function(u){d.get(this.id+"-eventsContainer").innerHTML="Failed to load calendar data."},_msg:function t(u){return Alfresco.util.message.call(this,u,"Alfresco.MiniCalendar",Array.prototype.slice.call(arguments).slice(1))},setMessages:function a(u){Alfresco.util.addMessages(u,this.name);return this},getNextEventStartDates:function l(v,w){var G=[],I=[],y=v.recurrenceRule,H=g(v.startAt.iso8601),A=y.split(";"),F={},D=new Date(),u=true;if(H>=w){w=H}for(var C=0;C<A.length;C++){var x=A[C].split("=");F[x[0]]=x[1]}D.setTime(w.getTime());while(u){if(F.FREQ=="WEEKLY"){D.setTime(D.getTime()+F.INTERVAL*c*7);G=this.resolveStartDateWeekly(v,F,w,D)}else{if(F.FREQ=="DAILY"){D.setTime(D.getTime()+F.INTERVAL*c);G=this.resolveStartDaily(v,F,w,D)}else{if(F.FREQ=="MONTHLY"){D.setMonth(D.getMonth()+F.INTERVAL*1);G=this.resolveStartMonthly(v,F,w,D)}}}if(G.length>0){for(var C=0;C<G.length-1;C++){for(var z=C+1;z<G.length;z++){if(G[C]>G[z]){var B=G[C];G[C]=G[z];G[z]=B}}}if(v.ignoreEvents.length>0){for(var C=0;C<G.length;C++){var E=false;for(var z=0;z<v.ignoreEvents.length;z++){if(Alfresco.util.formatDate(G[C],"m/d/yyyy")==v.ignoreEvents[z]){E=true;break}}if(!E){I.push(G[C]);break}}}else{I.push(G[0])}if(I.length==1){u=false}else{w=D}}else{u=false}}return I},resolveStartDateWeekly:function b(H,I,u,E){var J=[];var z=I.BYDAY.split(",");var v=I.INTERVAL;var x=this.getLastEventDay(H,u,E);if(x==-1){return J}var F=g(H.startAt.iso8601);if(F.getTime()<u.getTime()){var y=Math.floor((u.getTime()-F.getTime())/(v*7*c));var B=y*c;F.setTime(F.getTime()+B*v*7)}if(F.getTime()>E.getTime()){return J}var D=F.getDay();F.setTime(F.getTime()-D*c);var w=[];for(var C=0;C<z.length;C++){dayOfWeek=i[z[C]];w.push(dayOfWeek)}for(var C=0;C<w.length;C++){var G=new Date();G.setTime(F.getTime()+w[C]*c);while(G.getTime()-x.getTime()<c){if(G.getTime()>=u.getTime()&&G.getTime()>=g(H.startAt.iso8601).getTime()){var A=new Date();A.setTime(G.getTime());J.push(A)}G.setTime(G.getTime()+7*v*c)}}return J},resolveStartDaily:function h(D,E,u,A){var F=[];var v=E.INTERVAL;var w=this.getLastEventDay(D,u,A);if(w==-1){return F}var B=g(D.startAt.iso8601);if(B.getTime()<u.getTime()){var x=Math.floor((u.getTime()-B.getTime())/(v*c));var z=x*c;B.setTime(B.getTime()+z*v);if(B.getTime()<u.getTime()){B.setTime(B.getTime()+v*c)}}if(B.getTime()>A.getTime()){return F}var C=B;while(C.getTime()-w.getTime()<c){var y=new Date();y.setTime(C.getTime());F.push(y);C.setTime(C.getTime()+v*c)}return F},resolveStartMonthly:function q(E,F,u,A){var I=[];var v=F.INTERVAL;var B=g(E.startAt.iso8601);var x=this.getLastEventDay(E,u,A);if(x==-1){return I}var y=((u.getFullYear()*12+u.getMonth())-(B.getFullYear()*12+B.getMonth()))%v;if(y>0){var C=v-y;u.setMonth(u.getMonth()+C)}var H=u;H.setDate(B.getDate());if(F.BYDAY){var w=F.BYDAY.split(",");var G=new Object();for(var z=0;z<w.length;z++){G[i[w[z]]]=1}var D=F.BYSETPOS*1;u.setDate(1);while(D>0){if(G[u.getDay()]==1){D--}if(D>0){u.setDate(u.getDate()+1)}}if(D==-1){u.setMonth(u.getMonth()+1);u.setTime(u.getTime()-c);while(G[u.getDay()]==undefined){u.setTime(u.getTime()-c)}}H=u}if(H.getTime()-x.getTime()<c){if(u>H){H.setMonth(H.getMonth()+v)}I.push(H)}return I},getLastEventDay:function r(w,u,x){var v=new Date(x);if((w.recurrenceLastMeeting)){var y=this.cloneDate(w.recurrenceLastMeeting);if(y.getTime()<u.getTime()||g(w.startAt.iso8601).getTime()>x.getTime()){return -1}if((y.getTime()<x.getTime())){v=new Date(y)}}return v},cloneDate:function p(u){var v=u.split("/");return YAHOO.widget.DateMath.getDate(v[2],(v[0]-1),v[1])}})})();