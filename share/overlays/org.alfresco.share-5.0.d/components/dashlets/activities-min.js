(function(){var c=YAHOO.util.Dom,r=YAHOO.util.Event,n=YAHOO.util.Selector;var l="org.alfresco.share.activities",e=".filter",j=".range",h=".activities";Alfresco.dashlet.Activities=function d(s){Alfresco.dashlet.Activities.superclass.constructor.call(this,"Alfresco.dashlet.Activities",s,["button","container","calendar"]);this.services.preferences=new Alfresco.service.Preferences();return this};YAHOO.extend(Alfresco.dashlet.Activities,Alfresco.component.Base,{options:{mode:"site",siteId:"",activeFilter:"today",regionId:""},activityList:null,link:"",onReady:function g(){var v=this;this.widgets.range=Alfresco.util.createYUIButton(this,"range",this.onDateFilterChanged,{type:"menu",menu:"range-menu",lazyloadmenu:false});this.widgets.user=Alfresco.util.createYUIButton(this,"user",this.onExclusionFilterChanged,{type:"menu",menu:"user-menu",lazyloadmenu:false});this.widgets.activities=Alfresco.util.createYUIButton(this,"activities",this.onActivitiesFilterChanged,{type:"menu",menu:"activities-menu",lazyloadmenu:false});this.activityList=c.get(this.id+"-activityList");this.widgets.range.set("label",this.msg("filter.7days"));this.widgets.range.value="7";this.widgets.user.set("label",this.msg("filter.all"));this.widgets.user.value="all";this.widgets.activities.set("label",this.msg("filter.allItems")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.activities.value="";var t=this.services.preferences.get();var x=Alfresco.util.findValueByDotNotation(t,this.buildPreferences(h),"");if(x!==null){this.widgets.activities.value=x;var u=this.widgets.activities.getMenu().getItems();for(index in u){if(u.hasOwnProperty(index)){if(u[index].value===x){this.widgets.activities.set("label",u[index].cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);break}}}}var s=Alfresco.util.findValueByDotNotation(t,this.buildPreferences(j),"7");if(s!==null){this.widgets.range.value=s;var u=this.widgets.range.getMenu().getItems();for(index in u){if(u.hasOwnProperty(index)){if(u[index].value===s){this.widgets.range.set("label",u[index].cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);break}}}}var w=Alfresco.util.findValueByDotNotation(t,this.buildPreferences(e),"all");if(w!==null){this.widgets.user.value=w;var u=this.widgets.user.getMenu().getItems();for(index in u){if(u.hasOwnProperty(index)){if(u[index].value===w){this.widgets.user.set("label",u[index].cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);break}}}}c.removeClass(n.query(".toolbar div",this.id,true),"hidden");this.populateActivityList(this.widgets.range.value,this.widgets.user.value,this.widgets.activities.value)},buildPreferences:function b(t){var s=this.options;return l+"."+s.regionId+(s.siteId?("."+s.siteId):"")+(t?t:"")},populateActivityList:function m(u,t,s){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/dashlets/activities/list",dataObj:{site:this.options.siteId,mode:this.options.mode,dateFilter:u,userFilter:t,activityFilter:s},successCallback:{fn:this.onListLoaded,scope:this,obj:u},failureCallback:{fn:this.onListLoadFailed,scope:this},scope:this,noReloadOnAuthFailure:true})},onListLoaded:function p(u,w){this.options.activeFilter=w;var t=u.serverResponse.responseText;if(YAHOO.lang.trim(t).length===0){this.activityList.innerHTML=c.get(this.id+"-empty").innerHTML}else{this.activityList.innerHTML=t;c.getElementsByClassName("relativeTime","span",this.activityList,function(){this.innerHTML=Alfresco.util.relativeTime(this.innerHTML)});var s=this.msg("label.older-activities"),v="";c.getElementsByClassName("relativeDate","span",this.activityList,function(){c.addClass(this,"body");var y=Alfresco.util.relativeDate(this.innerHTML,{olderDates:s});if(y!==v){this.innerHTML=y;v=y}else{var x=this.parentNode;x.parentNode.removeChild(x)}})}this.updateFeedLink(this.widgets.range.value,this.widgets.user.value,this.widgets.activities.value)},onListLoadFailed:function a(){this.activityList.innerHTML='<div class="detail-list-item first-item last-item">'+this.msg("label.load-failed")+"</div>"},updateFeedLink:function k(w,v,t){var u=Alfresco.constants.URL_FEEDSERVICECONTEXT+"components/dashlets/activities/list?";var s={format:"atomfeed",mode:this.options.mode,site:this.options.siteId,dateFilter:w,userFilter:v,activityFilter:t};u+=Alfresco.util.Ajax.jsonToParamString(s,true);this.link=u},openFeedLink:function i(){window.open(this.link)},onDateFilterChanged:function f(t,s){var u=s[1];if(u){this.widgets.range.set("label",u.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.range.value=u.value;this.populateActivityList(this.widgets.range.value,this.widgets.user.value,this.widgets.activities.value);this.services.preferences.set(this.buildPreferences(j),this.widgets.range.value)}},onExclusionFilterChanged:function q(t,s){var u=s[1];if(u){this.widgets.user.set("label",u.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.user.value=u.value;this.populateActivityList(this.widgets.range.value,this.widgets.user.value,this.widgets.activities.value);this.services.preferences.set(this.buildPreferences(e),this.widgets.user.value)}},onActivitiesFilterChanged:function o(t,s){var u=s[1];if(u){this.widgets.activities.set("label",u.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.activities.value=u.value;this.populateActivityList(this.widgets.range.value,this.widgets.user.value,this.widgets.activities.value);this.services.preferences.set(this.buildPreferences(h),this.widgets.activities.value)}}})})();