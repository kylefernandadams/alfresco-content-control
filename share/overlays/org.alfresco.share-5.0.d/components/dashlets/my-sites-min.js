(function(){var b=YAHOO.util.Dom,z=YAHOO.util.Event,u=YAHOO.util.Selector;var p=Alfresco.util.encodeHTML,q=Alfresco.util.activateLinks;var n=Alfresco.util.generateDomId(null,"fav-site"),h=Alfresco.util.generateDomId(null,"imap-site"),e=Alfresco.util.generateDomId(null,"del-site");Alfresco.dashlet.MySites=function k(A){Alfresco.dashlet.MySites.superclass.constructor.call(this,"Alfresco.dashlet.MySites",A,["datasource","datatable","animation"]);this.sites=[];this.createSite=null;this.services.preferences=new Alfresco.service.Preferences();YAHOO.Bubbling.on("siteDeleted",this.onSiteDeleted,this);return this};YAHOO.extend(Alfresco.dashlet.MySites,Alfresco.component.Base,{PREFERENCES_SITES_DASHLET:"",PREFERENCES_SITES_DASHLET_FILTER:"",sites:null,createSite:null,favSites:null,imapfavSites:null,filter:null,options:{validFilters:{all:true,favSites:true,recentSites:true},imapEnabled:false,listSize:100},onReady:function f(){var D=this;this.PREFERENCES_SITES_DASHLET=this.services.preferences.getDashletId(this,"sites");this.PREFERENCES_SITES_DASHLET_FILTER=this.PREFERENCES_SITES_DASHLET+".filter";this.widgets.type=Alfresco.util.createYUIButton(this,"type",this.onTypeFilterChanged,{type:"menu",menu:"type-menu",lazyloadmenu:false});var A=b.get(this.id+"-createSite-button");if(A){z.addListener(A,"click",this.onCreateSite,this,true)}this.widgets.dataSource=new YAHOO.util.DataSource(this.sites,{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});var G=[{key:"icon",label:"Icon",sortable:false,formatter:this.bind(this.renderCellIcon),width:52},{key:"detail",label:"Description",sortable:false,formatter:this.bind(this.renderCellDetail)},{key:"actions",label:"Actions",sortable:false,formatter:this.bind(this.renderCellActions),width:24}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-sites",G,this.widgets.dataSource,{MSG_EMPTY:this.msg("message.datatable.loading")});this.widgets.dataTable.doBeforeLoadData=function E(H,I,J){if((I.results.length===0)||(I.results.length===1&&I.results[0].shortName==="swsdp")){I.results.unshift({isInfo:true,title:D.msg("empty.title"),description:D.msg("empty.description")+(I.results.length===1?"<p>"+D.msg("empty.description.sample-site")+"</p>":"")})}return true};this.widgets.dataTable._deleteTrEl=function F(K){var I=this,J=this.getTrEl(K);var H=new YAHOO.util.ColorAnim(J,{opacity:{to:0}},0.25);H.onComplete.subscribe(function(){YAHOO.widget.DataTable.prototype._deleteTrEl.call(I,K)});H.animate()};var C=function B(I,H){var J=function K(N,M){var L=YAHOO.Bubbling.getOwnerByTagName(M[1].anchor,"div");if(L!==null){H.call(D,M[1].target.offsetParent,L)}return true};YAHOO.Bubbling.addDefaultAction(I,J)};C(n,this.onFavouriteSite);C(h,this.onImapFavouriteSite);C(e,this.onDeleteSite);this.widgets.dataTable.subscribe("rowMouseoverEvent",this.widgets.dataTable.onEventHighlightRow);this.widgets.dataTable.subscribe("rowMouseoutEvent",this.widgets.dataTable.onEventUnhighlightRow);this.initPreferences();this.loadSites()},onTypeFilterChanged:function o(B,A){var C=A[1];if(C){this.widgets.type.set("label",C.cfg.getProperty("text")+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.type.value=C.value;this.services.preferences.set(this.PREFERENCES_SITES_DASHLET_FILTER,C.value,{successCallback:{fn:function(){this.filter=C.value;this.loadSites()},scope:this}})}},initPreferences:function l(){var C=this.services.preferences.get();var A=Alfresco.util.findValueByDotNotation(C,"org.alfresco.share.sites.favourites");if(A===null){A={}}this.favSites=A;var F=Alfresco.util.findValueByDotNotation(C,"org.alfresco.share.sites.imapFavourites");if(F===null){F={}}this.imapfavSites=F;var E=Alfresco.util.findValueByDotNotation(C,"org.alfresco.share.sites.recent");if(E===null){E={}}var B=[];for(key in E){B.push(E[key])}this.recentSites=E;this.recentSitesArray=B;var D=Alfresco.util.findValueByDotNotation(C,this.PREFERENCES_SITES_DASHLET_FILTER,"all");this.filter=this.options.validFilters.hasOwnProperty(D)?D:"all"},loadSites:function g(){var A;switch(this.filter){case"favSites":A="/favourites";break;case"recentSites":A="/recent";break;default:A=""}Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"api/people/"+encodeURIComponent(Alfresco.constants.USERNAME)+"/sites"+A+"?roles=user&size="+this.options.listSize,successCallback:{fn:this.onSitesLoaded,scope:this}})},onSitesLoaded:function t(G){var H=G.json,B,F,E,D,C,K=0;this.widgets.type.set("label",this.msg("filter."+this.filter)+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.type.value=this.filter;b.removeClass(u.query(".toolbar div",this.id,true),"hidden");for(F=0,E=H.length;F<E;F++){H[F].isSiteManager=H[F].siteRole==="SiteManager";H[F].isFavourite=!this.favSites[H[F].shortName]?false:this.favSites[H[F].shortName];H[F].isRecent=Alfresco.util.arrayContains(this.recentSitesArray,H[F].shortName);if(this.imapfavSites){H[F].isIMAPFavourite=!this.imapfavSites[H[F].shortName]?false:this.imapfavSites[H[F].shortName]}}this.sites=[];for(F=0,E=H.length;F<E;F++){var A=YAHOO.lang.merge({},H[F]);if(this.filterAccept(this.widgets.type.value,A)){this.sites[K]=A;K++}}this.sites.sort(function(M,L){var O=M.title?M.title.toLowerCase():M.shortName.toLowerCase(),N=L.title?L.title.toLowerCase():L.shortName.toLowerCase();return(O>N)?1:(O<N)?-1:0});var I=function J(L,M,N){M.results=this.sites;this.widgets.dataTable.set("MSG_EMPTY","");this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,L,M,N)};this.widgets.dataSource.sendRequest(this.sites,{success:I,scope:this})},filterAccept:function w(B,A){switch(B){case"all":return true;case"favSites":return(A.isFavourite||(this.options.imapEnabled&&A.isIMAPFavourite));case"recentSites":return(A.isRecent)}return false},generateFavourite:function d(A){var B="";if(A.getData("isFavourite")){B='<a class="favourite-action '+n+' enabled" title="'+this.msg("favourite.site.remove.tip")+'" tabindex="0"></a>'}else{B='<a class="favourite-action '+n+'" title="'+this.msg("favourite.site.add.tip")+'" tabindex="0">'+this.msg("favourite.site.add.label")+"</a>"}return B},generateIMAPFavourite:function c(A){var B="";if(A.getData("isIMAPFavourite")){B='<a class="favourite-action favourite-imap '+h+' enabled" title="'+this.msg("favourite.imap-site.remove.tip")+'" tabindex="0"></a>'}else{B='<a class="favourite-imap '+h+'" title="'+this.msg("favourite.imap-site.add.tip")+'" tabindex="0">'+this.msg("favourite.imap-site.add.label")+"</a>"}return B},renderCellIcon:function y(D,C,E,F){b.setStyle(D,"width",E.width+"px");b.setStyle(D.parentNode,"width",E.width+"px");var B=C.getData(),A=B.isInfo?"help-site-bw-32.png":"filetypes/generic-site-32.png";D.innerHTML='<img src="'+Alfresco.constants.URL_RESCONTEXT+"components/images/"+A+'" />'},renderCellDetail:function i(D,C,E,G){var A=C.getData(),B='<span class="faded">'+this.msg("details.description.none")+"</span>",F="";if(A.isInfo){F+='<div class="empty"><h3>'+A.title+"</h3>";F+="<span>"+A.description+"</span></div>"}else{if(A.description&&A.description!==""){B=q(p(A.description))}F+='<h3 class="site-title"><a href="'+Alfresco.constants.URL_PAGECONTEXT+"site/"+A.shortName+'/dashboard" class="theme-color-1">'+p(A.title)+"</a></h3>";F+='<div class="detail"><span>'+B+"</span></div>";F+='<div class="detail detail-social">';F+='<span class="item item-social">'+this.generateFavourite(C)+"</span>";if(this.options.imapEnabled){F+='<span class="item item-social item-separator">'+this.generateIMAPFavourite(C)+"</span>"}F+="</div>"}D.innerHTML=F},renderCellActions:function s(B,A,C,E){b.setStyle(B,"width",C.width+"px");b.setStyle(B.parentNode,"width",C.width+"px");var D="";if(A.getData("isSiteManager")){D+='<a class="delete-site '+e+'" title="'+this.msg("link.deleteSite")+'">&nbsp;</a>'}B.innerHTML=D},onDeleteSite:function v(B){var A=this.widgets.dataTable.getRecord(B);Alfresco.module.getDeleteSiteInstance().show({site:A.getData()})},onSiteDeleted:function a(D,C){var B=C[1].site,E=B.shortName;var A=this._findRecordByParameter(E,"shortName");if(A!==null){this.widgets.dataTable.deleteRow(A)}},onFavouriteSite:function r(H){var A=this.widgets.dataTable.getRecord(H),D=A.getData(),F=D.shortName;D.isFavourite=!D.isFavourite;this.widgets.dataTable.updateRow(A,D);var E=D.isFavourite?"favouriteSite":"unFavouriteSite";var C={failureCallback:{fn:function B(K,L){var I=L.record,J=I.getData();J.isFavourite=!J.isFavourite;this.widgets.dataTable.updateRow(I,J);Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.save.failure")})},scope:this,obj:{record:A}},successCallback:{fn:function G(K,L){var I=L.record,J=I.getData();YAHOO.Bubbling.fire(J.isFavourite?"favouriteSiteAdded":"favouriteSiteRemoved",J)},scope:this,obj:{record:A}}};this.services.preferences[E].call(this.services.preferences,F,C);this.favSites[F]=D.isFavourite},onImapFavouriteSite:function j(F){var A=this.widgets.dataTable.getRecord(F),D=A.getData(),E=D.shortName;D.isIMAPFavourite=!D.isIMAPFavourite;this.widgets.dataTable.updateRow(A,D);var C={failureCallback:{fn:function B(I,J){var G=J.record,H=G.getData();H.isIMAPFavourite=!H.isIMAPFavourite;this.widgets.dataTable.updateRow(G,H);Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.save.failure")})},scope:this,obj:{record:A}}};this.services.preferences.set(Alfresco.service.Preferences.IMAP_FAVOURITE_SITES+"."+E,D.isIMAPFavourite,C);this.imapfavSites[E]=D.isIMAPFavourite},onCreateSite:function x(A){Alfresco.module.getCreateSiteInstance().show();z.preventDefault(A)},_findRecordByParameter:function m(E,D){var C=this.widgets.dataTable.getRecordSet();for(var B=0,A=C.getLength();B<A;B++){if(C.getRecord(B).getData(D)===E){return C.getRecord(B)}}return null}})})();