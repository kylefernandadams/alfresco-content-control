(function(){var b=YAHOO.util.Dom,s=YAHOO.util.Event,i=YAHOO.util.Element;var k=Alfresco.util.encodeHTML,l=Alfresco.util.activateLinks;Alfresco.LinksView=function(t){Alfresco.LinksView.superclass.constructor.call(this,"Alfresco.LinksView",t,["json","connection","event","button","menu"]);this.tagId={id:0,tags:{}};YAHOO.Bubbling.on("tagSelected",this.onTagSelected,this);return this};YAHOO.extend(Alfresco.LinksView,Alfresco.component.Base,{options:{siteId:"",containerId:"links",linkId:""},linksData:null,tagId:null,busy:false,PROTOCOL_STR_DELIM:/((.*):\/\/(.*))/,PORT_STR_DELIM:/^((.*):(\d{1,})((\/.*){0,}))/,onReady:function q(){var u=this;var v=function t(y,x){var w=YAHOO.Bubbling.getOwnerByTagName(x[1].anchor,"div");if(w!==null){var z="";z=w.className;if(typeof u[z]=="function"){u[z].call(u,u.linksData.name);x[1].stop=true}}return true};YAHOO.Bubbling.addDefaultAction("link-action-link-div",v);Alfresco.util.tags.registerTagActionHandler(this);Alfresco.util.rollover.registerHandlerFunctions(this.id,this.onLinkElementMouseEntered,this.onLinkElementMouseExited,this);this._loadLinksData()},_loadLinksData:function e(){var t=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/links/link/site/{site}/{container}/{linkId}",{site:this.options.siteId,container:this.options.containerId,linkId:this.options.linkId});Alfresco.util.Ajax.request({url:t,successCallback:{fn:this.loadLinksDataSuccess,scope:this},failureMessage:this.msg("message.loadlinkdata.failure")})},loadLinksDataSuccess:function n(u){var w=u.json.item;this.linksData=w;var t=b.get(this.id+"-link-view-div");var v=this.renderLinks(w);t.innerHTML=v;Alfresco.util.rollover.registerListenersByClassName(this.id,"link","div");this.sendCommentedNodeEvent()},sendCommentedNodeEvent:function a(){var t={nodeRef:this.linksData.nodeRef,title:this.linksData.title,page:"links-view",pageParams:{linkId:this.linksData.name}};YAHOO.Bubbling.fire("setCommentedNode",t)},renderLinks:function h(B){var z=this;var u=z.generateLinksViewUrl(this.options.siteId,this.options.containerId,B.name);var w=Alfresco.util.people.generateUserLink(B.author);var y="";y+='<div id="'+this.id+'-linksview" class="node linksview theme-bg-2">';y+=Alfresco.util.links.generateLinksActions(this,B,"div");var A=function(x){if(z.PROTOCOL_STR_DELIM.test(x)){return false}if(z.PORT_STR_DELIM.test(x)){return true}if(x.indexOf(":")>-1){return false}return true};var v=(A(B.url)?"http://":"")+B.url.replace(/"/g,encodeURIComponent('"'));y+='<div class="nodeContent">';y+='<div class="nodeTitle"><a href="'+u+'">'+k(B.title)+"</a></div>";y+='<div class="nodeURL">';y+='<span class="nodeAttrLabel">'+this.msg("link.url")+": </span><a "+(B.internal?"":'target="_blank" class="external"')+' href="'+v+'">'+k(B.url)+"</a>";y+="</div>";y+='<div class="detail">';y+='<span class="nodeAttrLabel">'+this.msg("link.createdOn")+": </span>";y+='<span class="nodeAttrValue">'+Alfresco.util.formatDate(B.createdOn)+"</span>";y+='<span class="separator">&nbsp;</span>';y+='<span class="nodeAttrLabel">'+this.msg("link.createdBy")+": </span>";y+='<span class="nodeAttrValue">'+w+"</span>";y+="</div>";y+='<div class="detail">';y+='<span class="nodeAttrLabel">'+this.msg("label.description")+": </span>";y+='<span class="nodeAttrValue">'+l(k(B.description))+"</span>";y+="</div>";y+='<div class="nodeFooter">';y+='<span class="nodeAttrLabel tagLabel">'+this.msg("label.tags")+": </span>";if(B.tags.length>0){for(var t=0;t<B.tags.length;t++){if(t>0){y+=", "}y+=Alfresco.util.tags.generateTagLink(this,B.tags[t])}}else{y+='<span class="nodeAttrValue">'+this.msg("link.noTags")+"</span>"}y+="</div>";y+="</div>";return y},generateLinksViewUrl:function r(v,t,w){var u=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/links-view?linkId={linkId}",{site:v,linkId:w});return u},onTagSelected:function j(v,u){var w=u[1];if(w&&(w.tagName!==null)){var t=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/links?filterId={filterId}&filterOwner={filterOwner}&filterData={filterData}",{site:this.options.siteId,filterId:"tag",filterOwner:"Alfresco.TagFilter",filterData:w.tagName});window.location=t}},onDeleteLink:function d(v){var u=this;Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.delete.title"),text:this.msg("message.confirm.delete",k(this.linksData.title)),buttons:[{text:this.msg("button.delete"),handler:function t(){this.destroy();u._deleteLinkConfirm.call(u,u.linksData.name)}},{text:this.msg("button.cancel"),handler:function w(){this.destroy()},isDefault:true}]})},_deleteLinkConfirm:function o(w){if(!this._setBusy(this.msg("message.wait"))){return}var u=function v(x){this._releaseBusy();var y=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/links",{site:this.options.siteId});window.location=y};var t=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/links/delete/site/{site}/{container}",{site:this.options.siteId,container:this.options.containerId});Alfresco.util.Ajax.request({url:t,method:"POST",requestContentType:"application/json",responseContentType:"application/json",successMessage:this.msg("message.delete.success"),successCallback:{fn:u,scope:this},failureMessage:this.msg("message.delete.failure"),failureCallback:{fn:function(x){this._releaseBusy()},scope:this},dataObj:{items:[w]}})},onEditLink:function g(u){var t=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/links-linkedit?linkId={linkId}",{site:this.options.siteId,linkId:u});window.location=t},onLinkElementMouseEntered:function c(u,t){var v=this.linksData.permissions;if(!(v.edit||v["delete"])){return}var w=t[1].target;YAHOO.util.Dom.addClass(w,"over")},onLinkElementMouseExited:function m(u,t){var v=t[1].target;YAHOO.util.Dom.removeClass(v,"over")},_setBusy:function f(t){if(this.busy){return false}this.busy=true;this.widgets.busyMessage=Alfresco.util.PopupManager.displayMessage({text:t,spanClass:"wait",displayTime:0});return true},_releaseBusy:function p(){if(this.busy){this.widgets.busyMessage.destroy();this.busy=false;return true}else{return false}}})})();