(function(){var c=YAHOO.util.Dom;var A=Alfresco.util.encodeHTML,B=Alfresco.util.activateLinks;Alfresco.Links=function(J){Alfresco.Links.superclass.constructor.call(this,"Alfresco.Links",J,["button","container","datasource","datatable","paginator","json"]);this.currentFilter={};this.tagId={id:0,tags:{}};this.busy=false;this.DELETEDCLASS="delete-link";this.EDITEDCLASS="edit-link";this.PROTOCOL_STR_DELIM=/((.*):\/\/(.*))/;this.PORT_STR_DELIM=/^((.*):(\d{1,})((\/.*){0,}))/;YAHOO.Bubbling.on("changeFilter",this.onChangeFilter,this);YAHOO.Bubbling.on("linksListRefresh",this.onLinksListRefresh,this);YAHOO.Bubbling.on("deactivateAllControls",this.onDeactivateAllControls,this)};YAHOO.extend(Alfresco.Links,Alfresco.component.Base,{tagId:null,busy:null,recordOffset:0,totalRecords:0,options:{siteId:"",initialFilter:{},pageSize:10,simpleView:false,permissionDelete:true,permissionUpdate:true,maxContentLength:512,MIN_FILTER_PANEL_WIDTH:150,MAX_FILTER_PANEL_WIDTH:640-((YAHOO.env.ua.ie>0)&&(YAHOO.env.ua.ie<7)?160:0),usePagination:true,MAX_FILTER_PANEL_HEIGHT:200,containerId:""},onReady:function D(){this.activate()},createDataSource:function a(){var J=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/links/site/{site}/{container}",{site:this.options.siteId,container:this.options.containerId});this.widgets.dataSource=new YAHOO.util.DataSource(J,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"items",metaFields:{recordOffset:"startIndex",totalRecords:"total",metadata:"metadata",totalRecordsUpper:"totalRecordsUpper"}}});return this},updateToolbar:function t(J){if(J.create==="false"){this.widgets.newLinkBtn.set("disabled",true)}},createDataTable:function r(){var aa=this;var S=function O(ac,ab,ad,ae){ac.innerHTML='<input class="checkbox-column" type="checkbox" />';ac.firstChild.onclick=function(){var af=aa.getSelectedLinks();aa.addItemToSelectedMenu(af);aa.widgets.linksMenu.set("disabled",af.length===0)}};var X=function Q(an,ar,al,ae){var aj=ar.getData();var ac=aj.title,ad=aj.url,ao=aj.description,aq=aj.createdOn,ag=aj.author,ap=aj.tags,ai=aj.internal;var ab=aa.generateLinksViewUrl(aa.options.siteId,aa.options.containerId,aj.name);var ak="";if(ap.length>0){for(var ah=0;ah<ap.length;ah++){ak+=aa._generateTagLink(ap[ah]);if(ah!=(ap.length-1)){ak+=", &nbsp;"}}}else{ak=aa.msg("dialog.tags.none")}var af='<h3 class="link-title"><a href="'+ab+'" class="theme-color-1">'+A(ac)+"</a></h3>";var am=function(at){if(aa.PROTOCOL_STR_DELIM.test(at)){return false}if(aa.PORT_STR_DELIM.test(at)){return true}if(at.indexOf(":")>-1){return false}return true};af+='<div class="detail"><span class="item"><em style="padding-right: 2px; float: left">'+aa.msg("details.url")+':</em> <a style="float: left;" class="theme-color-1"'+(ai?"":' target="_blank" class="external"')+" href="+(am(ad)?"http://":"")+encodeURI(decodeURI(ad))+">"+A(ad).replace(/'/g,"")+"</a></span></div>";if(!aa.options.simpleView){af+='<div class="detail"><span class="item"><em>'+aa.msg("details.created.on")+":</em> "+Alfresco.util.formatDate(aq)+'</span><span class="item"><em>'+aa.msg("details.created.by")+":</em> "+Alfresco.util.people.generateUserLink(ag)+"</span></div>";af+='<div class="detail"><span class="item"><em>'+aa.msg("details.description")+":</em> "+B(A(ao))+"</span></div>";af+='<div class="detail"><span class="tag-item"><em>'+aa.msg("details.tags")+": </em>"+ak+"</span></div>"}an.innerHTML=af};var K=function U(ah,aj,ad,ab){var ag=aj.getData("title"),af=aj.getData("permissions");ah.style.visibility="hidden";ah.innerHTML="<div class='"+aa.EDITEDCLASS+"'><a><span class='theme-color-1'>"+aa.msg("links.edit")+"</a></span></div><div class='"+aa.DELETEDCLASS+"'><a><span class='theme-color-1'>"+aa.msg("links.delete")+"</a></span></div>";var ae=ah.childNodes[0],ai=ah.childNodes[1];if(af.edit){ae.onclick=function ac(){window.location=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/links-linkedit?linkId={linkId}",{site:aa.options.siteId,linkId:aj.getData("name")})};ae.onmouseover=function(){c.addClass(this,"over")};ae.onmouseout=function(){c.removeClass(this,"over")}}else{c.addClass(ae,"hidden")}if(af["delete"]){ai.onclick=function(){var ak=aa.msg("dialog.confirm.message.delete",ag);var al=function(){aa.deleteLinks([aj])};aa.showConfirmDialog(ak,al)};ai.onmouseover=function(){c.addClass(this,"over")};ai.onmouseout=function(){c.removeClass(this,"over")}}else{c.addClass(ai,"hidden")}c.setStyle(ah.parentNode,"border-left","3px solid #fff");if(aa.options.simpleView){c.addClass(ah.parentNode,"simple-view")}else{c.removeClass(ah.parentNode,"simple-view")}};var W=[{key:"selected",label:"Selected",sortable:false,formatter:S},{key:"title",label:"Title",sortable:false,formatter:X},{key:"description",label:"Description",formatter:K}];this.widgets.paginator=new YAHOO.widget.Paginator({containers:[this.id+"-paginator"],rowsPerPage:this.options.pageSize,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});var T=function L(ac,ab){aa.updateLinks({page:ac.page})};this.widgets.paginator.subscribe("changeRequest",T);this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-links",W,this.widgets.dataSource,{renderLoopSize:32,initialLoad:false,MSG_EMPTY:'<span class="datatable-msg-empty">'+this.msg("links.empty")+"</span>"});YAHOO.widget.DataTable.CLASS_SELECTED="links-selected-row";this.widgets.dataTable.doBeforeLoadData=function M(ac,ad,af){if(ad.error){try{var ab=YAHOO.lang.JSON.parse(ad.responseText);aa.widgets.dataTable.set("MSG_ERROR",ab.message)}catch(ae){}}else{if(ad.results&&!aa.options.usePagination){this.renderLoopSize=Alfresco.util.RENDERLOOPSIZE}}return true};this.widgets.dataTable.handleDataReturnPayload=function Z(ac,ab,ad){aa.recordOffset=ab.meta.recordOffset;aa.totalRecords=ab.meta.totalRecords;aa.totalRecordsUpper=ab.meta.totalRecordsUpper;ad=ad||{};ad.recordOffset=ab.meta.recordOffset;ad.totalRecords=ab.meta.totalRecords;return ad};this.widgets.dataTable.doBeforePaginatorChange=function P(ab){return false};this.widgets.dataTable.subscribe("renderEvent",function(){this.widgets.paginator.setState({recordOffset:this.recordOffset,totalRecords:this.totalRecords});if(this.totalRecordsUpper&&this.totalRecordsUpper==true){this.widgets.paginator.set("pageReportTemplate",this.msg("pagination.template.page-report.more"))}else{this.widgets.paginator.set("pageReportTemplate",this.msg("pagination.template.page-report"))}this.widgets.paginator.render()},this,true);this.widgets.dataTable.subscribe("tableMsgShowEvent",function(ab){this._elMsgTbody.parentNode.style.width=""});this.widgets.dataTable.set("selectionMode","single");var R=function J(ab){aa.widgets.dataTable.selectRow(ab.target);if(ab.target.cells&&ab.target.cells.length>1){ab.target.cells[2].childNodes[0].style.visibility="visible";ab.target.cells[2].childNodes[0].style.width="100px";ab.target.cells[2].style.borderLeft="1px solid #ccc"}};var V=function Y(ab){aa.widgets.dataTable.unselectRow(ab.target);if(ab.target.cells&&ab.target.cells.length>1){ab.target.cells[2].childNodes[0].style.visibility="hidden";ab.target.cells[2].style.borderLeft="1px solid #fff"}};this.widgets.dataTable.subscribe("rowMouseoverEvent",R);this.widgets.dataTable.subscribe("rowMouseoutEvent",V);var N=YAHOO.lang.merge({filterId:"all",filterOwner:"Alfresco.LinkFilter",filterData:null},this.options.initialFilter);YAHOO.Bubbling.fire("changeFilter",N)},generateLinksViewUrl:function z(L,J,M){var K=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/links-view?linkId={linkId}&listViewLinkBack=true",{site:L,container:J,linkId:M});return K},onChangeFilter:function H(K,J){var L=J[1];if((L!==null)&&(L.filterId!==null)){this.currentFilter={filterId:L.filterId,filterOwner:L.filterOwner,filterData:L.filterData};this.updateLinks({page:1});YAHOO.Bubbling.fire("filterChanged",this.currentFilter)}},onLinksListRefresh:function q(K,J){this.updateLinks()},updateLinks:function b(L){function J(M,O,P){this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,M,O,P);this.updateListTitle();this.widgets.linksMenu.set("disabled",this.getSelectedLinks().length===0);var N=O.meta.metadata.linkPermissions;this.options.permissionDelete=N["delete"];this.options.permissionUpdate=N.edit;this.updateToolbar(N)}function K(N,O){if(O.status==401){window.location.reload(true)}else{try{var M=YAHOO.lang.JSON.parse(O.responseText);this.widgets.dataTable.set("MSG_ERROR",M.message);this.widgets.dataTable.showTableMessage(M.message,YAHOO.widget.DataTable.CLASS_ERROR);if(O.status==404){YAHOO.Bubbling.fire("deactivateAllControls")}}catch(P){}}}this.widgets.dataSource.sendRequest(this._buildLinksParams(L||{}),{success:J,failure:K,scope:this})},updateListTitle:function n(){var L=c.get(this.id+"-listTitle");var N=this.msg("title.generic");var K=this.currentFilter.filterOwner;var J=this.currentFilter.filterId;var M=this.currentFilter.filterData;if(K=="Alfresco.LinkFilter"){switch(J){case"all":N=this.msg("title.all");break;case"user":N=this.msg("title.user");break;case"recent":N=this.msg("title.recent");break}}else{if(K=="Alfresco.TagFilter"){N=this.msg("title.bytag",A(M))}}L.innerHTML=N},onDeactivateAllControls:function p(L,K){var J,M=Alfresco.util.disableYUIButton;for(J in this.widgets){if(this.widgets.hasOwnProperty(J)){M(this.widgets[J])}}},activate:function x(){this.attachButtons();c.setStyle(this.id+"-links-header","visibility","visible");c.setStyle(this.id+"-body","visibility","visible");this.createDataSource();this.createDataTable()},onMenuItemClick:function k(N,M,L){var J=this;switch(M[1]._oAnchor.className.split(" ")[0]){case"delete-item":var K=function(){var O=J.getSelectedLinks();J.deleteLinks(O)};this.showConfirmDialog(this.msg("dialog.confirm.message.delete.selected"),K);break;case"deselect-item":this.deselectAll();this.widgets.linksMenu.set("disabled",true);break}},deselectAll:function d(){var K=this.widgets.dataTable.getTbodyEl().rows;for(var J=0;J<K.length;J++){K[J].cells[0].getElementsByTagName("input")[0].checked=false}this.addItemToSelectedMenu(this.getSelectedLinks())},attachButtons:function i(){this.widgets.newLinkBtn=Alfresco.util.createYUIButton(this,"create-link-button",this.showCreateLinkDlg,{disabled:false,value:"create"});this.widgets.linksMenu=Alfresco.util.createYUIButton(this,"selected-i-dd",this.onMenuItemClick,{disabled:true,type:"menu",menu:"selectedItems-menu"});this.widgets.changeListViewBtn=Alfresco.util.createYUIButton(this,"viewMode-button",this.changeListView,{});this.linksSelectMenu=Alfresco.util.createYUIButton(this,"select-button",this.onSelectItemClick,{type:"menu",menu:"selecItems-menu"});this.widgets.rssFeed=Alfresco.util.createYUIButton(this,"rss-feed",null,{type:"link"});if(this.widgets.rssFeed!==null){this.widgets.rssFeed.set("href",this._generateRSSFeedUrl())}},onSelectItemClick:function I(M,L,K){var J=YAHOO.env.ua.ie?L[0].srcElement:L[0].target;if(J.tagName.toLocaleLowerCase()!="span"){J=J.getElementsByTagName("span")[0]}switch(J.className.split(" ")[0]){case"links-action-deselect-all":this.deselectAll();this.widgets.linksMenu.set("disabled",true);break;case"links-action-select-all":this.selectAll();this.widgets.linksMenu.set("disabled",!this.getSelectedLinks().length);break;case"links-action-invert-selection":this.invertAll();break}},invertAll:function f(){var M=false;var L=this.widgets.dataTable.getTbodyEl().rows;for(var J=0;J<L.length;J++){var K=L[J].cells[0].getElementsByTagName("input")[0];K.checked=!K.checked;M=K.checked?true:M}this.addItemToSelectedMenu(this.getSelectedLinks());this.widgets.linksMenu.set("disabled",!M)},selectAll:function m(){var K=this.widgets.dataTable.getTbodyEl().rows;for(var J=0;J<K.length;J++){K[J].cells[0].getElementsByTagName("input")[0].checked=true}this.addItemToSelectedMenu(this.getSelectedLinks())},showCreateLinkDlg:function w(){var J=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/links-linkedit",{site:this.options.siteId});window.location=J},changeListView:function o(){var J=this.widgets.dataTable.getRecordSet().getRecords();var M=this.widgets.dataTable.getTbodyEl().rows;var N=this.widgets.dataTable.getColumnSet().getDefinitions();this.options.simpleView=!this.options.simpleView;var K=0;for(var L in J){if(L){N[1].formatter.call(this,M[K].cells[1].firstChild,J[L]);N[2].formatter.call(this,M[K].cells[2].firstChild,J[L]);K++}}this.widgets.changeListViewBtn.set("label",this.msg(this.options.simpleView?"header.detailedList":"header.simpleList"))},deleteLinks:function E(J){if(!this._setBusy(this.msg("message.wait"))){return}var N=[];for(var L in J){if(L){N.push(J[L].getData().name)}}var K=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/links/delete/site/{site}/{container}",{site:this.options.siteId,container:this.options.containerId});var M=function O(P){this._releaseBusy();this.updateLinks();YAHOO.Bubbling.fire("tagRefresh")};Alfresco.util.Ajax.request({url:K,method:"POST",requestContentType:"application/json",successMessage:this.msg("message.delete.success"),successCallback:{fn:M,scope:this},failureMessage:this.msg("message.delete.failure"),failureCallback:{fn:function(P){P.config.failureMessage=YAHOO.lang.JSON.parse(P.serverResponse.responseText).message;this._releaseBusy()},scope:this},dataObj:{items:N}})},createLink:function y(J){this.updateLinks({page:1})},onUpdateLink:function l(J,K){this.updateLinks()},showConfirmDialog:function C(J,K){Alfresco.util.PopupManager.displayPrompt({text:J,title:this.msg("actions.link.delete"),buttons:[{text:this.msg("button.delete"),handler:function(){K();this.destroy()}},{text:this.msg("button.cancel"),handler:function(){this.destroy()},isDefault:true}]})},addItemToSelectedMenu:function v(J){var Q=this.widgets.linksMenu.getMenu();if(Q.element.hasChildNodes()){if(this.checkPermissionSelectedLinks(J)){if(c.getElementsByClassName("delete-item","a")[0]==null){if(Q.getItems().length==0){var O=document.createElement("li");O.innerHTML="<a class='delete-item' rel='' href='#'><span class='links-action-delete'>"+this.msg("links.delete")+"</span></a>";var P=Q.element.getElementsByTagName("ul")[0];var K=c.getLastChild(P);if(K==null){P.appendChild(O)}else{c.insertBefore(O,K)}}else{Q.getItem(0,0).index=1;var L=Q.insertItem("<span class='links-action-delete'>"+this.msg("links.delete")+"</span>",0,0);var N=c.getFirstChild(L.element);var M=N.className;N.className="delete-item "+M}}}else{if(c.getElementsByClassName("delete-item","a")[0]!=null){Q.removeItem(Q.getItem(0,0),0)}}}},checkPermissionSelectedLinks:function h(K){var J=false;for(var L=0;L<K.length;L++){J=K[L]._oData.permissions["delete"];if(!J){break}}return J},getSelectedLinks:function u(){var J=[];var M=this.widgets.dataTable.getTbodyEl().rows;for(var K=0;K<M.length;K++){if(M[K].cells[0].getElementsByTagName("input")[0].checked){var L=this.widgets.dataTable.getRecord(K);if(L){J.push(L)}}}return J},_generateTagId:function G(J){var L=0;var K=this.tagId;if(J in K.tags){L=K.tags[J]}else{K.id++;L=K.tags[J]=K.id}return this.id+"-tagId-"+L},_buildLinksParams:function g(P){var K={contentLength:this.options.maxContentLength,fromDate:null,toDate:null,tag:null,page:this.widgets.paginator.getCurrentPage()||"1",pageSize:this.widgets.paginator.getRowsPerPage()};if(typeof P=="object"){K=YAHOO.lang.merge(K,P)}K.startIndex=(K.page-1)*K.pageSize;var R=this.currentFilter.filterOwner;var L=this.currentFilter.filterId;var O=this.currentFilter.filterData;var J="";var N=true;if(R=="Alfresco.LinkFilter"){J="?filter="+L;N=false}else{if(R=="Alfresco.TagFilter"){J="?filter=tag";K.tag=O;N=false}}var Q="";for(var M in K){if(K[M]!==null){Q+="&"+M+"="+encodeURIComponent(K[M])}}if(Q.length>0){Q=Q.substring(1)}return J+(N?"?":"&")+Q},_releaseBusy:function F(){if(this.busy){if(this.widgets.busyMessage.destroyWithAnimationsStop!=undefined){this.widgets.busyMessage.destroyWithAnimationsStop()}else{this.widgets.busyMessage.destroy()}this.busy=false;return true}else{return false}},_setBusy:function s(J){if(this.busy){return false}this.busy=true;this.widgets.busyMessage=Alfresco.util.PopupManager.displayMessage({text:J,spanClass:"wait",displayTime:0});return true},_generateTagLink:function e(J){var K=A(J);return'<span class="tag"><a href="#" class="tag-link" rel="'+K+'" title="'+K+'">'+K+"</a></span>"},_generateRSSFeedUrl:function j(){var J=YAHOO.lang.substitute(Alfresco.constants.URL_FEEDSERVICECONTEXT+"components/links/rss?site={site}",{site:this.options.siteId});return J}})})();