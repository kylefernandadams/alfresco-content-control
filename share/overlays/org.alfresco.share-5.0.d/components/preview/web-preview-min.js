(function(){var Dom=YAHOO.util.Dom,Event=YAHOO.util.Event,Selector=YAHOO.util.Selector,Element=YAHOO.util.Element,KeyListener=YAHOO.util.KeyListener;var $html=Alfresco.util.encodeHTML;Alfresco.WebPreview=function(containerId){Alfresco.WebPreview.superclass.constructor.call(this,"Alfresco.WebPreview",containerId,["button","container","uploader"]);this.plugin=null;YAHOO.Bubbling.on("previewChangedEvent",this.onPreviewChanged,this);return this};YAHOO.extend(Alfresco.WebPreview,Alfresco.component.Base,{options:{thumbnailModification:[],siteId:"",nodeRef:"",size:"0",name:"",mimeType:"",thumbnails:[],pluginConditions:[],api:"api",proxy:"alfresco",avoidCachedThumbnail:false},Plugins:{},plugin:null,onComponentsLoaded:function WP_onComponentsLoaded(){YAHOO.deconcept.SWFObject.prototype.getVariablePairs=function(){var variablePairs=[],key,variables=this.getVariables();for(key in variables){if(variables.hasOwnProperty(key)){variablePairs[variablePairs.length]=key+"="+encodeURIComponent(variables[key])}}return variablePairs};Event.onContentReady(this.id,this.onReady,this,true)},onReady:function WP_onReady(){this.options.pluginConditions=eval(this.options.pluginConditions);this.setupPreview(false);YAHOO.Bubbling.on("previewChangedEvent",this.doRefresh,this);if(this.options.siteId){Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI+"slingshot/doclib/activity",dataObj:{site:this.options.siteId,fileName:this.options.name,nodeRef:this.options.nodeRef,type:"file-previewed",page:"document-details"},failureCallback:{fn:function(){}}})}},setupPreview:function WP_setupPreview(){this.widgets.previewerElement=Dom.get(this.id+"-previewer-div");Selector.query(".message",this.widgets.previewerElement,true).innerHTML=this.msg("label.preparingPreviewer");if(this.options.nodeRef===undefined){throw new Error("A nodeRef must be provided")}if(this.options.size=="0"){this.widgets.previewerElement.innerHTML='<div class="message">'+this.msg("label.noContent")+"</div>"}else{var condition,pluginDescriptor,plugin,messages=[];for(var i=0,il=this.options.pluginConditions.length;i<il;i++){condition=this.options.pluginConditions[i];if(!this.conditionsMatch(condition)){continue}for(var pi=0,pil=condition.plugins.length;pi<pil;pi++){pluginDescriptor=condition.plugins[pi];if(typeof Alfresco.WebPreview.prototype.Plugins[pluginDescriptor.name]=="function"){plugin=new Alfresco.WebPreview.prototype.Plugins[pluginDescriptor.name](this,pluginDescriptor.attributes);if(YAHOO.env.ua.ios&&pluginDescriptor.name==="WebPreviewer"){continue}var report=plugin.report();if(report){messages.push(report)}else{this.plugin=plugin;var markup;try{Dom.addClass(this.widgets.previewerElement,pluginDescriptor.name);markup=plugin.display();if(markup){this.widgets.previewerElement.innerHTML=markup}YAHOO.Bubbling.fire("webPreviewSetupComplete");return}catch(e){Alfresco.logger.error("Error, Alfresco.WebPreview.Plugins."+pluginDescriptor.name+" failed to display: "+e);messages.push(this.msg("label.error",pluginDescriptor.name,e.message))}}}else{Alfresco.logger.error("Error, Alfresco.WebPreview.Plugins."+pluginDescriptor.name+" does not exist");messages.push(this.msg("label.errorMissing",pluginDescriptor.name))}}}var noPreviewLabel="label.noPreview";if(YAHOO.env.ua.ios){noPreviewLabel="label.noPreview.ios"}var message=this.msg(noPreviewLabel,this.getContentUrl(true));for(i=0,il=messages.length;i<il;i++){message+="<br/>"+messages[i]}this.widgets.previewerElement.innerHTML='<div class="message">'+message+"</div>"}},onPreviewChanged:function WebPreview_onPreviewChanged(event){this.options.avoidCachedThumbnail=true;YAHOO.util.Event.preventDefault(event);YAHOO.util.Event.stopPropagation(event)},conditionsMatch:function WP_conditionsMatch(condition){if(condition.attributes.mimeType&&condition.attributes.mimeType!=this.options.mimeType){return false}if(condition.attributes.thumbnail&&!Alfresco.util.arrayContains(this.options.thumbnails,condition.attributes.thumbnail)){return false}return true},getContentUrl:function WP_getContentUrl(download){var proxy=window.location.protocol+"//"+window.location.host+Alfresco.constants.URL_CONTEXT+"proxy/"+this.options.proxy+"/",nodeRefAsLink=this.options.nodeRef.replace(":/",""),noCache="noCache="+new Date().getTime();download=download?"a=true":"a=false";return proxy+this.options.api+"/node/"+nodeRefAsLink+"/content/"+encodeURIComponent(this.options.name)+"?c=force&"+noCache+"&"+download},getThumbnailUrl:function WP_getThumbnailUrl(thumbnail,fileSuffix){var proxy=window.location.protocol+"//"+window.location.host+Alfresco.constants.URL_CONTEXT+"proxy/"+this.options.proxy+"/",nodeRefAsLink=this.options.nodeRef.replace(":/",""),noCache="noCache="+new Date().getTime(),force="c=force";for(var i=0;i<this.options.thumbnailModification.length;i++){if(this.options.thumbnailModification[i].indexOf(thumbnail)!=-1){var timestampPostfix=noCache;noCache="lastModified="+encodeURIComponent(this.options.thumbnailModification[i]);if(this.options.avoidCachedThumbnail){noCache+="&"+timestampPostfix;this.options.avoidCachedThumbnail=false}break}}return proxy+this.options.api+"/node/"+nodeRefAsLink+"/content/thumbnails/"+thumbnail+(fileSuffix?"/suffix"+fileSuffix:"")+"?"+force+"&"+noCache},getPreviewerElement:function(){return this.widgets.previewerElement},doRefresh:function WP_doRefresh(){if(this.plugin){this.plugin.display()}}})})();