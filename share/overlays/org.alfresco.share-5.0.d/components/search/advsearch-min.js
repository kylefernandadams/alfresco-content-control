(function(){var f=YAHOO.util.Dom,k=YAHOO.util.Event,c=YAHOO.Bubbling;var d=Alfresco.util.encodeHTML;Alfresco.AdvancedSearch=function(l){Alfresco.AdvancedSearch.superclass.constructor.call(this,"Alfresco.AdvancedSearch",l,["button","container"]);c.on("beforeFormRuntimeInit",this.onBeforeFormRuntimeInit,this);c.on("afterFormRuntimeInit",this.onAfterFormRuntimeInit,this);return this};YAHOO.extend(Alfresco.AdvancedSearch,Alfresco.component.Base,{options:{siteId:"",searchForms:[],savedQuery:"",searchScope:""},currentForm:null,onReady:function a(){var o=this,r=this.id+"-form-list",m=f.get(r);var l=this.options.searchForms[0];if(this.options.savedQuery.length!==0){var q=YAHOO.lang.JSON.parse(this.options.savedQuery);if(q.datatype){for(var p in this.options.searchForms){var n=this.options.searchForms[p];if(n.type===q.datatype){l=n;break}}}}this.widgets.searchButton1=Alfresco.util.createYUIButton(this,"search-button-1",this.onSearchClick);this.widgets.searchButton2=Alfresco.util.createYUIButton(this,"search-button-2",this.onSearchClick);this.widgets.formButton=Alfresco.util.createYUIButton(this,"selected-form-button",function(u,t){var v=this.options.searchForms[t[1].index];this.widgets.formButton.set("label",v.label+" "+Alfresco.constants.MENU_ARROW_SYMBOL);this.widgets.formButton.set("title",v.description);this.renderFormTemplate(v)},{label:l.label+" "+Alfresco.constants.MENU_ARROW_SYMBOL,title:l.description,type:"menu",menu:"selected-form-list"});this.renderFormTemplate(l,true);var s=f.get(this.id+"-search-text");this.widgets.enterListener=new YAHOO.util.KeyListener(s,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:o._searchEnterHandler,scope:this,correctScope:true},"keydown").enable();f.setStyle(this.id+"-body","visibility","visible")},renderFormTemplate:function b(m,s){this.currentForm=m;this.currentForm.repopulate=s;var r=f.get(this.id+"-forms");var q=function(){for(var u=0,v=r.children;u<v.length;u++){if(!f.hasClass(v[u],"hidden")){f.addClass(v[u],"hidden");break}}f.removeClass(m.htmlid,"hidden");f.get(this.id+"-search-text").focus()};if(!m.htmlid){var t=this.id+"_"+r.children.length;var n=document.createElement("div");n.id=t;f.addClass(n,"hidden");f.addClass(n,"share-form");m.htmlid=t;var l=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind=type&itemId={itemId}&formId={formId}&mode=edit&showSubmitButton=false&showCancelButton=false",{itemId:m.type,formId:m.id});var p={htmlid:t};Alfresco.util.Ajax.request({url:l,dataObj:p,successCallback:{fn:function o(u){n.innerHTML=u.serverResponse.responseText;r.appendChild(n);q.call(this)},scope:this},failureMessage:"Could not load form component '"+l+"'.",scope:this,execScripts:true})}else{q.call(this)}},repopulateCurrentForm:function i(){if(this.options.savedQuery.length!==0){var s=YAHOO.lang.JSON.parse(this.options.savedQuery);var l=f.get(this.currentForm.runtime.formId);for(var p=0,n=l.elements.length;p<n;p++){var o=l.elements[p];var m=o.name;if(m!=undefined&&m!=="-"){var r=s[m];if(r!==undefined){if(o.type==="checkbox"||o.type==="radio"){o.checked=(r==="true")}else{if(m.match("-range$")=="-range"){var q=f.get(o.id+"-cntrl-min");if(q){q.value=r.substring(0,r.indexOf("|"));q=f.get(o.id+"-cntrl-max");q.value=r.substring(r.indexOf("|")+1,r.length);q=f.get(o.id);q.value=r}else{o.value=r}}else{o.value=r}}if(o.type==="hidden"){var q=f.get(o.id+"-entry");if(q){switch(q.type){case"checkbox":q.checked=(r==="true");break;default:q.value=r;break}}}}}}c.fire("formContentsUpdated")}},onSearchClick:function h(o,n){var m=this.currentForm.runtime.getFormData();m.datatype=this.currentForm.type;var l=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+this.options.searchPath,{site:(this.options.siteId.length!==0?("site/"+this.options.siteId+"/"):""),terms:encodeURIComponent(f.get(this.id+"-search-text").value),query:encodeURIComponent(YAHOO.lang.JSON.stringify(m)),scope:this.options.searchScope.toString()});window.location.href=l},onBeforeFormRuntimeInit:function j(q,o){this.currentForm.runtime=o[1].runtime;this.currentForm.runtime.validations={};var l=this.currentForm.runtime.getFieldsByType("select");for(var p=0,r=l.length;p<r;p++){if(l[p].classList.contains("non-tokenised")){var n=l[p].options;for(var m=0,s=n.length;m<s;m++){if(n[m].value!=""){n[m].value='"'+n[m].value+'"'}}}}if(this.currentForm.repopulate){this.currentForm.repopulate=false;this.repopulateCurrentForm()}},onAfterFormRuntimeInit:function g(m,l){this.currentForm.runtime=l[1].runtime;var n=(f.get(this.currentForm.runtime.formId));k.removeListener(n,"submit");n.setAttribute("onsubmit","return false;")},_searchEnterHandler:function e(m,l){this.onSearchClick(m,l)}})})();