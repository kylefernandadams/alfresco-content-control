(function(){var c=YAHOO.util.Dom,v=YAHOO.util.Event;var q=Alfresco.util.encodeHTML;Alfresco.Search=function(w){Alfresco.Search.superclass.constructor.call(this,"Alfresco.Search",w,["button","container","datasource","datatable","paginator","json"]);YAHOO.Bubbling.on("onSearch",this.onSearch,this);return this};YAHOO.extend(Alfresco.Search,Alfresco.component.SearchBase,{options:{siteId:"",siteTitle:"",maxSearchResults:250,pageSize:50,initialSearchTerm:"",initialSearchTag:"",initialSearchAllSites:true,initialSearchRepository:false,initialSort:"",searchQuery:"",searchRootNode:"",minSearchTermLength:1},searchTerm:"",searchTag:"",searchAllSites:true,searchRepository:false,searchSort:"",resultsCount:0,currentPage:1,hasMoreResults:false,onReady:function r(){var D=this;var x=Alfresco.constants.PROXY_URI_RELATIVE+"slingshot/search?";this.widgets.dataSource=new YAHOO.util.DataSource(x,{responseType:YAHOO.util.DataSource.TYPE_JSON,connXhrMode:"queueRequests",responseSchema:{resultsList:"items",metaFields:{paginationRecordOffset:"startIndex",totalRecords:"totalRecords",totalRecordsUpper:"totalRecordsUpper"}}});var A=function C(G,F){F.currentPage=G.page;F.widgets.paginator.setState(G);F._performSearch({searchTerm:F.searchTerm,searchTag:F.searchTag,searchAllSites:F.searchAllSites,searchRepository:F.searchRepository,searchSort:F.searchSort,page:F.currentPage})};this.widgets.paginator=new YAHOO.widget.Paginator({containers:[this.id+"-paginator-top",this.id+"-paginator-bottom"],rowsPerPage:this.options.pageSize,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});this.widgets.paginator.subscribe("changeRequest",A,this);this._setupDataTable();var z=c.get(this.id+"-search-text");z.value=this.options.initialSearchTerm;this.widgets.enterListener=new YAHOO.util.KeyListener(z,{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:D._searchEnterHandler,scope:this,correctScope:true},"keydown");this.widgets.enterListener.enable();this.widgets.searchButton=Alfresco.util.createYUIButton(this,"search-button",this.onSearchClick);this._disableItems();YAHOO.Bubbling.fire("onSearch",{searchTerm:this.options.initialSearchTerm,searchTag:this.options.initialSearchTag,searchSort:this.options.initialSort,searchAllSites:this.options.initialSearchAllSites,searchRepository:this.options.initialSearchRepository});this.widgets.sortButton=new YAHOO.widget.Button(this.id+"-sort-menubutton",{type:"menu",menu:this.id+"-sort-menu",menualignment:["tr","br"],lazyloadmenu:false});var w=this.widgets.sortButton.getMenu().getItems();for(var y in w){if(w[y].value===this.options.initialSort){this.widgets.sortButton.set("label",this.msg("label.sortby",w[y].cfg.getProperty("text")));break}}this.widgets.sortButton.getMenu().subscribe("click",function(G,F){var H=F[1];if(H){D.refreshSearch({searchSort:H.value})}});var E=function B(H,G){var F=YAHOO.Bubbling.getOwnerByTagName(G[1].anchor,"span");if(F!==null){if(typeof D[F.className]=="function"){G[1].stop=true;var I=F.id.substring(D.id.length+1);D[F.className].call(D,I)}}return true};YAHOO.Bubbling.addDefaultAction("search-tag",E);c.setStyle(this.id+"-body","visibility","visible")},_setupDataTable:function f(){var A=this;renderCellThumbnail=function z(D,C,E,F){E.width=100;c.setStyle(D.parentNode,"width",E.width+"px");c.setStyle(D.parentNode,"background-color","#f4f4f4");c.addClass(D,"thumbnail-cell");if(C.getData("type")==="document"){c.addClass(D,"thumbnail")}D.innerHTML=A.buildThumbnailHtml(C)};renderCellDescription=function x(N,Q,J,E){c.addClass(N.parentNode,"description");var C=Q.getData("site");var D=A._getBrowseUrlForRecord(Q);var M=Q.getData("displayName");var I='<h3 class="itemname"><a href="'+D+'" class="theme-color-1">'+q(M)+"</a>";var L=Q.getData("title");if(L&&L!==M){I+='<span class="title">('+q(L)+")</span>"}I+="</h3>";var H=Q.getData("description");if(H){I+='<div class="details meta">'+q(H)+"</div>"}I+='<div class="details">';var K=Q.getData("type");I+=A.buildTextForType(K);if(C){I+=" "+A.msg("message.insite");I+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"site/"+q(C.shortName)+'/dashboard">'+q(C.title)+"</a>"}if(Q.getData("size")!==-1){I+=" "+A.msg("message.ofsize");I+=' <span class="meta">'+Alfresco.util.formatFileSize(Q.getData("size"))+"</span>"}if(Q.getData("modifiedBy")){I+=" "+A.msg("message.modifiedby");I+=' <a href="'+Alfresco.constants.URL_PAGECONTEXT+"user/"+encodeURI(Q.getData("modifiedByUser"))+'/profile">'+q(Q.getData("modifiedBy"))+"</a>"}I+=" "+A.msg("message.modifiedon")+' <span class="meta">'+Alfresco.util.formatDate(Q.getData("modifiedOn"))+"</span>";I+="</div>";var P=Q.getData("path");I+=A.buildPath(K,P,C);var O=Q.getData("tags");if(O.length!==0){var G,F;I+='<div class="details"><span class="tags">';for(G=0,F=O.length;G<F;G++){I+='<span id="'+A.id+"-"+q(O[G])+'" class="searchByTag"><a class="search-tag" href="#">'+q(O[G])+"</a> </span>"}I+="</span></div>"}N.innerHTML=I};var B=[{key:"image",label:A.msg("message.preview"),sortable:false,formatter:renderCellThumbnail,width:100},{key:"summary",label:A.msg("label.description"),sortable:false,formatter:renderCellDescription}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.id+"-results",B,this.widgets.dataSource,{renderLoopSize:Alfresco.util.RENDERLOOPSIZE,initialLoad:false,paginator:this.widgets.paginator,MSG_LOADING:""});this._setDefaultDataTableErrors(this.widgets.dataTable);if(this.options.initialSearchTerm.length===0&&this.options.initialSearchTag.length===0){this.widgets.dataTable.set("MSG_EMPTY","")}this.widgets.dataTable.doBeforeLoadData=function y(D,E,G){if(E.error){try{var C=YAHOO.lang.JSON.parse(E.responseText);A.widgets.dataTable.set("MSG_ERROR",C.message)}catch(F){A._setDefaultDataTableErrors(A.widgets.dataTable)}}else{if(E.results){A.widgets.dataTable.set("MSG_EMPTY","");if(E.results.length===0){c.removeClass(A.id+"-help","hidden")}}}return true};A.widgets.dataTable.handleDataReturnPayload=function w(D,C,E){A.resultsCount=C.meta.totalRecordsUpper;if(A.hasMoreResults=(A.resultsCount>A.options.maxSearchResults)){A.resultsCount=A.options.maxSearchResults}if(A.resultsCount>A.options.pageSize){c.removeClass(A.id+"-paginator-top","hidden");c.removeClass(A.id+"-search-bar-bottom","hidden")}return C.meta};A.widgets.dataTable.subscribe("renderEvent",function(){A.widgets.paginator.setState({page:A.currentPage,totalRecords:A.resultsCount});A.widgets.paginator.render()})},_getBrowseUrlForRecord:function k(w){return this.getBrowseUrlForRecord(w)},_getBrowseUrlForFolderPath:function m(x,w){return this.getBrowseUrlForFolderPath(x,w)},_buildSpaceNamePath:function o(x,w){return this.buildSpaceNamePath(x,w)},searchByTag:function t(w){this.refreshSearch({searchTag:w,searchTerm:"",searchQuery:""})},refreshSearch:function g(z){var x=this.searchTerm;if(z.searchTerm!==undefined){x=z.searchTerm}var A=this.searchTag;if(z.searchTag!==undefined){A=z.searchTag}var C=this.searchAllSites;if(z.searchAllSites!==undefined){C=z.searchAllSites}var D=this.searchRepository;if(z.searchRepository!==undefined){D=z.searchRepository}var w=this.searchSort;if(z.searchSort!==undefined){w=z.searchSort}var B=this.options.searchQuery;if(z.searchQuery!==undefined){B=z.searchQuery}var y=Alfresco.constants.URL_PAGECONTEXT;if(this.options.siteId.length!==0){y+="site/"+this.options.siteId+"/"}y+="search?t="+encodeURIComponent(x);y+="&s="+w;if(B.length!==0){y+="&q="+B}else{if(A.length!==0){y+="&tag="+encodeURIComponent(A)}}y+="&a="+C+"&r="+D;window.location=y},onSearch:function i(A,y){var D=y[1];if(D!==null){var x=this.searchTerm;if(D.searchTerm!==undefined){x=D.searchTerm}var z=this.searchTag;if(D.searchTag!==undefined){z=D.searchTag}var B=this.searchAllSites;if(D.searchAllSites!==undefined){B=D.searchAllSites}var C=this.searchRepository;if(D.searchRepository!==undefined){C=D.searchRepository}var w=this.searchSort;if(D.searchSort!==undefined){w=D.searchSort}this._disableItems();this._performSearch({searchTerm:x,searchTag:z,searchAllSites:B,searchRepository:C,searchSort:w})}},onSearchClick:function d(x,w){this.refreshSearch({searchTag:"",searchTerm:YAHOO.lang.trim(c.get(this.id+"-search-text").value),searchQuery:""})},onSiteSearch:function l(x,w){this.refreshSearch({searchAllSites:false,searchRepository:false})},onAllSiteSearch:function u(x,w){this.refreshSearch({searchAllSites:true,searchRepository:false})},onRepositorySearch:function h(x,w){this.refreshSearch({searchRepository:true})},_searchEnterHandler:function n(x,w){this.refreshSearch({searchTag:"",searchTerm:YAHOO.lang.trim(c.get(this.id+"-search-text").value),searchQuery:""})},_performSearch:function a(D){var y=YAHOO.lang.trim(D.searchTerm),z=YAHOO.lang.trim(D.searchTag),E=D.searchAllSites,x=D.searchRepository,A=D.searchSort,C=D.page||1;if(this.options.searchQuery.length===0&&z.length===0&&y.replace(/\*/g,"").length<this.options.minSearchTermLength){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.minimum-length",this.options.minSearchTermLength)});this._enableItems();return}this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());c.addClass(this.id+"-paginator-top","hidden");c.addClass(this.id+"-search-bar-bottom","hidden");c.get(this.id+"-search-info").innerHTML=this.msg("search.info.searching");this.widgets.dataTable.set("MSG_EMPTY","");this.widgets.dataTable.render();function B(F,G,H){this.searchTerm=y;this.searchTag=z;this.searchAllSites=E;this.searchRepository=x;this.searchSort=A;this.widgets.dataTable.onDataReturnInitializeTable.call(this.widgets.dataTable,F,G,H);this._updateResultsInfo();c.get(this.id+"-search-text").focus();this._enableItems()}function w(G,H){switch(H.status){case 401:window.location.reload();break;case 408:c.get(this.id+"-search-info").innerHTML=this.msg("message.timeout");break;default:if(H.responseText){var F=YAHOO.lang.JSON.parse(H.responseText);c.get(this.id+"-search-info").innerHTML=F.message}else{c.get(this.id+"-search-info").innerHTML=H.statusText}break}this._enableItems()}this.widgets.dataSource.sendRequest(this._buildSearchParams(x,E,y,z,A,C),{success:B,failure:w,scope:this})},_disableItems:function j(){var w=c.get(this.id+"-all-sites-link");if(w){v.removeListener(w,"click");w.style.color="#aaa"}w=c.get(this.id+"-repo-link");if(w){v.removeListener(w,"click");w.style.color="#aaa"}w=c.get(this.id+"-site-link");if(w){v.removeListener(w,"click");w.style.color="#aaa"}this.widgets.searchButton.set("disabled",true);if(this.widgets.enterListener){this.widgets.enterListener.disable()}},_enableItems:function s(){var w=c.get(this.id+"-all-sites-link");if(w){v.addListener(w,"click",this.onAllSiteSearch,this,true);w.style.color=""}w=c.get(this.id+"-repo-link");if(w){v.addListener(w,"click",this.onRepositorySearch,this,true);w.style.color=""}w=c.get(this.id+"-site-link");if(w){v.addListener(w,"click",this.onSiteSearch,this,true);w.style.color=""}this.widgets.searchButton.set("disabled",false);if(this.widgets.enterListener){this.widgets.enterListener.enable()}},_updateResultsInfo:function e(){var x;var w=""+this.resultsCount;if(this.hasMoreResults){x=this.msg("search.info.resultinfomore",w)}else{x=this.msg("search.info.resultinfo",w)}if(this.searchRepository||this.options.searchQuery.length!==0){x+=" "+this.msg("search.info.foundinrepository")}else{if(this.searchAllSites){x+=" "+this.msg("search.info.foundinallsite")}else{x+=" "+this.msg("search.info.foundinsite",q(this.options.siteTitle))}}c.get(this.id+"-search-info").innerHTML=x},_buildSearchParams:function b(C,B,x,z,w,A){var y=B?"":this.options.siteId;var D=YAHOO.lang.substitute("site={site}&term={term}&tag={tag}&maxResults={maxResults}&sort={sort}&query={query}&repo={repo}&rootNode={rootNode}&pageSize={pageSize}&startIndex={startIndex}",{site:encodeURIComponent(y),repo:C.toString(),term:encodeURIComponent(x),tag:encodeURIComponent(z),sort:encodeURIComponent(w),query:encodeURIComponent(this.options.searchQuery),rootNode:encodeURIComponent(this.options.searchRootNode),maxResults:this.options.maxSearchResults+1,pageSize:this.options.pageSize,startIndex:(A-1)*this.options.pageSize});return D},_setDefaultDataTableErrors:function p(w){var x=Alfresco.util.message;w.set("MSG_EMPTY",x("message.empty","Alfresco.Search"));w.set("MSG_ERROR",x("message.error","Alfresco.Search"))}})})();