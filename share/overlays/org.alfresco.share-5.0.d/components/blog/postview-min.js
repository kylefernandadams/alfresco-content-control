(function(){var c=YAHOO.util.Dom,x=YAHOO.util.Event,p=YAHOO.util.Element;var q=Alfresco.util.encodeHTML;Alfresco.BlogPostView=function(y){this.name="Alfresco.BlogPostView";this.id=y;this.widgets={};this.tagId={id:0,tags:{}};Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["json","connection","event","button","menu"],this.onComponentsLoaded,this);YAHOO.Bubbling.on("tagSelected",this.onTagSelected,this);return this};Alfresco.BlogPostView.prototype={options:{siteId:"",containerId:"blog",postId:""},blogPostData:null,widgets:null,tagId:null,busy:false,setOptions:function b(y){this.options=YAHOO.lang.merge(this.options,y);return this},setMessages:function k(y){Alfresco.util.addMessages(y,this.name);return this},onComponentsLoaded:function h(){x.onContentReady(this.id,this.onReady,this,true)},onReady:function o(){var z=this;var A=function y(D,C){var B=YAHOO.Bubbling.getOwnerByTagName(C[1].anchor,"div");if(B!==null){var E="";E=B.className;if(typeof z[E]=="function"){z[E].call(z,z.blogPostData.name);C[1].stop=true}}return true};YAHOO.Bubbling.addDefaultAction("blogpost-action-link-div",A);Alfresco.util.tags.registerTagActionHandler(this);Alfresco.util.rollover.registerHandlerFunctions(this.id,this.onPostElementMouseEntered,this.onPostElementMouseExited,this);this._loadBlogPostData()},_loadBlogPostData:function f(){var y=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/blog/post/site/{site}/{container}/{postId}",{site:this.options.siteId,container:this.options.containerId,postId:this.options.postId});Alfresco.util.Ajax.request({url:y,successCallback:{fn:this.loadBlogPostDataSuccess,scope:this},failureMessage:this._msg("message.loadpostdata.failure")})},loadBlogPostDataSuccess:function a(z){var B=z.json.item;this.blogPostData=B;var y=c.get(this.id+"-post-view-div");var A=this.renderBlogPost(B);y.innerHTML=A;Alfresco.util.rollover.registerListenersByClassName(this.id,"post","div");this.sendCommentedNodeEvent()},sendCommentedNodeEvent:function v(){var y={nodeRef:this.blogPostData.nodeRef,title:this.blogPostData.title,page:"blog-postview",pageParams:{postId:this.blogPostData.name}};YAHOO.Bubbling.fire("setCommentedNode",y)},renderBlogPost:function s(D){var B=Alfresco.util.blog.generateBlogPostViewUrl(this.options.siteId,this.options.containerId,D.name);var z=Alfresco.util.blog.generatePostStatusLabel(this,D);var A=D.author.username;if(typeof D.author.firstName!="undefined"){A=Alfresco.util.people.generateUserLink(D.author)}var C='<div id="'+this.id+'-postview" class="node post postview theme-bg-color-6 theme-border-3">';C+=Alfresco.util.blog.generateBlogPostActions(this,D,"div");C+='<div class="nodeContent">';C+='<div class="nodeTitle"><a href="'+B+'">'+q(D.title)+"</a> ";C+='<span class="theme-color-2 nodeStatus">'+z+"</span>";C+="</div>";C+='<div class="published">';if(!D.isDraft){C+='<span class="nodeAttrLabel">'+this._msg("post.publishedOn")+": </span>";C+='<span class="nodeAttrValue">'+Alfresco.util.formatDate(D.releasedOn)+"</span>";C+='<span class="separator">&nbsp;</span>'}C+='<span class="nodeAttrLabel">'+this._msg("post.author")+": </span>";C+='<span class="nodeAttrValue">'+A+"</span>";if(D.isPublished&&D.postLink!==undefined&&D.postLink.length>0){C+='<span class="separator">&nbsp;</span>';C+='<span class="nodeAttrLabel">'+this._msg("post.externalLink")+": </span>";C+='<span class="nodeAttrValue"><a target="_blank" href="'+D.postLink+'">'+this._msg("post.clickHere")+"</a></span>"}C+='<span class="separator">&nbsp;</span>';C+='<span class="nodeAttrLabel tagLabel">'+this._msg("label.tags")+": </span>";if(D.tags.length>0){for(var y=0;y<D.tags.length;y++){if(y>0){C+=", "}C+=Alfresco.util.tags.generateTagLink(this,D.tags[y])}}else{C+='<span class="nodeAttrValue">'+this._msg("post.noTags")+"</span>"}C+="</div>";C+='<div class="content yuieditor">'+D.content+"</div>";C+="</div></div>";return C},onTagSelected:function w(A,z){var B=z[1];if(B&&(B.tagName!==null)){var y=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/blog-postlist?filterId={filterId}&filterOwner={filterOwner}&filterData={filterData}",{site:this.options.siteId,filterId:"tag",filterOwner:"Alfresco.BlogPostListTags",filterData:encodeURIComponent(B.tagName)});window.location=y}},onEditBlogPost:function i(y){var z=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/blog-postedit?postId={postId}",{site:this.options.siteId,postId:y});window.location=z},onDeleteBlogPost:function r(z){var A=this;Alfresco.util.PopupManager.displayPrompt({title:this._msg("message.confirm.delete.title"),text:this._msg("message.confirm.delete",q(this.blogPostData.title)),buttons:[{text:this._msg("button.delete"),handler:function y(){this.destroy();A._deleteBlogPostConfirm.call(A,A.blogPostData.name)}},{text:this._msg("button.cancel"),handler:function B(){this.destroy()},isDefault:true}]})},_deleteBlogPostConfirm:function e(y){if(!this._setBusy(this._msg("message.wait"))){return}var A=function B(C){this._releaseBusy();var D=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/blog-postlist",{site:this.options.siteId});window.location=D};var z=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/blog/post/site/{site}/{container}/{postId}?page={page}",{site:this.options.siteId,container:this.options.containerId,postId:encodeURIComponent(y),page:"blog-postlist"});Alfresco.util.Ajax.request({url:z,method:"DELETE",responseContentType:"application/json",successMessage:this._msg("message.delete.success"),successCallback:{fn:A,scope:this},failureMessage:this._msg("message.delete.failure"),failureCallback:{fn:function(C){this._releaseBusy()},scope:this}})},onPublishExternal:function j(y){if(!this._setBusy(this._msg("message.wait"))){return}var B=function A(C){this._releaseBusy();this.loadBlogPostDataSuccess(C)};var z=Alfresco.util.blog.generatePublishingRestURL(this.options.siteId,this.options.containerId,y);Alfresco.util.Ajax.request({url:z,method:"POST",requestContentType:"application/json",responseContentType:"application/json",dataObj:{action:"publish"},successMessage:this._msg("message.publishExternal.success"),successCallback:{fn:B,scope:this},failureMessage:this._msg("message.publishExternal.failure"),failureCallback:{fn:function(C){this._releaseBusy()},scope:this}})},onUpdateExternal:function t(y){if(!this._setBusy(this._msg("message.wait"))){return}var z=function B(C){this._releaseBusy();this.loadBlogPostDataSuccess(C)};var A=Alfresco.util.blog.generatePublishingRestURL(this.options.siteId,this.options.containerId,y);Alfresco.util.Ajax.request({url:A,method:"POST",requestContentType:"application/json",responseContentType:"application/json",dataObj:{action:"update"},successMessage:this._msg("message.updateExternal.success"),successCallback:{fn:z,scope:this},failureMessage:this._msg("message.updateExternal.failure"),failureCallback:{fn:function(C){this._releaseBusy()},scope:this}})},onUnpublishExternal:function n(z){if(!this._setBusy(this._msg("message.wait"))){return}var y=function B(C){this._releaseBusy();this.loadBlogPostDataSuccess(C)};var A=Alfresco.util.blog.generatePublishingRestURL(this.options.siteId,this.options.containerId,z);Alfresco.util.Ajax.request({url:A,method:"POST",requestContentType:"application/json",responseContentType:"application/json",dataObj:{action:"unpublish"},successMessage:this._msg("message.unpublishExternal.success"),successCallback:{fn:y,scope:this},failureMessage:this._msg("message.unpublishExternal.failure"),failureCallback:{fn:function(C){this._releaseBusy()},scope:this}})},onPostElementMouseEntered:function d(z,y){var A=this.blogPostData.permissions;if(!(A.edit||A["delete"])){return}c.addClass(y[1].target,"over")},onPostElementMouseExited:function l(z,y){c.removeClass(y[1].target,"over")},_setBusy:function g(y){if(this.busy){return false}this.busy=true;this.widgets.busyMessage=Alfresco.util.PopupManager.displayMessage({text:y,spanClass:"wait",displayTime:0});return true},_releaseBusy:function u(){if(this.busy){this.widgets.busyMessage.destroy();this.busy=false;return true}else{return false}},_msg:function m(y){return Alfresco.util.message.call(this,y,"Alfresco.BlogPostView",Array.prototype.slice.call(arguments).slice(1))}}})();