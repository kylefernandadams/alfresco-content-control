(function(){var c=YAHOO.util.Dom;Alfresco.CommentList=function q(A){Alfresco.CommentList.superclass.constructor.call(this,"Alfresco.CommentList",A,["editor","paginator"]);this.editData={editDiv:null,viewDiv:null,row:-1,data:null,widgets:{}};this.busy=false;YAHOO.Bubbling.on("setCommentedNode",this.onSetCommentedNode,this);YAHOO.Bubbling.on("refreshComments",this.onRefreshComments,this);return this};YAHOO.extend(Alfresco.CommentList,Alfresco.component.Base,{options:{siteId:"",containerId:"",itemNodeRef:null,activityTitle:null,activityPage:null,activityPageParams:null,width:700,height:180,pageSize:10},editData:null,commentsData:null,busy:null,onReady:function h(){var B=this;var D=new YAHOO.widget.Paginator({containers:[this.id+"-paginator"],rowsPerPage:this.options.pageSize,initialPage:1,template:this.msg("pagination.template"),pageReportTemplate:this.msg("pagination.template.page-report"),previousPageLinkLabel:this.msg("pagination.previousPageLinkLabel"),nextPageLinkLabel:this.msg("pagination.nextPageLinkLabel")});D.subscribe("changeRequest",this.onPaginatorChange,this,true);D.set("recordOffset",0);D.set("totalRecords",0);D.render();this.widgets.paginator=D;var C=function A(I,H){var E=YAHOO.Bubbling.getOwnerByTagName(H[1].anchor,"div");if(E!==null){var J=E.className;if(typeof B[J]=="function"){var G=c.getAncestorByClassName(E,"comment"),F=parseInt(G.id.substring((B.id+"-comment-view-").length),10);B[J].call(B,F);H[1].stop=true}}return true};YAHOO.Bubbling.addDefaultAction("blogcomment-action",C);Alfresco.util.rollover.registerHandlerFunctions(this.id,this.onCommentElementMouseEntered,this.onCommentElementMouseExited,this)},onPaginatorChange:function b(A){this._loadCommentsList(A.recordOffset)},onSetCommentedNode:function g(B,A){var C=A[1];if((C!==null)&&(C.nodeRef!==null)&&(C.title!==null)&&(C.page!==null)){this.options.itemNodeRef=C.nodeRef;this.options.activityTitle=C.title;this.options.activityPage=C.page;this.options.activityPageParams=C.pageParams;this._loadCommentsList(0)}},onRefreshComments:function u(F,H){if(this.options.itemNodeRef&&this.options.activityTitle){var B=this.widgets.paginator,C=H[1];var J=0,I=B.getTotalRecords(),A=this.options.pageSize;if(C.reason=="deleted"){var G=Math.floor((I-1)/A)+(((I-1)%A)>0?1:0),E=B.getCurrentPage();if(G<E){E=E>1?E-1:1}var D=B.getPageRecords(E);J=D?D[0]:0}if(C.reason=="created"){J=Math.floor(I/A)*A}this._loadCommentsList(J)}},_loadCommentsList:function d(B){var A=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/node/{nodeRef}/comments",{nodeRef:this.options.itemNodeRef.replace(":/","")});Alfresco.util.Ajax.request({url:A,dataObj:{startIndex:B,pageSize:this.options.pageSize},successCallback:{fn:this.loadCommentsSuccess,scope:this},failureMessage:this.msg("message.loadComments.failure")})},loadCommentsSuccess:function a(A){this._hideEditView();var H=A.json.items;var E=c.get(this.id+"-body"),G=c.get(this.id+"-title"),F=c.get(this.id+"-comments");E.setAttribute("style","display:none");if(H.length>0){G.innerHTML=Alfresco.util.message("label.comments",this.name,{"0":H.length,"1":A.json.total})}else{G.innerHTML=Alfresco.util.message("label.noComments",this.name)}var D="",C,B;for(C=0,B=H.length;C<B;C++){D+=this.renderComment(C,H[C])}F.innerHTML=D;E.removeAttribute("style");Alfresco.util.rollover.registerListenersByClassName(this.id,"comment","div");this.commentsData=H;YAHOO.Bubbling.fire("setCanCreateComment",{canCreateComment:A.json.nodePermissions.create});this._updatePaginator(A.json.startIndex,A.json.total)},_updatePaginator:function x(B,A){if(this.widgets&&this.widgets.paginator){this.widgets.paginator.set("recordOffset",B);this.widgets.paginator.set("totalRecords",A)}else{YAHOO.lang.later(100,this,this._updatePaginator,[B,A])}},onEditComment:function n(A){this._loadForm(A,this.commentsData[A])},onDeleteComment:function o(D){var C=this;Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.confirm.delete.title"),text:this.msg("message.confirm.delete"),buttons:[{text:this.msg("button.delete"),handler:function B(){this.destroy();C._onDeleteCommentConfirm.call(C,D)}},{text:this.msg("button.cancel"),handler:function A(){this.destroy()},isDefault:true}]})},_onDeleteCommentConfirm:function z(B){var A=this.commentsData[B];this._deleteComment(B,A)},_deleteComment:function j(G,E){if(!this._setBusy(this.msg("message.wait"))){return}var F=function D(H){this._releaseBusy();YAHOO.Bubbling.fire("refreshComments",{reason:"deleted"})};var C=function A(H){this._releaseBusy()};var B=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/comment/node/{nodeRef}/?site={site}&itemTitle={itemTitle}&page={page}&pageParams={pageParams}",{site:this.options.siteId,container:this.options.containerId,nodeRef:E.nodeRef.replace(":/",""),itemTitle:encodeURIComponent(this.options.activityTitle),page:encodeURIComponent(this.options.activityPage),pageParams:encodeURIComponent(YAHOO.lang.JSON.stringify(this.options.activityPageParams))});Alfresco.util.Ajax.request({url:B,method:"DELETE",responseContentType:"application/json",successMessage:this.msg("message.delete.success"),successCallback:{fn:F,scope:this},failureMessage:this.msg("message.delete.failure"),failureCallback:{fn:C,scope:this}})},_loadForm:function k(C,A){var B=this.id+"-edit-comment-"+C;Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/blog/comments/edit-comment",dataObj:{htmlid:B},successCallback:{fn:this.onFormLoaded,scope:this,obj:{formId:B,row:C,data:A}},failureMessage:this.msg("message.loadeditform.failure"),execScripts:true})},onFormLoaded:function v(B,F){var H=F.row,E=F.data,G=F.formId;this._hideEditView();var A=c.get(this.id+"-comment-view-"+H),C=c.get(this.id+"-comment-edit-"+H);C.innerHTML=B.serverResponse.responseText;var D=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/comment/node/{nodeRef}",{nodeRef:E.nodeRef.replace(":/","")});c.get(G+"-form").setAttribute("action",D);c.get(G+"-site").setAttribute("value",this.options.siteId);c.get(G+"-container").setAttribute("value",this.options.containerId);c.get(G+"-itemTitle").setAttribute("value",this.options.activityTitle);c.get(G+"-page").setAttribute("value",this.options.activityPage);c.get(G+"-pageParams").setAttribute("value",YAHOO.lang.JSON.stringify(this.options.activityPageParams));c.get(G+"-content").value=E.content;c.addClass(A,"hidden");c.removeClass(C,"hidden");this.editData={viewDiv:A,editDiv:C,row:H,widgets:{},formId:G};this._registerEditCommentForm(H,E,G)},_registerEditCommentForm:function i(E,C,D){this.editData.widgets.okButton=new YAHOO.widget.Button(D+"-submit",{type:"submit"});this.editData.widgets.cancelButton=new YAHOO.widget.Button(D+"-cancel");this.editData.widgets.cancelButton.subscribe("click",this.onEditFormCancelButtonClick,this,true);this.editData.widgets.editor=new Alfresco.util.RichEditor(Alfresco.constants.HTML_EDITOR,D+"-content",this.options.editorConfig);this.editData.widgets.editor.addPageUnloadBehaviour(this.msg("message.unsavedChanges.comment"));this.editData.widgets.editor.render();var B=(Alfresco.constants.HTML_EDITOR==="YAHOO.widget.SimpleEditor")?"editorKeyUp":"onKeyUp";this.editData.widgets.editor.subscribe(B,function(F){if(this.editData.widgets.editor.getContent().length<20||!this.editData.widgets.commentForm.isValid()){this.editData.widgets.editor.save();this.editData.widgets.commentForm.validate()}},this,true);var A=new Alfresco.forms.Form(D+"-form");this.editData.widgets.commentForm=A;A.addValidation(D+"-content",Alfresco.forms.validation.mandatory,null);A.setSubmitElements(this.editData.widgets.okButton);A.setAjaxSubmitMethod(Alfresco.util.Ajax.PUT);A.setAJAXSubmit(true,{successMessage:this.msg("message.savecomment.success"),successCallback:{fn:this.onEditFormSubmitSuccess,scope:this},failureMessage:this.msg("message.savecomment.failure"),failureCallback:{fn:this.onEditFormSubmitFailure,scope:this}});A.setSubmitAsJSON(true);A.doBeforeFormSubmit={fn:function(F,G){this.editData.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.savecomment",this.name),spanClass:"wait",displayTime:0});this.editData.widgets.editor.disable();this.editData.widgets.editor.save()},scope:this};A.init()},onEditFormSubmitSuccess:function f(A){this.editData.widgets.feedbackMessage.destroy();this.commentsData[this.editData.row]=A.json.item;this.editData.viewDiv.innerHTML=this.renderCommentView(this.editData.row,A.json.item);this._hideEditView()},onEditFormSubmitFailure:function m(A){this.editData.widgets.feedbackMessage.destroy();this.editData.widgets.editor.disable()},onEditFormCancelButtonClick:function e(){this._hideEditView()},renderComment:function r(B,D){var C='<div id="'+this.id+"-comment-edit-"+B+'" class="hidden"></div>';var A=B%2===0?"even":"odd";C+='<div class="comment '+A+'" id="'+this.id+"-comment-view-"+B+'">';C+=this.renderCommentView(B,D);C+="</div>";return C},renderCommentView:function t(A,C){var B='<div class="nodeEdit">';if(C.permissions.edit){B+='<div class="onEditComment"><a href="#" class="blogcomment-action">'+this.msg("action.edit")+"</a></div>"}if(C.permissions["delete"]){B+='<div class="onDeleteComment"><a href="#" class="blogcomment-action">'+this.msg("action.delete")+"</a></div>"}B+="</div>";B+='<div class="authorPicture">'+Alfresco.util.people.generateUserAvatarImg(C.author)+"</div>";B+='<div class="nodeContent"><div class="userLink">'+Alfresco.util.people.generateUserLink(C.author);B+=" "+this.msg("comment.said")+":";if(C.isUpdated){B+='<span class="theme-color-2 nodeStatus"> ('+this.msg("comment.updated")+")</span>"}B+="</div>";B+='<div class="content yuieditor">'+C.content+"</div>";B+="</div>";B+='<div class="commentFooter">';B+='<span class="nodeFooterBlock">';B+='<span class="nodeAttrLabel">'+this.msg("comment.postedOn")+": ";B+=Alfresco.util.formatDate(C.createdOn);B+="</span></span></div>";return B},onCommentElementMouseEntered:function y(C,B){var F=B[1].target.id;var A=F.substring((this.id+"-comment-view-").length);var D=this.commentsData[A].permissions;if(!(D.edit||D["delete"])){return}var E=B[1].target;c.addClass(E,"over")},onCommentElementMouseExited:function w(B,A){var C=A[1].target;c.removeClass(C,"over")},_hideEditView:function l(){if(this.editData.editDiv!==null){c.addClass(this.editData.editDiv,"hidden");this.editData.editDiv.innerHTML="";this.editData.editDiv=null}if(this.editData.viewDiv!==null){c.removeClass(this.editData.viewDiv,"hidden");this.editData.viewDiv=null}},_setBusy:function p(A){if(this.busy){return false}this.busy=true;this.widgets.busyMessage=Alfresco.util.PopupManager.displayMessage({text:A,spanClass:"wait",displayTime:0});return true},_releaseBusy:function s(){if(this.busy){this.widgets.busyMessage.destroy();this.busy=false;return true}else{return false}}})})();