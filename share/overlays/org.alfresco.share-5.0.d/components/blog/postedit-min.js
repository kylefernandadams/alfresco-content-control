(function(){var g=YAHOO.util.Dom;Alfresco.BlogPostEdit=function(m){Alfresco.BlogPostEdit.superclass.constructor.call(this,"Alfresco.BlogPostEdit",m,["button","menu","json"]);this.blogPostData=null;this.performExternalPublish=false;return this};YAHOO.extend(Alfresco.BlogPostEdit,Alfresco.component.Base,{options:{siteId:"",containerId:"blog",editMode:false,postId:""},blogPostData:null,performExternalPublish:null,showNotConfiguredMessage:false,onReady:function d(){if(this.options.editMode){this._loadBlogPostData()}else{this._initializeBlogPostForm()}},_loadBlogPostData:function a(){var o=this;var m=function p(q){var r=q.json.item;o.blogPostData=r;o._initializeBlogPostForm()};var n=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/blog/post/site/{site}/{container}/{postId}",{site:this.options.siteId,container:this.options.containerId,postId:this.options.postId});Alfresco.util.Ajax.request({url:n,method:"GET",responseContentType:"application/json",successCallback:{fn:m,scope:this},failureMessage:this.msg("message.loadpostdata.failure")})},_initializeBlogPostForm:function c(){var o,m=true,p="",n="";if(this.options.editMode){o=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/blog/post/node/{nodeRef}",{nodeRef:this.blogPostData.nodeRef.replace(":/","")})}else{o=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/blog/site/{site}/{container}/posts",{site:this.options.siteId,container:this.options.containerId})}g.get(this.id+"-form").setAttribute("action",o);g.get(this.id+"-site").setAttribute("value",this.options.siteId);g.get(this.id+"-container").setAttribute("value",this.options.containerId);if(this.options.editMode){m=this.blogPostData.isDraft}g.get(this.id+"-draft").setAttribute("value",m);if(this.options.editMode){p=this.blogPostData.title}g.get(this.id+"-title").setAttribute("value",p);if(this.options.editMode){n=this.blogPostData.content}g.get(this.id+"-content").value=n;this._registerBlogPostForm()},_registerBlogPostForm:function j(){this.modules.tagLibrary=new Alfresco.module.TagLibrary(this.id);this.modules.tagLibrary.setOptions({siteId:this.options.siteId});if(this.options.editMode&&this.blogPostData.tags.length>0){this.modules.tagLibrary.setTags(this.blogPostData.tags)}this.widgets.saveButton=new YAHOO.widget.Button(this.id+"-save-button",{type:"submit",label:this.msg(this.options.editMode?"action.update":"action.saveAsDraft")});if(!this.options.editMode||this.blogPostData.isDraft){this.widgets.publishButton=Alfresco.util.createYUIButton(this,"publish-button",this.onFormPublishButtonClick);g.removeClass(this.id+"-publish-button","hidden")}this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onFormCancelButtonClick);this.widgets.editor=new Alfresco.util.RichEditor(Alfresco.constants.HTML_EDITOR,this.id+"-content",this.options.editorConfig);this.widgets.editor.addPageUnloadBehaviour(this.msg("message.unsavedChanges.blog"));this.widgets.editor.render();this.widgets.postForm=new Alfresco.forms.Form(this.id+"-form");this.widgets.postForm.addValidation(this.id+"-title",Alfresco.forms.validation.mandatory,null,"blur");this.widgets.postForm.addValidation(this.id+"-title",Alfresco.forms.validation.length,{max:256,crop:true},"keyup");if(this.widgets.publishButton){this.widgets.postForm.setSubmitElements([this.widgets.saveButton,this.widgets.publishButton])}else{this.widgets.postForm.setSubmitElements([this.widgets.saveButton])}this.widgets.postForm.setAJAXSubmit(true,{successCallback:{fn:this.onFormSubmitSuccess,scope:this},failureMessage:this.msg("message.savepost.failure"),failureCallback:{fn:this.onFormSubmitFailure,scope:this}});if(this.options.editMode){this.widgets.postForm.setAjaxSubmitMethod(Alfresco.util.Ajax.PUT)}this.widgets.postForm.setSubmitAsJSON(true);this.widgets.postForm.doBeforeFormSubmit={fn:function(m,n){this.widgets.editor.save();this.widgets.cancelButton.set("disabled",true);this.modules.tagLibrary.updateForm(this.id+"-form","tags");this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message(this.msg("message.submitting")),spanClass:"wait",displayTime:0})},scope:this};this.modules.tagLibrary.initialize(this.widgets.postForm);this.widgets.postForm.init();g.removeClass(this.id+"-div","hidden");g.get(this.id+"-title").focus()},onFormPublishButtonClick:function e(n,m){g.get(this.id+"-draft").setAttribute("value",false);this.widgets.saveButton.fireEvent("click",{type:"click"})},onFormCancelButtonClick:function b(n,m){history.go(-1)},onFormSubmitSuccess:function k(n){this.widgets.feedbackMessage.destroy();if(this.performExternalPublish){this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message(this.msg("message.postSavedNowPublish")),spanClass:"wait",displayTime:0});this.showNotConfiguredMessage=!n.json.metadata.externalBlogConfig;var m=n.json.item.name;if(n.json.item.isPublished){this.onUpdateExternal(m)}else{this.onPublishExternal(m)}}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.savepost.success")});this._loadPostViewPage(n.json.item.name)}},onFormSubmitFailure:function l(){this.widgets.cancelButton.set("disabled",false);this.widgets.feedbackMessage.destroy()},onPublishExternal:function f(m){var q=function n(t){this._loadPostViewPage(m)};var r=function s(t){this.widgets.feedbackMessage.destroy();var u=this;Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.publishExternal.failure"),buttons:[{text:this.msg("button.ok"),handler:function(){u._loadPostViewPage(m)},isDefault:true}]})};var o=Alfresco.util.blog.generatePublishingRestURL(this.options.siteId,this.options.containerId,m);var p=this.msg("message.savepost.success");if(this.showNotConfiguredMessage){p=this.msg("message.publishExternal.failure")}Alfresco.util.Ajax.request({url:o,method:"POST",requestContentType:"application/json",responseContentType:"application/json",dataObj:{action:"publish"},successMessage:p,successCallback:{fn:q,scope:this},failureCallback:{fn:r,scope:this}})},onUpdateExternal:function i(m){var o=function r(s){this._loadPostViewPage(m)};var q=function p(s){this.widgets.feedbackMessage.destroy();var t=this;Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.updateExternal.failure"),buttons:[{text:this.msg("button.ok"),handler:function(){t._loadPostViewPage(m)},isDefault:true}]})};var n=Alfresco.util.blog.generatePublishingRestURL(this.options.siteId,this.options.containerId,m);Alfresco.util.Ajax.request({url:n,method:"POST",requestContentType:"application/json",responseContentType:"application/json",dataObj:{action:"update"},successMessage:this.msg("message.updateExternal.success"),successCallback:{fn:o,scope:this},failureCallback:{fn:q,scope:this}})},_loadPostViewPage:function h(m){window.location=Alfresco.util.blog.generateBlogPostViewUrl(this.options.siteId,this.options.containerId,m)}})})();