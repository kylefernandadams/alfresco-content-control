(function(){var e=YAHOO.util.Dom,d=YAHOO.util.Event;var a=Alfresco.util.encodeHTML;Alfresco.WikiCreateForm=function(g){Alfresco.WikiCreateForm.superclass.constructor.call(this,"Alfresco.WikiCreateForm",g,["button","container","connection","editor"]);return this};YAHOO.extend(Alfresco.WikiCreateForm,Alfresco.component.Base,{options:{siteId:"",locale:""},_showUnloadDialog:true,onReady:function f(){this.tagLibrary=new Alfresco.module.TagLibrary(this.id);this.tagLibrary.setOptions({siteId:this.options.siteId});this.widgets.editor=Alfresco.util.createImageEditor(this.id+"-content",{height:300,toolbar:"styleselect | bold italic | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview fullscreen | alfresco-imagelibrary alfresco-linklibrary",extended_valid_elements:"style[type]",valid_children:"+body[style]",siteId:this.options.siteId,language:this.options.locale});var j=this;var g=function(){return j._showUnloadDialog};this.widgets.editor.addPageUnloadBehaviour(this.msg("message.unsavedChanges.wiki"),g);this.widgets.editor.render();this.widgets.saveButton=new YAHOO.widget.Button(this.id+"-save-button",{type:"submit"});Alfresco.util.createYUIButton(this,"cancel-button",null,{type:"link"});this.widgets.form=new Alfresco.forms.Form(this.id+"-form");var h=this.widgets.form;h.addValidation(this.id+"-title",Alfresco.forms.validation.mandatory,null,"blur");h.addValidation(this.id+"-title",Alfresco.forms.validation.wikiTitle,null,"keyup");h.addValidation(this.id+"-title",Alfresco.forms.validation.length,{max:256,crop:true},"keyup");h.setSubmitElements(this.widgets.saveButton);h.setAJAXSubmit(true,{successCallback:{fn:this.onPageCreated,scope:this},failureCallback:{fn:this.onPageCreateFailed,scope:this}});h.setSubmitAsJSON(true);h.setAjaxSubmitMethod(Alfresco.util.Ajax.PUT);h.doBeforeFormSubmit={fn:function i(l,m){this.widgets.saveButton.set("disabled",true);this.widgets.editor.save();this.tagLibrary.updateForm(this.id+"-form","tags");var k=e.get(this.id+"-tag-input-field");if(k){k.disabled=true}var n=e.get(this.id+"-title").value;n=n.replace(/\s+/g,"_");l.action=Alfresco.constants.PROXY_URI+"slingshot/wiki/page/"+this.options.siteId+"/"+Alfresco.util.encodeURIPath(n);this.widgets.savingMessage=Alfresco.util.PopupManager.displayMessage({displayTime:0,text:'<span class="wait">'+a(this.msg("message.saving"))+"</span>",noEscape:true})},scope:this};this.tagLibrary.initialize(h);h.init();e.get(this.id+"-title").focus()},onPageCreated:function c(h){var i="Main_Page";var g=YAHOO.lang.JSON.parse(h.serverResponse.responseText);if(g){i=g.title}this._showUnloadDialog=false;window.location=Alfresco.constants.URL_PAGECONTEXT+"site/"+this.options.siteId+"/wiki-page?title="+encodeURIComponent(i)},onPageCreateFailed:function b(j){if(this.widgets.savingMessage){this.widgets.savingMessage.destroy();this.widgets.savingMessage=null}var i=j.config.dataObj.pageTitle;var h=this;if(j.serverResponse.status===409){Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.failure.title"),text:this.msg("message.failure.duplicate",i),buttons:[{text:this.msg("button.ok"),handler:function(){this.destroy();e.get(h.id+"-title").focus()},isDefault:true}]})}else{if(j.serverResponse.status==401){Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.sessionTimeout.title"),text:this.msg("message.sessionTimeout.text")})}else{Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.failure"),text:j.json.message})}}var g=e.get(this.id+"-tag-input-field");if(g){g.disabled=false}}})})();