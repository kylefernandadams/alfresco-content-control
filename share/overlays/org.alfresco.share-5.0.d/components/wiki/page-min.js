(function(){var h=YAHOO.util.Dom,m=YAHOO.util.Event,c=YAHOO.util.Element;var f=Alfresco.util.encodeHTML;Alfresco.WikiPage=function(p){Alfresco.WikiPage.superclass.constructor.call(this,"Alfresco.WikiPage",p,["button","container","connection","editor","tabview"]);this.selectedTags=[];this.parser=new Alfresco.WikiParser();return this};YAHOO.extend(Alfresco.WikiPage,Alfresco.component.Base,{selectedTags:null,parser:null,forceSave:false,savingPagePopup:null,options:{siteId:"",pageTitle:"",mode:"view",error:false,tags:[],pages:[],versions:[],permissions:{},locale:""},onReady:function a(){if(this.options.error){YAHOO.Bubbling.fire("deactivateAllControls");return}if(this.options.mode==="edit"){this._setupEditForm()}else{if(this.options.mode==="details"){this._setupPageDetails()}}document.title+=f(" \u00BB "+this.options.pageTitle);var p=h.get(this.id+"-page");if(p){this.parser.URL=this._getAbsolutePath();p.innerHTML=this.parser.parse(p.innerHTML,this.options.pages)}YAHOO.Bubbling.fire("userAccess",{userAccess:this.options.permissions})},_setupPageDetails:function i(){var p=this.options.versions;if(p.length>0){this.widgets.versionSelect=Alfresco.util.createYUIButton(this,"selectVersion-button",this.onVersionSelectChange,{type:"menu",menu:"selectVersion-menu"})}var r,v,t,q,s;for(v=0,t=p.length;v<t;v++){var u=h.get(this.id+"-revert-span-"+v);if(u){m.addListener(u,"click",function(w,x){r=p[x.versionIndex];Alfresco.module.getRevertWikiVersionInstance().show({siteId:x.siteId,pageTitle:x.pageTitle,version:r.label,versionId:r.versionId,onRevertWikiVersionComplete:{fn:this.onRevertWikiVersionComplete,scope:this}})},{siteId:this.options.siteId,pageTitle:this.options.pageTitle,versionIndex:v},this)}q=h.get(this.id+"-expand-div-"+v);s=h.get(this.id+"-moreVersionInfo-div-"+v);if(q){m.addListener(q,"click",function(w,x){if(x.moreVersionInfoDiv&&h.hasClass(x.expandDiv,"collapsed")){Alfresco.util.Anim.fadeIn(x.moreVersionInfoDiv);h.removeClass(x.expandDiv,"collapsed");h.addClass(x.expandDiv,"expanded")}else{h.setStyle(x.moreVersionInfoDiv,"display","none");h.removeClass(x.expandDiv,"expanded");h.addClass(x.expandDiv,"collapsed")}},{expandDiv:q,moreVersionInfoDiv:s},this)}h.get(this.id+"-createdDate-span-"+v).innerHTML=Alfresco.util.formatDate(Alfresco.thirdparty.fromISO8601(p[v].createdDate),this.msg("date-format.longDate"))}},onRevertWikiVersionComplete:function e(){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.revertComplete",this.name)});window.location.reload()},_setupEditForm:function g(){var q=h.get(this.id+"-form").offsetWidth-400;var p=YAHOO.env.ua.ie>0?document.body.clientHeight:document.height;this.tagLibrary=new Alfresco.module.TagLibrary(this.id);this.tagLibrary.setOptions({siteId:this.options.siteId});if(this.options.tags.length>0){this.tagLibrary.setTags(this.options.tags)}var t=new YAHOO.widget.Button(this.id+"-save-button",{type:"submit"});Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelSelect);var s=this;this.pageEditor=Alfresco.util.createImageEditor(this.id+"-content",{height:300,toolbar:"styleselect | bold italic | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | print preview fullscreen | alfresco-imagelibrary alfresco-linklibrary",extended_valid_elements:"style[type]",valid_children:"+body[style]",siteId:this.options.siteId,language:this.options.locale,init_instance_callback:function(u){YAHOO.Bubbling.fire("editorInitialized",u);s.pageEditor.addSaveKeyBehaviour(function(w,v){m.stopEvent(v[1]);t.fireEvent("click",{type:"click"})})}});this.pageEditor.addPageUnloadBehaviour(this.msg("message.unsavedChanges.wiki"));this.pageEditor.render();var r=new Alfresco.forms.Form(this.id+"-form");r.setSubmitElements(t);r.setAJAXSubmit(true,{successCallback:{fn:this.onPageUpdated,scope:this},failureCallback:{fn:function(y,x){if(this.savingPagePopup){this.savingPagePopup.destroy();this.savingPagePopup=null}if(y.serverResponse.status==409){var w=this;Alfresco.util.PopupManager.displayPrompt({text:this.msg("message.confirm.newerVersion"),buttons:[{text:this.msg("button.savechanges"),handler:function u(){this.destroy();w.forceSave=true;t.fireEvent("click",{type:"click"})}},{text:this.msg("button.cancel"),handler:function v(){this.destroy()},isDefault:true}]})}else{if(y.serverResponse.status==401){Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.sessionTimeout.title"),text:this.msg("message.sessionTimeout.text")})}else{Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.failure"),text:y.json.message})}}},scope:this,obj:r},noReloadOnAuthFailure:true});r.setSubmitAsJSON(true);r.setAjaxSubmitMethod(Alfresco.util.Ajax.PUT);r.doBeforeFormSubmit={fn:function(v,w){this.savingPagePopup=Alfresco.util.PopupManager.displayMessage({displayTime:0,text:'<span class="wait">'+f(this.msg("message.saving",this.name))+"</span>",noEscape:true});this.pageEditor.save();this.tagLibrary.updateForm(this.id+"-form","tags");var u=h.get(this.id+"-tag-input-field");if(u){u.disabled=true}},scope:this};r.doBeforeAjaxRequest={fn:function(u,v){if(this.forceSave){this.forceSave=false;u.dataObj.forceSave=true}return true},scope:this};this.tagLibrary.initialize(r);r.init();YAHOO.Bubbling.on("onTagLibraryTagsChanged",this.onTagLibraryTagsChanged,this)},onTagLibraryTagsChanged:function l(q,p){this.selectedTags=p[1].tags},onVersionSelectChange:function n(t,s,r){var p=s[1].value;var q=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/wiki/version/{site}/{title}/{version}",{site:this.options.siteId,title:encodeURIComponent(this.options.pageTitle),version:p});Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.GET,url:q,successCallback:{fn:this.onVersionInfo,scope:this,obj:{index:s[1].index}},failureMessage:"Could not retrieve version information"})},onVersionInfo:function d(r,t){var s=h.get(this.id+"-page");s.innerHTML=this.parser.parse(r.serverResponse.responseText,this.options.pages);var q=h.get(this.id+"-version-header");if(q){q.innerHTML=this.msg("label.shortVersion",this.name)+this.options.versions[t.index].label}var p=this.options.versions[t.index].label;if(t.index==0){p+=" ("+this.msg("label.latest")+")"}this.widgets.versionSelect.set("label",p)},_getAbsolutePath:function k(){return Alfresco.constants.URL_PAGECONTEXT+"site/"+this.options.siteId+"/"+Alfresco.constants.PAGEID+"?title="},onCancelSelect:function o(p){this.pageEditor.clearDirtyFlag();this._redirect()},onPageUpdated:function b(p){this.pageEditor.clearDirtyFlag();this._redirect()},_redirect:function j(){var p=this._getAbsolutePath()+encodeURIComponent(this.options.pageTitle);window.location=p}})})();