(function(){var c=YAHOO.util.Dom,n=YAHOO.util.Selector,v=YAHOO.util.Event;var m=Alfresco.util.encodeHTML,s=Alfresco.util.hasEventInterest;Alfresco.RuleConfigCondition=function(w){Alfresco.RuleConfigCondition.superclass.constructor.call(this,w);this.name="Alfresco.RuleConfigCondition";Alfresco.util.ComponentManager.reregister(this);this.options=YAHOO.lang.merge(this.options,Alfresco.RuleConfigCondition.superclass.options);this.customisations=YAHOO.lang.merge(this.customisations,Alfresco.RuleConfigCondition.superclass.customisations);this.renderers=YAHOO.lang.merge(this.renderers,Alfresco.RuleConfigCondition.superclass.renderers);this.previousConfigNameSelections={};YAHOO.Bubbling.on("rulePropertySettingsChanged",this.onRulePropertySettingsChanged,this);return this};YAHOO.extend(Alfresco.RuleConfigCondition,Alfresco.RuleConfig,{previousConfigNameSelections:{},options:{properties:[],transientPropertyTypes:{"d:content":{SIZE:"d:long",ENCODING:"d:any",MIME_TYPE:"d:any"}},comparePropertyValueDefinition:{},compareMimeTypeDefinition:{}},onReady:function r(){if(this.options.properties.length>0){this._handleTransientProperties(this.options.properties)}return Alfresco.RuleConfigCondition.superclass.onReady.call(this)},setOptions:function o(w){this._handleTransientProperties(this.options.properties);return Alfresco.RuleConfigCondition.superclass.setOptions.call(this,w)},displayRuleConfigs:function i(x){var y,F,C,G=this.options.properties,z=[],J={},I,w;for(var E=0,H=(x?x.length:0);E<H;E++){y=x[E];if(this._isComparePropertyDefinition(y[this.options.ruleConfigDefinitionKey])&&y.parameterValues){F=y.parameterValues.property;if(F){if(y.parameterValues["content-property"]){C=F+":"+y.parameterValues["content-property"]}else{C=null}I=false;w=false;for(var B=0,D=G.length;B<D;B++){if(G[B].name==F){I=true}if(G[B].name==C){w=true}}if(w||(!C&&I)){}else{z.push(F);var A=J[F];if(!A){A=[];J[F]=A}A.push(C?C:F)}}}}if(z.length==0){Alfresco.RuleConfigCondition.superclass.displayRuleConfigs.call(this,x)}else{Alfresco.util.Ajax.jsonGet({url:Alfresco.constants.PROXY_URI_RELATIVE+"api/properties?name="+z.join("&name="),successCallback:{fn:function(M,T){var N=M.json,S,O,K;for(var P=0,L=N.length;P<L;P++){S=N[P];O=T[S.name];for(var R=0,Q=O.length;R<Q;R++){K=Alfresco.util.deepCopy(S);K._hidden=true;if(O[R]!=K.name){K.name=O[R];K=this._handleTransientProperty(K)}this.options.properties.push(K)}}this.widgets.selectTemplateEl=this._createSelectMenu();Alfresco.RuleConfigCondition.superclass.displayRuleConfigs.call(this,x)},obj:J,scope:this},failureMessage:this.msg("message.getPropertiesFailure")})}},onRulePropertySettingsChanged:function b(P,z){var y=z[1];if(y){var O=this._handleTransientProperty(y.property.item);var N=y.state==Alfresco.module.RulesPropertyPicker.PROPERTY_SHOW;for(var L=0,G=this.options.properties.length,D;L<G;L++){D=this.options.properties[L];if(D.name==O.name){D._hidden=!N;break}}if(L==G&&N){this.options.properties.push(O)}this.widgets.selectTemplateEl=this._createSelectMenu();var x=n.query("li.config",this.id+"-body"),w,K;for(var H=0,A=x.length;H<A;H++){w=x[H];K=n.query("select",w)[0];for(var J=0,M=K.options.length,I;J<M;J++){I=K.options[J];if(this._isComparePropertyDefinition(I.value)&&I.getAttribute("rel")=="property_"+O.name){if(!I.selected){if(!N){I.parentNode.removeChild(I);this._selectPreviousConfigName(K)}}break}}if(N&&J==M){var F=K.options[K.selectedIndex],C=F.value,E=F.getAttribute("rel");var B=this.widgets.selectTemplateEl.cloneNode(true);this.previousConfigNameSelections[Alfresco.util.generateDomId(B)]=this.previousConfigNameSelections[K.getAttribute("id")];K.parentNode.removeChild(K);v.addListener(B,"change",this.onConfigNameSelectChange,w,this);n.query("div.name",w)[0].appendChild(B);this._selectConfigName(B,C,E)}}}},_getConfigItems:function g(C,z,A){if(C=="property"){var y=[];for(var x=0,w=this.options.properties.length,B;x<w;x++){B=this.options.properties[x];if(!B._hidden||A){if(Alfresco.util.objectMatchesPattern(B,z)){y.push(this._createPropertyConfigDef(B))}}}return y}return Alfresco.RuleConfigCondition.superclass._getConfigItems.call(this,C,z)},_getConstraintValues:function a(A,B){if(this._isComparePropertyDefinition(B[this.options.ruleConfigDefinitionKey])){var x=B.parameterValues.property,C=B.parameterValues["content-property"];if(C){x+=":"+C}var z;for(var y=0,w=this.options.properties.length;y<w;y++){if(this.options.properties[y].name==x){z=this.options.properties[y].dataType;break}}A._constraintFilter=z}return Alfresco.RuleConfigCondition.superclass._getConstraintValues.call(this,A,B)},_createPropertyConfigDef:function h(y){var z,x=y.name.split(":");if(x.length==3){if(x[2]=="MIME_TYPE"){z=Alfresco.util.deepCopy(this.options.compareMimeTypeDefinition);this._getParamDef(z,"property")._type="hidden"}}if(!z){z=Alfresco.util.deepCopy(this.options.comparePropertyValueDefinition);this._getParamDef(z,"property")._type="hidden";this._getParamDef(z,"content-property")._type="hidden";this._getParamDef(z,"operation").displayLabel="";this._getParamDef(z,"operation").isMandatory=true;this._getParamDef(z,"value").displayLabel="";this._getParamDef(z,"value").type=y.dataType;z.parameterDefinitions.reverse()}if(x.length==3&&x[2]=="SIZE"){this._getParamDef(z,"value")._unit=this.msg("label.sizeUnit")}var w={id:z.name,type:"property_"+y.name,label:y.title?y.title:y.name,descriptor:z};return w},_createConfigUI:function j(A,D,x){var B=A[this.options.ruleConfigDefinitionKey];if(this._isComparePropertyDefinition(B)&&!D){var w=false,E=this.options.properties,G,C=A.parameterValues.property,y=A.parameterValues["content-property"];C+=y?":"+y:"";for(var z=0,F=E.length;z<F;z++){G=E[z];if(G.name==C){w=G._hidden;break}}if(w){D=this._createSelectMenu(G)}else{}}return Alfresco.RuleConfigCondition.superclass._createConfigUI.call(this,A,D,x)},_createRuleConfig:function l(x){var y=x.split(":"),w=y[0]+":"+y[1],A=y.length==3?y[2]:null;var z={parameterValues:{property:w}};z[this.options.ruleConfigDefinitionKey]=this.options.comparePropertyValueDefinition.name;if(A){z.parameterValues["content-property"]=A;if(A=="MIME_TYPE"){z[this.options.ruleConfigDefinitionKey]=this.options.compareMimeTypeDefinition.name}}return z},onConfigNameSelectChange:function p(C,y){var D=v.getTarget(C),x=D.options[D.selectedIndex],A=D.getAttribute("id");if(!A){A=Alfresco.util.generateDomId(D)}var B=this.previousConfigNameSelections[A];if(!B){B=[{},{}];this.previousConfigNameSelections[A]=B}if(B[0].value!=x.value||B[0].rel!=x.getAttribute("rel")){B[1]=B[0];B[0]={rel:x.getAttribute("rel"),value:x.value}}if(this._isComparePropertyDefinition(x.value)){var w=x.getAttribute("rel").substring("property".length+1),z=this._createRuleConfig(w);this._createConfigParameterUI(z,y)}else{Alfresco.RuleConfigCondition.superclass.onConfigNameSelectChange.call(this,C,y)}},_createConfigNameUI:function f(B,w,A){var z=Alfresco.RuleConfigCondition.superclass._createConfigNameUI.call(this,B,w,A);var y=B[this.options.ruleConfigDefinitionKey];if(this._isComparePropertyDefinition(y)){var x=B.parameterValues.property;if(y==this.options.compareMimeTypeDefinition.name){x+=":MIME_TYPE"}else{if(B.parameterValues["content-property"]){x+=":"+B.parameterValues["content-property"]}}this._selectConfigName(w,y,"property_"+x)}return z},_selectConfigName:function d(w,A,B){for(var y=0,z=w.options.length;y<z;y++){if(w.options[y].value==A&&(!B||w.options[y].getAttribute("rel")==B)){w.selectedIndex=y;if(this.options.mode==Alfresco.RuleConfig.MODE_TEXT){var x=w.parentNode.getElementsByTagName("span")[0];x.innerHTML=m(w.options[w.selectedIndex].text)}break}}if(y==z){w.selectedIndex=0}},_selectPreviousConfigName:function k(y){var x=this.previousConfigNameSelections[y.getAttribute("id")],w=x&&x.length>1?x[1]:null;if(w&&w.value){this._selectConfigName(y,w.value,w.rel)}else{y.selectedIndex=0}},_getConfigCustomisation:function q(x,w){if(this._isComparePropertyDefinition(w.name)){x="property"}return Alfresco.RuleConfigCondition.superclass._getConfigCustomisation.call(this,x,w)},_isComparePropertyDefinition:function u(w){return(w==this.options.comparePropertyValueDefinition.name||w==this.options.compareMimeTypeDefinition.name)},_handleTransientProperties:function t(y){if(YAHOO.lang.isArray(y)){for(var x=0,w=y.length;x<w;x++){y[x]=this._handleTransientProperty(y[x])}}},_handleTransientProperty:function e(z){var y=z.name.split(":");if(!z._transientHandled&&y.length==3){if(!z.title){var B=[];if(z.dataType=="d:content"){B=this.options.constraints["ac-content-properties"]}for(var x=0,w=B.length,A;x<w;x++){A=B[x];if(A.value==y[2]){z.title=this.msg("label.transientProperty",A.displayLabel,y[0]+":"+y[1])}}}if(this.options.transientPropertyTypes[z.dataType]){z.dataType=this.options.transientPropertyTypes[z.dataType][y[2]]}z._transientHandled=true}return z},customisations:{HasAspect:{edit:function(z,y,x){var w=this._getParamDef(z,"aspect");w._constraintFilter="visible";w.displayLabel=null;return z}},IsSubType:{edit:function(y,x,w){var z=this._getParamDef(y,"type");z._constraintFilter="visible";z.displayLabel=this.msg("label.is");z._hideColon=true;return y}},InCategory:{text:function(y,x,w){this._getParamDef(y,"category-value")._type="category";return y},edit:function(y,x,w){this._hideParameters(y.parameterDefinitions);this._setParameter(x,"category-aspect","cm:generalclassifiable");y.parameterDefinitions.push({type:"arcc:category-picker"});return y}},HasTag:{edit:function(y,x,w){this._hideParameters(y.parameterDefinitions);y.parameterDefinitions.push({type:"arcc:tag-picker"});return y}},ComparePropertyValue:{text:function(z,y,x){var w=this._getParamDef(z,"value");if(Alfresco.util.arrayContains(["d:any","d:text","d:mltext"],w.type)){z._customMessageKey="customise.compare-property-value.text.hyphen"}return z}},CompareMimeType:{edit:function(z,y,x){var w=this._getParamDef(z,"value");w.displayLabel=this.msg("label.is");w._hideColon=true;return z}},ShowMore:{manual:{edit:true},currentCtx:{},edit:function(x,y,w,z){this.customisations.ShowMore.currentCtx={configEl:w};if(!this.widgets.showMoreDialog){this.widgets.showMoreDialog=new Alfresco.module.RulesPropertyPicker(this.id+"-showMoreDialog");YAHOO.Bubbling.on("dataItemSelected",function(E,I){if(s(this.widgets.showMoreDialog,I)){var H=this.options.properties,K=this._handleTransientProperty(I[1].selectedItem.item);K._hidden=true;for(var D=0,J=H.length;D<J;D++){if(H[D].name==K.name){break}}if(D==J){H.push(K)}var F=this.customisations.ShowMore.currentCtx.configEl,C=this._createSelectMenu(K.name),A=n.query("select",F)[0];this.previousConfigNameSelections[Alfresco.util.generateDomId(C)]=this.previousConfigNameSelections[A.getAttribute("id")];var B=this._createRuleConfig(K.name);var G=this._createConfigNameUI(B,C,F);this.customisations.ShowMore.currentCtx.configEl=G;F.parentNode.removeChild(F);this._createConfigParameterUI(B,G)}},this);YAHOO.Bubbling.on("dataItemSelectionCancelled",function(B,A){if(s(this.widgets.showMoreDialog,A)){var C=this.customisations.ShowMore.currentCtx.configEl;this._selectPreviousConfigName(n.query("select",C)[0])}},this)}this.widgets.showMoreDialog.showDialog();return null}}},renderers:{"arcc:category-picker":{currentCtx:{},edit:function(B,A,x,y,z){this.renderers["arcc:category-picker"].currentCtx={configDef:A,ruleConfig:y,paramDef:x};var w=new Alfresco.module.ControlWrapper(Alfresco.util.generateDomId());w.setOptions({type:"category",container:B,value:y.parameterValues["category-value"],controlParams:{multipleSelectMode:false},fnValueChanged:{fn:function(D){var C=this.renderers["arcc:category-picker"].currentCtx;this._setHiddenParameter(C.configDef,C.ruleConfig,"category-value",D.selectedItems[0]);this._updateSubmitElements(C.configDef)},scope:this}});w.render()}},"arcc:tag-picker":{currentCtx:{},edit:function(C,B,y,z,A){this.renderers["arcc:tag-picker"].currentCtx={configDef:B,ruleConfig:z,paramDef:y};var x=function(G,F){var E=new Alfresco.module.ControlWrapper(Alfresco.util.generateDomId());var D={type:"tag",container:G,controlParams:{multipleSelectMode:false},fnValueChanged:{fn:function(K){var I=this.renderers["arcc:tag-picker"].currentCtx,J=K.selectedItems[0],H=K.selectedItemsMetaData[J].name;this._setHiddenParameter(I.configDef,I.ruleConfig,"tag",H);this._updateSubmitElements(I.configDef)},scope:this}};if(F){D.value=F}E.setOptions(D);E.render()};var w=z.parameterValues?z.parameterValues.tag:null;if(!w){x.call(this,C,null)}else{Alfresco.util.Ajax.jsonPost({url:Alfresco.constants.PROXY_URI_RELATIVE+"api/tag/workspace/SpacesStore",dataObj:{name:z.parameterValues.tag},successCallback:{fn:function(D,E){E.onNodeRefTagLoaded.call(this,E.containerEl,D.json.nodeRef)},scope:this,obj:{containerEl:C,onNodeRefTagLoaded:x}},failureMessage:this.msg("message.getTagFailure")})}}}}})})();