(function(){var d=YAHOO.util.Dom,c=YAHOO.util.Selector,b=YAHOO.util.Event;var a=Alfresco.util.encodeHTML,e=Alfresco.util.hasEventInterest;Alfresco.RuleConfigAction=function(f){Alfresco.RuleConfigAction.superclass.constructor.call(this,f);this.name="Alfresco.RuleConfigAction";Alfresco.util.ComponentManager.reregister(this);this.customisations=YAHOO.lang.merge(this.customisations,Alfresco.RuleConfigAction.superclass.customisations);this.renderers=YAHOO.lang.merge(this.renderers,Alfresco.RuleConfigAction.superclass.renderers);return this};YAHOO.extend(Alfresco.RuleConfigAction,Alfresco.RuleConfig,{customisations:{SetPropertyValue:{edit:function(h,g,f){this._hideParameters(h.parameterDefinitions);h.parameterDefinitions.splice(1,1,{type:"arca:set-property-value",_buttonLabel:this.msg("button.select-folder"),_destinationParam:"_property"});return h}},SpecialiseType:{edit:function(h,g,f){this._getParamDef(h,"type-name")._constraintFilter="changeable";return h}},AddFeatures:{edit:function(i,h,g){var f=this._getParamDef(i,"aspect-name");f._constraintFilter="addable";f.displayLabel=null;return i}},RemoveFeatures:{edit:function(i,h,g){var f=this._getParamDef(i,"aspect-name");f._constraintFilter="removeable";f.displayLabel=null;return i}},Script:{edit:function(h,g,f){this._getParamDef(h,"script-ref").displayLabel=null;return h}},Select:{edit:function(h,g,f){h.parameterDefinitions=[{name:"mandatory",type:"d:text",isMandatory:true,isMultiValued:false,displayLabel:this.msg("label.selectAnAction"),_type:"hidden"}];return h}},Mail:{edit:function(h,g,f){this._hideParameters(h.parameterDefinitions);h.parameterDefinitions.push({type:"arca:email-dialog-button",_buttonLabel:this.msg("button.message")});return h}},CheckIn:{text:function(h,g,f){g.parameterValues=g.parameterValues||{};if(g.parameterValues.minorChange){g.parameterValues.minorChange=this.msg("label.checkin.minor")}else{g.parameterValues.minorChange=this.msg("label.checkin.major")}this._getParamDef(h,"minorChange").type="d:text";return h},edit:function(h,g,f){this._hideParameters(h.parameterDefinitions);h.parameterDefinitions.push({type:"arca:checkin-dialog-button",_buttonLabel:this.msg("button.options")});return h}},Checkout:{text:function(h,g,f){this._getParamDef(h,"destination-folder")._type="path";return h},edit:function(h,g,f){this._hideParameters(h.parameterDefinitions);this._setParameter(g,"assoc-type","cm:contains");this._setParameter(g,"assoc-name","cm:checkout");h.parameterDefinitions.push({type:"arca:destination-dialog-button",displayLabel:this.msg("label.workingCopyLocation"),_buttonLabel:this.msg("button.select-folder"),_destinationParam:"destination-folder"});return h}},Copy:{text:function(h,g,f){this._getParamDef(h,"destination-folder")._type="path";if(g.parameterValues&&g.parameterValues["deep-copy"]){h._customMessageKey="customise.copy.deep.text"}return h},edit:function(i,h,g){this._hideParameters(i.parameterDefinitions);i.parameterDefinitions.splice(0,0,{type:"arca:destination-dialog-button",displayLabel:this.msg("label.to"),_buttonLabel:this.msg("button.select-folder"),_destinationParam:"destination-folder"});var f=this._getParamDef(i,"deep-copy");f._type=null;f._displayLabelToRight=true;f._hideColon=true;return i}},Move:{text:function(h,g,f){this._getParamDef(h,"destination-folder")._type="path";return h},edit:function(h,g,f){this._hideParameters(h.parameterDefinitions);h.parameterDefinitions.splice(0,0,{type:"arca:destination-dialog-button",displayLabel:this.msg("label.to"),_buttonLabel:this.msg("button.select-folder"),_destinationParam:"destination-folder"});return h}},SimpleWorkflow:{text:function(h,g,f){this._getParamDef(h,"approve-folder")._type="path";this._getParamDef(h,"approve-move").type="d:text";if(g.parameterValues["approve-move"]==true){g.parameterValues["approve-move"]=this.msg("label.workflow.moves")}else{g.parameterValues["approve-move"]=this.msg("label.workflow.copies")}if(g.parameterValues&&g.parameterValues["reject-step"]){h._customMessageKey="customise.simple-workflow.full.text";this._getParamDef(h,"reject-folder")._type="path";this._getParamDef(h,"reject-move").type="d:text";if(g.parameterValues["reject-move"]==true){g.parameterValues["reject-move"]=this.msg("label.workflow.moves")}else{g.parameterValues["reject-move"]=this.msg("label.workflow.copies")}}return h},edit:function(h,g,f){this._hideParameters(h.parameterDefinitions);this._getParamDef(h,"approve-step").isMandatory=true;this._getParamDef(h,"approve-folder").isMandatory=true;this._getParamDef(h,"approve-move").isMandatory=true;this._getParamDef(h,"reject-step").isMandatory=true;this._getParamDef(h,"reject-folder").isMandatory=true;this._getParamDef(h,"reject-move").isMandatory=true;h.parameterDefinitions.push({type:"arca:simple-workflow-dialog-button",_buttonLabel:this.msg("button.approve"),_mode:Alfresco.module.RulesWorkflowAction.VIEW_MODE_APPROVAL_STEP});h.parameterDefinitions.push({type:"arca:simple-workflow-dialog-button",_buttonLabel:this.msg("button.reject"),_mode:Alfresco.module.RulesWorkflowAction.VIEW_MODE_REJECTION_STEP});return h}},LinkCategory:{text:function(h,g,f){this._getParamDef(h,"category-value")._type="category";return h},edit:function(h,g,f){this._hideParameters(h.parameterDefinitions);h.parameterDefinitions.push({type:"arca:category-picker"});return h}},Transform:{text:function(h,g,f){this._getParamDef(h,"destination-folder")._type="path";return h},edit:function(h,g,f){this._hideParameters(h.parameterDefinitions);this._getParamDef(h,"mime-type")._type=null;this._setParameter(g,"assoc-type","cm:contains");this._setParameter(g,"assoc-name","cm:copy");h.parameterDefinitions.push({type:"arca:destination-dialog-button",displayLabel:this.msg("label.to"),_buttonLabel:this.msg("button.select-folder"),_destinationParam:"destination-folder"});return h}},Import:{text:function(h,g,f){this._getParamDef(h,"destination")._type="path";return h},edit:function(h,g,f){this._hideParameters(h.parameterDefinitions);h.parameterDefinitions.push({type:"arca:destination-dialog-button",displayLabel:this.msg("label.to"),_buttonLabel:this.msg("button.select-folder"),_destinationParam:"destination"});return h}}},renderers:{"arca:set-property-value":{manual:{edit:true},currentCtx:{},edit:function(k,g,o,i,n){this.renderers["arca:set-property-value"].currentCtx={configDef:g,ruleConfig:i,paramDef:o};var q=new Alfresco.module.PropertyPicker(this.id+"-selectSetPropertyDialog").setOptions({tabs:[{id:"properties",treeNodes:[{id:"all",listItems:{url:"{url.proxy}api/properties?type=d:text&type=d:mltext&type=d:int&type=d:long&type=d:float&type=d:double&type=d:date&type=d:boolean&type=d:qname",dataModifier:function(u,t){return this._addTransientProperties(u)},id:"{item.name}",type:"{item.dataType}",label:"{item.title}",title:"{item.name}"}},{id:"aspects",treeNodes:{url:"{url.proxy}api/classes?cf=aspect",id:"{node.name}",title:"{node.name}",label:"{node.title}",listItems:{url:"{url.proxy}api/classes/{node.name}/properties?type=d:text&type=d:mltext&type=d:int&type=d:long&type=d:float&type=d:double&type=d:date&type=d:boolean&type=d:qname",dataModifier:function(u,t){return this._addTransientProperties(u)},id:"{item.name}",type:"{item.dataType}",label:"{item.title}",title:"{item.name}"}}},{id:"types",treeNodes:{url:"{url.proxy}api/classes?cf=type",id:"{node.name}",title:"{node.name}",label:"{node.title}",listItems:{url:"{url.proxy}api/classes/{node.name}/properties?type=d:text&type=d:mltext&type=d:int&type=d:long&type=d:float&type=d:double&type=d:date&type=d:boolean&type=d:qname",dataModifier:function(u,t){return this._addTransientProperties(u)},id:"{item.name}",type:"{item.dataType}",label:"{item.title}",title:"{item.name}"}}}],listItems:[]}]});q.eventGroup=q;q.currentCtx={configDef:g,ruleConfig:i,paramDef:o};YAHOO.Bubbling.on("dataItemSelected",function(u,w){if(e(q,w)){while(k.children.length>1){k.removeChild(k.lastChild)}var y=w[1].selectedItem.item;var v=this.renderers[y.dataType];var x=document.createElement("label");x.innerHTML=this.msg("label.setProperty.property");k.appendChild(x);var C=document.createElement("span");C.innerHTML=y.name;k.appendChild(C);var t=document.createElement("label");t.innerHTML=this.msg("label.setProperty.value");k.appendChild(t);var A=this.renderers["arca:set-property-value"].currentCtx;this._setHiddenParameter(q.currentCtx.configDef,q.currentCtx.ruleConfig,"property",y.name);this._updateSubmitElements(q.currentCtx.configDef);if(v&&typeof this.renderers[y.dataType].edit==="function"){var B={};var z={displayLabel:this.msg("label.setProperty.value"),isMandatory:true,isMultiValued:false,name:"value",type:y.dataType};this.renderers[y.dataType].edit.call(this,k,B,z,null,null)}this._createInputText(k,{},{_type:"hidden",name:"prop_type",isMandatory:false,isMultiValued:false,displayLabel:"prop_type"},null,y.dataType);this._setParameter(q.currentCtx.ruleConfig,"prop_type",y.dataType);this._updateSubmitElements(q.currentCtx.configDef)}},this);var j=this._createButton(k,g,o,i,function h(t,u){q.showDialog()});if(i.parameterValues&&i.parameterValues.property!=null){var m=document.createElement("label");m.innerHTML=this.msg("label.setProperty.property");k.appendChild(m);var s=document.createElement("span");s.innerHTML=i.parameterValues.property;k.appendChild(s);var f=document.createElement("label");f.innerHTML=this.msg("label.setProperty.value");k.appendChild(f);var l=this.renderers[i.parameterValues.prop_type];if(l&&typeof this.renderers[i.parameterValues.prop_type].edit==="function"){var r={};var p={displayLabel:"Value",isMandatory:true,isMultiValued:false,name:"value",type:i.parameterValues.prop_type};this.renderers[i.parameterValues.prop_type].edit.call(this,k,r,p,null,i.parameterValues.value)}this._createInputText(k,{},{_type:"hidden",name:"prop_type",isMandatory:false,isMultiValued:false,displayLabel:"prop_type"},null,i.parameterValues.prop_type);this._setParameter(i,"property",i.parameterValues.property);this._setParameter(i,"value",i.parameterValues.value);this._setParameter(i,"prop_type",i.parameterValues.prop_type);this._updateSubmitElements(g)}}},"arca:email-dialog-button":{manual:{edit:true},currentCtx:{},edit:function(k,j,g,h,i){this._createButton(k,j,g,h,function f(l,m){this.renderers["arca:email-dialog-button"].currentCtx={configDef:m.configDef,ruleConfig:m.ruleConfig};if(!this.widgets.emailForm){this.widgets.emailForm=new Alfresco.module.EmailForm(this.id+"-emailForm");YAHOO.Bubbling.on("emailFormCompleted",function(r,q){if(e(this.widgets.emailForm,q)){var p=q[1].options;if(p!==null){var o=this.renderers["arca:email-dialog-button"].currentCtx;this._setHiddenParameter(o.configDef,o.ruleConfig,"to_many",p.recipients);this._setHiddenParameter(o.configDef,o.ruleConfig,"subject",p.subject);this._setHiddenParameter(o.configDef,o.ruleConfig,"text",p.message?p.message:"");this._setHiddenParameter(o.configDef,o.ruleConfig,"template",p.template?p.template:"");this._updateSubmitElements(o.configDef)}}},this)}var n=this._getParameters(m.configDef);this.widgets.emailForm.showDialog({recipients:n.to_many,subject:n.subject,message:n.text,template:n.template})})}},"arca:checkin-dialog-button":{manual:{edit:true},currentCtx:{},edit:function(k,j,g,h,i){this._createButton(k,j,g,h,function f(l,m){this.renderers["arca:checkin-dialog-button"].currentCtx={configDef:m.configDef,ruleConfig:m.ruleConfig};if(!this.widgets.checkInForm){this.widgets.checkInForm=new Alfresco.module.RulesCheckinAction(this.id+"-checkinForm");YAHOO.Bubbling.on("checkinConfigCompleted",function(r,q){if(e(this.widgets.checkInForm,q)){var p=q[1].options;if(p!==null){var o=this.renderers["arca:checkin-dialog-button"].currentCtx;this._setHiddenParameter(o.configDef,o.ruleConfig,"minorChange",p.version=="minor"?"true":"false");this._setHiddenParameter(o.configDef,o.ruleConfig,"description",p.comments);this._updateSubmitElements(o.configDef)}}},this)}var n=this._getParameters(m.configDef);this.widgets.checkInForm.showDialog({version:n.minorChange?"minor":"major",comments:n.description})})}},"arca:destination-dialog-button":{manual:{edit:true},currentCtx:{},edit:function(l,k,f,i,j){this._createLabel(f.displayLabel,l);var g=i.parameterValues?i.parameterValues[f._destinationParam]:null;this._createPathSpan(l,k,f,this.id+"-"+k._id+"-destinationLabel",g);this._createButton(l,k,f,i,function h(n,p){this.renderers["arca:destination-dialog-button"].currentCtx={configDef:p.configDef,ruleConfig:p.ruleConfig,paramDef:p.paramDef};if(!this.widgets.destinationDialog){this.widgets.destinationDialog=new Alfresco.module.DoclibGlobalFolder(this.id+"-destinationDialog");this.widgets.destinationDialog.setOptions({title:this.msg("dialog.destination.title")});YAHOO.Bubbling.on("folderSelected",function(s,r){if(e(this.widgets.destinationDialog,r)){var t=r[1].selectedFolder;if(t!==null){var q=this.renderers["arca:destination-dialog-button"].currentCtx;this._setHiddenParameter(q.configDef,q.ruleConfig,q.paramDef._destinationParam,t.nodeRef);Alfresco.util.ComponentManager.get(this.id+"-"+q.configDef._id+"-destinationLabel").displayByPath(t.path,t.siteId,t.siteTitle);this._updateSubmitElements(q.configDef)}}},this)}var o=this._getParameters(p.configDef)["destination-folder"],m=[Alfresco.module.DoclibGlobalFolder.VIEW_MODE_SITE];if(this.options.repositoryBrowsing===true){m.push(Alfresco.module.DoclibGlobalFolder.VIEW_MODE_REPOSITORY,Alfresco.module.DoclibGlobalFolder.VIEW_MODE_USERHOME,Alfresco.module.DoclibGlobalFolder.VIEW_MODE_SHARED)}this.widgets.destinationDialog.setOptions({allowedViewModes:m,rootNode:this.options.rootNode,pathNodeRef:o?new Alfresco.util.NodeRef(o):null});this.widgets.destinationDialog.showDialog()})}},"arca:simple-workflow-dialog-button":{manual:{edit:true},currentCtx:{},edit:function(k,f,o,g,n){var i,l=Alfresco.module.RulesWorkflowAction,j=o._mode==l.VIEW_MODE_APPROVAL_STEP?"approve":"reject";if(o._mode==l.VIEW_MODE_REJECTION_STEP){i=document.createElement("input");i.setAttribute("type","checkbox");k.appendChild(i)}var h=this._createButton(k,f,o,g,function m(r,t){this.renderers["arca:simple-workflow-dialog-button"].currentCtx={configDef:t.configDef,ruleConfig:t.ruleConfig,paramDef:t.paramDef};if(!this.widgets.simpleWorkflowDialog){this.widgets.simpleWorkflowDialog=new Alfresco.module.RulesWorkflowAction(this.id+"-simpleWorkflowDialog");YAHOO.Bubbling.on("workflowOptionsSelected",function(z,y){if(e(this.widgets.simpleWorkflowDialog,y)){var x=y[1].options;if(x!==null){var w=this.renderers["arca:simple-workflow-dialog-button"].currentCtx,v=Alfresco.module.RulesWorkflowAction,A=x.viewMode==v.VIEW_MODE_APPROVAL_STEP?"approve":"reject";this._setHiddenParameter(w.configDef,w.ruleConfig,A+"-step",x.label);this._setHiddenParameter(w.configDef,w.ruleConfig,A+"-move",x.action=="move");this._setHiddenParameter(w.configDef,w.ruleConfig,A+"-folder",x.nodeRef);this._updateSubmitElements(w.configDef)}}},this)}var q=t.paramDef._mode;this.widgets.simpleWorkflowDialog.setOptions({viewMode:q,siteId:this.options.siteId,rootNode:this.options.rootNode,repositoryBrowsing:this.options.repositoryBrowsing});var u=this._getParameters(t.configDef),p=Alfresco.module.RulesWorkflowAction,s=q==p.VIEW_MODE_APPROVAL_STEP?"approve":"reject";this.widgets.simpleWorkflowDialog.showDialog({label:u[s+"-step"],action:(u[s+"-move"]?"move":"copy"),nodeRef:u[s+"-folder"]?new Alfresco.util.NodeRef(u[s+"-folder"]):null})});if(i){b.addListener(i,"click",function(r,s){var p=!s.enableCheckboxEl.checked;var q=[];q.push(c.query("input[param="+s.prefix+"-step]",s.configDef._id)[0]);q.push(c.query("input[param="+s.prefix+"-folder]",s.configDef._id)[0]);q.push(c.query("input[param="+s.prefix+"-move]",s.configDef._id)[0]);this._toggleDisableOnElements(q,p);if(p){c.query("input[param="+s.prefix+"-step]",s.configDef._id)[0].value="";c.query("input[param="+s.prefix+"-folder]",s.configDef._id)[0].value="";c.query("input[param="+s.prefix+"-move]",s.configDef._id)[0].value=""}s.button.set("disabled",p);this._updateSubmitElements(s.configDef)},{enableCheckboxEl:i,button:h,configDef:f,prefix:j},this);i.click();if(!g.parameterValues||!g.parameterValues[j+"-folder"]){i.click()}}}},"arca:category-picker":{manual:{edit:true},currentCtx:{},edit:function(k,j,g,h,i){this.renderers["arca:category-picker"].currentCtx={configDef:j,ruleConfig:h,paramDef:g};var f=new Alfresco.module.ControlWrapper(Alfresco.util.generateDomId());f.setOptions({type:"category",container:k,value:(h.parameterValues?h.parameterValues["category-value"]:null),controlParams:{multipleSelectMode:false},fnValueChanged:{fn:function(m){var l=this.renderers["arca:category-picker"].currentCtx;this._setHiddenParameter(l.configDef,l.ruleConfig,"category-aspect","cm:generalclassifiable");this._setHiddenParameter(l.configDef,l.ruleConfig,"category-value",m.selectedItems[0]);this._updateSubmitElements(l.configDef)},scope:this}});f.render()}}}})})();