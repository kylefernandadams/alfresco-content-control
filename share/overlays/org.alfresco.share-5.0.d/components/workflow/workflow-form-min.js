(function(){var b=YAHOO.util.Dom,u=YAHOO.util.Event,o=YAHOO.util.Selector;var n=Alfresco.util.encodeHTML,q=Alfresco.util.siteURL,c=Alfresco.util.userProfileLink;Alfresco.component.WorkflowForm=function t(v){Alfresco.component.WorkflowForm.superclass.constructor.call(this,"Alfresco.component.WorkflowForm",v,["button","container","datasource","datatable"]);this.isReady=false;this.workflow=null;this.currentTasks=[];this.historyTasks=[];YAHOO.Bubbling.on("workflowDetailedData",this.onWorkflowDetailedData,this);return this};YAHOO.extend(Alfresco.component.WorkflowForm,Alfresco.component.Base,{options:{referrer:null,nodeRef:null},isReady:false,workflow:null,currentTasks:null,historyTasks:null,onReady:function m(){this.isReady=true;this._loadWorkflowForm()},onWorkflowDetailedData:function h(w,v){this.workflow=v[1];this._loadWorkflowForm()},_getTaskUrl:function d(x,w){var v=x+"?taskId="+encodeURIComponent(w);if(this.options.referrer){v+="&referrer="+encodeURIComponent(this.options.referrer)}else{if(this.options.nodeRef){v+="&nodeRef="+encodeURIComponent(this.options.nodeRef)}}return q(v)},_loadWorkflowForm:function a(){if(this.isReady&&this.workflow){if(this.workflow.diagramUrl){b.removeClass(this.id+"-viewWorkflowDiagram");Alfresco.util.createYUIButton(this,"viewWorkflowDiagram",this.viewWorkflowDiagram)}var F=this.workflow.tasks,I;for(var J=0,C=F.length;J<C;J++){if(F[J].state=="COMPLETED"){this.historyTasks.push(F[J])}else{this.currentTasks.push(F[J])}}var v=function(R,Q){var T=Alfresco.util.fromISO8601(R),S=Alfresco.util.fromISO8601(Q);if(T&&S){return T<S?1:-1}else{return !T?1:-1}};this.currentTasks.sort(function(R,Q){return v(R.properties.bpm_dueDate,Q.properties.bpm_dueDate)});this.historyTasks.sort(function(R,Q){return v(R.properties.bpm_completionDate,Q.properties.bpm_completionDate)});var A=function(Q){if(Q.length>0){for(var T=0,S=Q.length;T<S;T++){var R=Q[T].properties.bpm_status;if(R=="Completed"){return Q[T]}}}return{properties:{}}};I=A(this.historyTasks);b.get(this.id+"-recentTaskTitle").innerHTML=n(I.title||"");b.get(this.id+"-recentTaskTitle").setAttribute("href",this._getTaskUrl("task-details",I.id));b.get(this.id+"-title").innerHTML=n(this.workflow.title);b.get(this.id+"-description").innerHTML=n(this.workflow.description);var D=this.workflow.message;if(D===null){D=this.msg("workflow.no_message")}b.get(this.id+"-message").innerHTML=n(D);b.get(this.id+"-recentTaskOwnersComment").innerHTML=n(I.properties.bpm_comment||this.msg("label.noComment"));var x=I.creator;if(x==null){x=I.owner||{}}var G=x.avatar,y=Alfresco.util.userProfileLink(x.userName,x.firstName+" "+x.lastName,null,!x.firstName);b.get(this.id+"-recentTaskOwnersAvatar").setAttribute("src",G?Alfresco.constants.PROXY_URI+G+"?c=force":Alfresco.constants.URL_RESCONTEXT+"components/images/no-user-photo-64.png");b.get(this.id+"-recentTaskOwnersCommentLink").innerHTML=this.msg("label.recentTaskOwnersCommentLink",y);var z=this.workflow.initiator||{};b.get(this.id+"-startedBy").innerHTML=Alfresco.util.userProfileLink(z.userName||this.msg("label.usernameDeleted"),z.firstName+" "+z.lastName,null,!z.firstName);var N=Alfresco.util.fromISO8601(this.workflow.dueDate);if(N){b.get(this.id+"-dueSummary").innerHTML=this.msg("label.dueOn",Alfresco.util.formatDate(N,"defaultDateOnly"));b.get(this.id+"-due").innerHTML=Alfresco.util.formatDate(N,"defaultDateOnly")}else{b.get(this.id+"-dueSummary").innerHTML=this.msg("label.noDueDate");b.get(this.id+"-due").innerHTML=this.msg("label.none")}var E=Alfresco.util.fromISO8601(I.properties.bpm_completionDate);b.get(this.id+"-recentTaskCompletedOn").innerHTML=n(E?Alfresco.util.formatDate(E,"mediumDate"):this.msg("label.notCompleted"));b.get(this.id+"-recentTaskCompletedBy").innerHTML=x.userName?y:this.msg("label.notCompleted");b.get(this.id+"-recentTaskOutcome").innerHTML=n(I.outcome||"");var K=Alfresco.util.fromISO8601(this.workflow.endDate);b.get(this.id+"-completed").innerHTML=n(K?Alfresco.util.formatDate(K):this.msg("label.notCompleted"));var w=Alfresco.util.fromISO8601(this.workflow.startDate);if(w){b.get(this.id+"-started").innerHTML=Alfresco.util.formatDate(w)}var L={"1":"high","2":"medium","3":"low"},O=L[this.workflow.priority+""],M=this.msg("priority."+O),B=this.msg("label.priorityLevel",M);var P=b.get(this.id+"-prioritySummary");b.addClass(P,O);P.innerHTML=B;b.get(this.id+"-priority").innerHTML=M;var H=this.workflow.isActive?this.msg("label.workflowIsInProgress"):this.msg("label.workflowIsComplete");b.get(this.id+"-statusSummary").innerHTML=n(H);b.get(this.id+"-status").innerHTML=n(H);if(this.workflow.startTaskInstanceId){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/form",dataObj:{htmlid:this.id+"-WorkflowForm-"+Alfresco.util.generateDomId(),itemKind:"task",itemId:this.workflow.startTaskInstanceId,mode:"view",formId:"workflow-details",formUI:false},successCallback:{fn:this.onWorkflowFormLoaded,scope:this},failureMessage:this.msg("message.failure"),scope:this,execScripts:true})}else{this.onWorkflowFormLoaded({serverResponse:{responseText:"<div class='form-container'><div class='form-fields'></div></div>"}})}}},onWorkflowFormLoaded:function f(z){var G=b.get(this.id+"-body");G.innerHTML=z.serverResponse.responseText;var A=o.query(".form-fields",this.id,true),x=b.get(this.id+"-summary-form-section"),v=b.get(this.id+"-general-form-section");A.insertBefore(v,b.getFirstChild(A));A.insertBefore(x,v);var B=b.get(this.id+"-currentTasks-form-section"),C=o.query("div",B,true);var E=[{key:"name",label:this.msg("column.type"),formatter:this.bind(this.renderCellType)},{key:"owner",label:this.msg("column.assignedTo"),formatter:this.bind(this.renderCellOwner)},{key:"id",label:this.msg("column.dueDate"),formatter:this.bind(this.renderCellDueDate)},{key:"state",label:this.msg("column.status"),formatter:this.bind(this.renderCellStatus)},{key:"properties",label:this.msg("column.actions"),formatter:this.bind(this.renderCellCurrentTasksActions)}];var D=new YAHOO.util.DataSource(this.currentTasks,{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});this.widgets.currentTasksDataTable=new YAHOO.widget.DataTable(C,E,D,{MSG_EMPTY:this.msg("label.noTasks")});var H=[{key:"name",label:this.msg("column.type"),formatter:this.bind(this.renderCellType)},{key:"owner",label:this.msg("column.completedBy"),formatter:this.bind(this.renderCellCompletedBy)},{key:"id",label:this.msg("column.dateCompleted"),formatter:this.bind(this.renderCellDateCompleted)},{key:"state",label:this.msg("column.outcome"),formatter:this.bind(this.renderCellOutcome)},{key:"properties",label:this.msg("column.comment"),formatter:this.bind(this.renderCellComment)}];var y=b.get(this.id+"-workflowHistory-form-section"),F=o.query("div",y,true);var w=new YAHOO.util.DataSource(this.historyTasks,{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});this.widgets.historyTasksDataTable=new YAHOO.widget.DataTable(F,H,w,{MSG_EMPTY:this.msg("label.noTasks")});o.query(".form-fields",this.id,true).appendChild(B);o.query(".form-fields",this.id,true).appendChild(y);YAHOO.Bubbling.fire("workflowFormReady",this)},viewWorkflowDiagram:function(){if(this.workflow.diagramUrl){Alfresco.Lightbox.show({src:Alfresco.constants.PROXY_URI+this.workflow.diagramUrl})}},renderCellType:function l(x,w,y,z){var v=w.getData();if(v.isEditable){x.innerHTML='<a href="'+this._getTaskUrl("task-edit",w.getData("id"))+'" title="'+this.msg("link.title.task-edit")+'">'+n(w.getData("title"))+"</a>"}else{x.innerHTML='<a href="'+this._getTaskUrl("task-details",w.getData("id"))+'" title="'+this.msg("link.title.task-details")+'">'+n(w.getData("title"))+"</a>"}},renderCellOwner:function s(y,x,z,A){var v=x.getData("owner");if(v!=null&&v.userName){var w=n(this.msg("field.owner",v.firstName,v.lastName));y.innerHTML=c(v.userName,v.firstName&&v.lastName?w:null,null,!v.firstName)}else{y.innerHTML=this.msg("label.none")}},renderCellCompletedBy:function r(z,y,A,B){var w=y.getData("properties").bpm_status;if(w!=null&&w!="Completed"){z.innerHTML=this.msg("label.none")}else{var x=y.getData("creator");if(x==null){x=y.getData("owner")}if(x!=null&&x.userName){var v=n(this.msg("field.owner",x.firstName,x.lastName));z.innerHTML=c(x.userName,x.firstName&&x.lastName?v:null,null,!x.firstName)}else{z.innerHTML=this.msg("label.none")}}},renderCellDateCompleted:function g(x,w,y,z){var v=Alfresco.util.fromISO8601(w.getData("properties").bpm_completionDate);x.innerHTML=Alfresco.util.formatDate(v)},renderCellDueDate:function k(y,x,z,A){var v=x.getData("properties").bpm_dueDate;if(v!==null){var w=Alfresco.util.fromISO8601(v);y.innerHTML=Alfresco.util.formatDate(w,"defaultDateOnly")}else{y.innerHTML=this.msg("label.none")}},renderCellStatus:function e(x,w,y,z){var v=w.getData("properties").bpm_status;if(w.getData("propertyLabels")&&Alfresco.util.isValueSet(w.getData("propertyLabels").bpm_status,false)){v=w.getData("propertyLabels").bpm_status}x.innerHTML=n(v)},renderCellOutcome:function j(w,v,x,y){w.innerHTML=n(v.getData("outcome"))},renderCellComment:function p(w,v,x,y){w.innerHTML=n(v.getData("properties").bpm_comment)},renderCellCurrentTasksActions:function i(x,w,y,z){var v=w.getData();x.innerHTML+='<a href="'+this._getTaskUrl("task-details",v.id)+'" class="task-details" title="'+this.msg("link.title.task-details")+'">&nbsp;</a>';if(v.isEditable){x.innerHTML+='<a href="'+this._getTaskUrl("task-edit",v.id)+'" class="task-edit" title="'+this.msg("link.title.task-edit")+'">&nbsp;</a>'}}})})();