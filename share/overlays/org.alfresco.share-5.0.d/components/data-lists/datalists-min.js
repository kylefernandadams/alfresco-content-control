(function(){var h=YAHOO.util.Dom,n=YAHOO.util.Event,a=YAHOO.util.Selector,c=YAHOO.Bubbling;var f=Alfresco.util.encodeHTML,g=Alfresco.util.combinePaths;Alfresco.component.DataLists=function(p){Alfresco.component.DataLists.superclass.constructor.call(this,"Alfresco.component.DataLists",p,["button","container"]);c.on("dataListCreated",this.onDataListCreated,this);c.on("dataListDetailsUpdated",this.onDataListDetailsUpdated,this);this.dataLists={};this.dataListsLength=null;this.containerNodeRef=null;this.listTypeTitles=null;return this};YAHOO.extend(Alfresco.component.DataLists,Alfresco.component.Base,{options:{siteId:"",containerId:"dataLists",listId:"",listTypes:[]},dataLists:null,dataListsLength:null,containerNodeRef:null,listTypeTitles:null,onReady:function k(){this.widgets.newList=Alfresco.util.createYUIButton(this,"newListButton",this.onNewList,{disabled:true});this.populateDataLists({fn:function p(){this.renderDataLists();if(this.options.listId.length>0){c.fire("activeDataListChanged",{dataList:this.dataLists[this.options.listId],scrollTo:true})}else{YAHOO.Bubbling.fire("hideFilter")}if(this.dataListsLength===0||window.location.hash==="#new"){this.widgets.newList.fireEvent("click")}},scope:this})},populateDataLists:function d(q){var r=function s(v,z){var u=v.json.datalists,y;this.dataLists={};this.containerNodeRef=new Alfresco.util.NodeRef(v.json.container);this.widgets.newList.set("disabled",!v.json.permissions.create);for(var w=0,x=u.length;w<x;w++){y=u[w];this.dataLists[y.name]=y}this.dataListsLength=u.length;if(q&&(typeof q.fn=="function")){q.fn.call(q.scope||this,q.obj)}};var t=function p(u){if(u.status==401){window.location.reload()}else{this.dataLists=null;this.containerNodeRef=null;this.widgets.newList.set("disabled",true);var v="";try{v=f(YAHOO.lang.JSON.parse(u.responseText).message)}catch(w){v=this.msg("message.error-unknown")}}};Alfresco.util.Ajax.jsonGet({url:g(Alfresco.constants.PROXY_URI,"slingshot/datalists/lists/site",this.options.siteId,this.options.containerId),successCallback:{fn:r,obj:q,scope:this},failureCallback:{fn:t,scope:this}})},renderDataLists:function b(v){var K=this,I=h.get(this.id+"-lists"),w="selected";I.innerHTML="";var u=function s(){return function L(){var M=a.query("li",I);h.removeClass(M,w);h.addClass(this,w);return true}};var E=function p(M,L){return function N(O){if(L){K.onEditList(M)}n.stopEvent(O||window.event)}};var r=function y(M,L){return function N(O){if(L){K.onDeleteList(M)}n.stopEvent(O||window.event)}};try{var J=this.dataLists,H,x,z=null,A,q,G,D,B,C;if(this.dataListsLength===0){I.innerHTML='<div class="no-lists">'+this.msg("message.no-lists")+"</div>"}else{A=document.createElement("ul");I.appendChild(A);for(var t in J){if(J.hasOwnProperty(t)){H=J[t];x=H.permissions;q=document.createElement("li");q.onclick=u();G=document.createElement("span");if(x.edit){G.className="edit";G.title=this.msg("label.edit-list");G.onclick=E(H.name,true)}else{G.className="edit-disabled";G.onclick=E(H.name,false)}D=document.createElement("span");if(x["delete"]){D.className="delete";D.title=this.msg("label.delete-list");D.onclick=r(H.name,true)}else{D.className="delete-disabled";D.onclick=r(H.name,false)}B=document.createElement("a");B.className="filter-link";B.title=H.description;B.href="data-lists?list="+f(H.name);C=document.createTextNode(H.title);B.appendChild(D);B.appendChild(G);B.appendChild(C);q.appendChild(B);A.appendChild(q);if(H.name==this.options.listId){h.addClass(q,"selected")}if(H.name==v){z=q}}}if(z){Alfresco.util.Anim.pulse(z)}}}catch(F){I.innerHTML='<span class="error">'+this.msg("message.error-unknown")+"</span>"}},getListTypeTitle:function m(r){if(this.listTypeTitles===null){var s;this.listTypeTitles={};for(var p=0,q=this.options.listTypes.length;p<q;p++){s=this.options.listTypes[p];this.listTypeTitles[s.name]=s.title}}return this.listTypeTitles[r]||""},onDataListCreated:function l(q,p){var s=p[1];if((s!==null)&&(s.name!==null)){this.populateDataLists({fn:function r(t){this.renderDataLists(t)},obj:s.name,scope:this})}},onDataListDetailsUpdated:function o(q,p){var r=p[1];if((r!==null)&&(r.dataList!==null)){this.renderDataLists(r.dataList.name)}},onNewList:function i(v,z){var y=this.containerNodeRef.nodeRef,q="theme-bg-selected";var x=function r(D,J,C){var H=function K(M,N){return function L(){var O=a.query("div",D);h.removeClass(O,q);h.addClass(M,q);h.get(J).value=N;C.validate();return false}};var G,B,F=h.get(D);for(var E=0,I=this.options.listTypes.length;E<I;E++){G=this.options.listTypes[E];B=document.createElement("div");B.innerHTML='<h4><a href="#" tabindex="0">'+f(G.title)+"</a></h4><span>"+f(G.description)+"</span>";B.onclick=H(B,G.name);F.appendChild(B)}};var A=function w(B,E){Alfresco.util.populateHTML([E.id+"-dialogTitle",this.msg("label.new-list.title")],[E.id+"-dialogHeader",this.msg("label.new-list.header")],[E.id+"-dataListItemType",this.msg("label.item-type")]);x.apply(this,[E.id+"-itemTypesContainer",E.id+"-dataListItemType-field",B]);var D=function C(K,G,J,I,F,H){return(K.value.length>0)};B.addValidation(E.id+"-dataListItemType-field",D,null,null,null,{validationType:"mandatory"})};var s=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&destination={destination}&mode={mode}&submitType={submitType}&showCancelButton=true",{itemKind:"type",itemId:"dl:dataList",destination:y,mode:"create",submitType:"json"});var t=new Alfresco.module.SimpleDialog(this.id+"-newList");t.setOptions({width:"33em",templateUrl:s,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:A,scope:this},onSuccess:{fn:function p(B){var E=new Alfresco.util.NodeRef(B.json.persistedObject),C=B.config.dataObj.prop_cm_title,D=this.getListTypeTitle(B.config.dataObj.prop_dl_dataListItemType);c.fire("dataListCreated");Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-list.success",C)});Alfresco.Share.postActivity(this.options.siteId,"org.alfresco.datalists.list-created",C+" ("+D+")","data-lists?list={cm:name}",{appTool:"datalists",nodeRef:E.toString()})},scope:this},onFailure:{fn:function u(B){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-list.failure")})},scope:this}}).show()},onEditList:function j(v){var u=this.dataLists[v];var q=function p(x,y){Alfresco.util.populateHTML([y.id+"-dialogTitle",this.msg("message.edit-list.title")],[y.id+"-dialogHeader",this.msg("message.edit-list.header")]);x.addValidation(y.id+"_prop_cm_title",Alfresco.forms.validation.mandatory,null,"keyup")};var t=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/form?itemKind={itemKind}&itemId={itemId}&mode={mode}&submitType={submitType}&showCancelButton=true",{itemKind:"node",itemId:u.nodeRef,mode:"edit",submitType:"json"});var s=new Alfresco.module.SimpleDialog(this.id+"-editList");s.setOptions({width:"33em",templateUrl:t,actionUrl:null,destroyOnHide:true,doBeforeDialogShow:{fn:q,scope:this},onSuccess:{fn:function r(y,C){var x=y.config.dataObj,B=new Alfresco.util.NodeRef(C.nodeRef),A=C.title,z=this.getListTypeTitle(C.itemType);C.title=x.prop_cm_title;C.description=x.prop_cm_description;c.fire("dataListDetailsUpdated",{dataList:C});Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-list.success",C.title)});Alfresco.Share.postActivity(this.options.siteId,"org.alfresco.datalists.list-updated",C.title+" ("+z+")","data-lists?list={cm:name}",{appTool:"datalists",nodeRef:B.toString()})},obj:u,scope:this},onFailure:{fn:function w(x){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-list.failure")})},scope:this}}).show()},onDeleteList:function e(u){var t=this.dataLists[u],s=this;var r=function p(w){var z=new Alfresco.util.NodeRef(w.nodeRef),y=this.getListTypeTitle(w.itemType);Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.DELETE,url:Alfresco.constants.PROXY_URI+"slingshot/datalists/list/node/"+z.uri,successCallback:{fn:function A(B,C){Alfresco.Share.postActivity(this.options.siteId,"org.alfresco.datalists.list-deleted",t.title+" ("+y+")","data-lists",{appTool:"datalists",nodeRef:z.toString()},this.bind(function(){if(C.name==this.options.listId){window.location="data-lists";return}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete-list.success")});delete this.dataLists[w.name];this.dataListsLength--;this.renderDataLists()}))},obj:w,scope:this},failureCallback:{fn:function x(B){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.delete-list.failure")})},scope:this}})};Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.delete-list.title"),text:this.msg("message.delete-list.description",f(t.title)),buttons:[{text:this.msg("button.delete"),handler:function q(){this.destroy();r.call(s,t)}},{text:this.msg("button.cancel"),handler:function v(){this.destroy()},isDefault:true}]})}})})();