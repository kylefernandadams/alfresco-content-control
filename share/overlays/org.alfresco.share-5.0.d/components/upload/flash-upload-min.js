(function(){var a=YAHOO.util.Dom,n=YAHOO.util.Element,i=YAHOO.util.KeyListener;var p=Alfresco.util.encodeHTML;Alfresco.FlashUpload=function(F){Alfresco.FlashUpload.superclass.constructor.call(this,"Alfresco.FlashUpload",F,["button","container","datatable","datasource","cookie","uploader"]);this.swf=Alfresco.constants.URL_CONTEXT+"res/yui/uploader/assets/uploader.swf";this.hasRequiredFlashPlayer=Alfresco.util.hasRequiredFlashPlayer(9,0,45);this.fileStore={};this.addedFiles={};this.defaultShowConfig={siteId:null,containerId:null,destination:null,uploadDirectory:null,updateNodeRef:null,updateFilename:null,updateVersion:"1.0",mode:this.MODE_SINGLE_UPLOAD,filter:[],onFileUploadComplete:null,overwrite:false,thumbnails:null,uploadURL:null,username:null,suppressRefreshEvent:false};this.suppliedConfig={};this.showConfig={};this.fileItemTemplates={};return this};YAHOO.extend(Alfresco.FlashUpload,Alfresco.component.Base,{contentReady:false,STATE_BROWSING:1,STATE_UPLOADING:2,STATE_FINISHED:3,STATE_FAILURE:4,STATE_SUCCESS:5,STATE_ILLEGAL_FILENAME:6,state:1,fileStore:null,noOfSuccessfulUploads:0,noOfFailedUploads:0,addedFiles:null,MODE_SINGLE_UPLOAD:1,MODE_SINGLE_UPDATE:2,MODE_MULTI_UPLOAD:3,defaultShowConfig:null,suppliedConfig:null,showConfig:null,uploader:null,uploaderReady:false,titleText:null,multiUploadTip:null,singleUpdateTip:null,statusText:null,minorVersion:null,majorVersion:null,description:null,versionSection:null,fileItemTemplates:null,_iePageTitleBackup:null,onReady:function z(){this._iePageTitleBackup=document.title;YAHOO.widget.Uploader.SWFURL=this.swf;a.removeClass(this.id+"-dialog","hidden");this.widgets.panel=Alfresco.util.createYUIPanel(this.id+"-dialog");this.widgets.panel.hideEvent.subscribe(this.onCancelOkButtonClick,null,this);if(this.widgets.panel.platform=="mac"&&YAHOO.env.ua.gecko){var F=YAHOO.util.Config,I=this.widgets.panel;if(F.alreadySubscribed(I.showEvent,I.showMacGeckoScrollbars,I)){I.showEvent.unsubscribe(I.showMacGeckoScrollbars,I)}if(F.alreadySubscribed(I.hideEvent,I.hideMacGeckoScrollbars,I)){I.hideEvent.unsubscribe(I.hideMacGeckoScrollbars,I)}a.addClass(I.element,"reinstantiated-fix")}this.fileItemTemplates.left=a.get(this.id+"-left-div");this.fileItemTemplates.center=a.get(this.id+"-center-div");this.fileItemTemplates.right=a.get(this.id+"-right-div");this._createEmptyDataTable();this.titleText=a.get(this.id+"-title-span");this.multiUploadTip=a.get(this.id+"-multiUploadTip-span");this.singleUpdateTip=a.get(this.id+"-singleUpdateTip-span");this.statusText=a.get(this.id+"-status-span");this.description=a.get(this.id+"-description-textarea");this.minorVersion=a.get(this.id+"-minorVersion-radioButton");this.majorVersion=a.get(this.id+"-majorVersion-radioButton");this.versionSection=a.get(this.id+"-versionSection-div");this.widgets.uploadButton=Alfresco.util.createYUIButton(this,"upload-button",this.onUploadButtonClick);this.widgets.cancelOkButton=Alfresco.util.createYUIButton(this,"cancelOk-button",this.onCancelOkButtonClick);this.uploader=new YAHOO.widget.Uploader(this.id+"-flashuploader-div",Alfresco.constants.URL_RESCONTEXT+"themes/"+Alfresco.constants.THEME+"/images/upload-button-sprite.png",true);this.uploader.subscribe("fileSelect",this.onFileSelect,this,true);this.uploader.subscribe("uploadComplete",this.onUploadComplete,this,true);this.uploader.subscribe("uploadProgress",this.onUploadProgress,this,true);this.uploader.subscribe("uploadStart",this.onUploadStart,this,true);this.uploader.subscribe("uploadCancel",this.onUploadCancel,this,true);this.uploader.subscribe("uploadCompleteData",this.onUploadCompleteData,this,true);this.uploader.subscribe("uploadError",this.onUploadError,this,true);this.uploader.subscribe("contentReady",this.onContentReady,this,true);this.widgets.escapeListener=new i(document,{keys:i.KEY.ESCAPE},{fn:this.onCancelOkButtonClick,scope:this,correctScope:true});if(this.uploader._swf&&this.uploader._swf.tagName.toLowerCase()=="embed"){this.widgets.uploaderListener=new i(this.uploader._swf,{keys:i.KEY.TAB},{fn:function H(J){this.widgets.panel.setFirstLastFocusable();this.widgets.panel.firstElement.focus()},scope:this,correctScope:true})}var G=a.getElementsByClassName("label","div")[0];G.parentNode.style.width=(10+38+10+1)+G.offsetWidth+"px";YAHOO.lang.later(this,2000,function(){a.addClass(this.id+"-flashuploader-div","hidden")})},onContentReady:function r(F){this.uploader.enable();this.uploader.setAllowMultipleFiles(this.showConfig.mode===this.MODE_MULTI_UPLOAD);if(this.showConfig.filter){this.uploader.setFileFilters(this.showConfig.filter)}},show:function d(I){if(!this.hasRequiredFlashPlayer){Alfresco.util.PopupManager.displayPrompt({text:this.msg("label.noFlash")})}this.suppliedConfig=I;this.showConfig=YAHOO.lang.merge(this.defaultShowConfig,I);if(this.showConfig.uploadDirectory===undefined&&this.showConfig.updateNodeRef===undefined){throw new Error("An updateNodeRef OR uploadDirectory must be provided")}if(this.showConfig.uploadDirectory!==null&&this.showConfig.uploadDirectory.length===0){this.showConfig.uploadDirectory="/"}var L=this.id+"-flashuploader-div";a.removeClass(L,"hidden");this._resetGUI();this._applyConfig();this.widgets.escapeListener.enable();var H=a.getChildren(this.id+"-flashuploader-div"),M,K;for(var J=0,G=H.length;J<G;J++){M=H[J];K=M.tagName.toLowerCase();if(K=="a"){M.parentNode.removeChild(M)}}this.widgets.panel.setFirstLastFocusable();if(this.uploader._swf&&this.uploader._swf.tagName.toLowerCase()=="embed"){this.widgets.panel.firstElement=this.uploader._swf;this.widgets.lastElListener=new i(this.widgets.panel.lastElement,{keys:i.KEY.TAB},{fn:function F(N){this.widgets.panel.firstElement=this.uploader._swf},scope:this,correctScope:true});this.widgets.lastElListener.enable();this.widgets.uploaderListener.enable()}this.widgets.panel.show();if(navigator.userAgent&&navigator.userAgent.indexOf("Ubuntu")!=-1&&YAHOO.env.ua.gecko>1&&!a.hasClass(L,"button-fix")){a.addClass(L,"button-fix")}if(YAHOO.env.ua.ie){document.title=this._iePageTitleBackup}},hide:function t(){this.onCancelOkButtonClick()},_resetGUI:function E(){if(this.statusText==null){this.onReady()}this.state=this.STATE_BROWSING;this.noOfFailedUploads=0;this.noOfSuccessfulUploads=0;this.statusText.innerHTML="&nbsp;";this.description.value="";this.minorVersion.checked=true;this.minorVersion.disabled=false;this.majorVersion.disabled=false;this.description.disabled=false;this.widgets.uploadButton.set("label",this.msg("button.upload"));this.widgets.uploadButton.set("disabled",true);a.removeClass(this.id+"-upload-button","hidden");this.widgets.cancelOkButton.set("label",this.msg("button.cancel"));this.widgets.cancelOkButton.set("disabled",false)},onPostRenderEvent:function u(){for(var I in this.fileStore){var G=this.fileStore[I];if(G!=null&&G.state==this.STATE_ILLEGAL_FILENAME){var H=this.msg("label.illegalChars");G.progressInfo.innerHTML=G.progressInfo.innerHTML+" "+H;G.progressInfo.setAttribute("title",H);G.progressInfoCell.setAttribute("title",H);a.removeClass(G.progress,"fileupload-progressSuccess-span");a.addClass(G.progress,"fileupload-progressFailure-span");a.setStyle(G.progress,"left",0+"px");G.state=this.STATE_FAILURE;this.noOfFailedUploads++;this._updateStatus()}}if(this.noOfFailedUploads==0){this._clearStatus()}var F=this.widgets.dataTable.getRecordSet().getLength();if(F>0&&F>this.noOfFailedUploads){this.widgets.uploadButton.set("disabled",false);this.widgets.panel.setFirstLastFocusable();this.widgets.panel.focusFirst()}if(this.showConfig.mode===this.MODE_SINGLE_UPDATE&&this.widgets.panel.cfg.getProperty("visible")){if(this.widgets.dataTable.getRecordSet().getLength()===0){this.uploader.enable()}else{this.uploader.disable()}}},onRowDeleteEvent:function f(F){this.widgets.panel.setFirstLastFocusable();this.widgets.panel.focusFirst()},onFileSelect:function w(H){if(YAHOO.env.ua.ie){document.title=this._iePageTitleBackup}this.widgets.uploadButton.set("disabled",true);var J=[],I,F;for(var G in H.fileList){I=YAHOO.widget.DataTable._cloneObject(H.fileList[G]);F=this._getUniqueFileToken(I);if(!this.addedFiles[F]){if(I.size===0&&!this.addedFiles[F]){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.zeroByteFileSelected",I.name)})}else{J.push(I)}this.addedFiles[F]=F}}this.widgets.dataTable.addRows(J,0)},onUploadStart:function q(G){var F=this.fileStore[G.id];if(F.contentType){a.addClass(F.contentType,"hidden")}F.progressPercentage.innerHTML="0%";a.removeClass(F.progressPercentage,"hidden");F.state=this.STATE_UPLOADING},onUploadProgress:function k(I){var H=I.id;var G=this.fileStore[H];var F=I.bytesLoaded/I.bytesTotal;G.progressPercentage.innerHTML=Math.round(F*100)+"%";var J=(-400+(F*400));a.setStyle(G.progress,"left",J+"px")},onUploadComplete:function x(F){},onUploadCompleteData:function C(I){var H=this.fileStore[I.id];H.state=this.STATE_SUCCESS;H.fileButton.set("disabled",true);var G=H.fileName;var F=Alfresco.util.parseJSON(I.data);if(F){H.nodeRef=F.nodeRef;H.fileName=F.fileName;H.rawJson=F}H.fileSizeInfo.innerHTML=H.fileSizeInfo.innerHTML+" ("+this.msg("label.success")+")";a.removeClass(H.progress,"fileupload-progressSuccess-span");a.addClass(H.progress,"fileupload-progressFinished-span");a.setStyle(H.progress,"left",0+"px");H.progressPercentage.innerHTML="100%";this.noOfSuccessfulUploads++;this._updateStatus();this._uploadFromQueue(1);this._adjustGuiIfFinished()},onUploadCancel:function B(F){},onUploadError:function c(H){var G=this.fileStore[H.id];if(G.state!==this.STATE_FAILURE){G.state=this.STATE_FAILURE;var F="label.failure."+H.status,I=Alfresco.util.message(F,this.name);if(I==F){I=Alfresco.util.message("label.failure",this.name)}G.fileSizeInfo.innerHTML=G.fileSizeInfo.innerHTML+" ("+I+")";G.progressInfo.setAttribute("title",I);G.progressInfoCell.setAttribute("title",I);a.removeClass(G.progress,"fileupload-progressSuccess-span");a.addClass(G.progress,"fileupload-progressFailure-span");a.setStyle(G.progress,"left",0+"px");G.fileButton.set("disabled",true);this.noOfFailedUploads++;this._updateStatus();this._uploadFromQueue(1);this._adjustGuiIfFinished()}},_onFileButtonClickHandler:function b(G,F){var H=this.widgets.dataTable.getRecordSet().getRecord(F);this.addedFiles[this._getUniqueFileToken(H.getData())]=null;this.widgets.dataTable.deleteRow(H);if(this.fileStore[G].state==this.STATE_FAILURE){this.noOfFailedUploads--;this._updateStatus()}this.fileStore[G]=null;if(this.state===this.STATE_BROWSING){this.uploader.removeFile(G);if(this.widgets.dataTable.getRecordSet().getLength()===0){this.widgets.uploadButton.set("disabled",true);this.uploader.enable()}}else{if(this.state===this.STATE_UPLOADING){this.uploader.cancel(G);this._uploadFromQueue(1);this._updateStatus();this._adjustGuiIfFinished()}}},onCancelOkButtonClick:function o(){var H,G;if(this.state===this.STATE_BROWSING){}else{if(this.state===this.STATE_UPLOADING){this._cancelAllUploads();var F=0;for(G in this.fileStore){if(this.fileStore[G]&&this.fileStore[G].state===this.STATE_SUCCESS){F++}}if(F>0){H=YAHOO.lang.substitute(this.msg("message.cancelStatus"),{"0":F})}if(!this.showConfig.suppressRefreshEvent){YAHOO.Bubbling.fire("metadataRefresh",{currentPath:this.showConfig.path})}}else{if(this.state===this.STATE_FINISHED){var J=null,I;for(G in this.fileStore){I=this.fileStore[G];if(I&&I.state===this.STATE_SUCCESS){J=I.fileName;break}}if(!this.showConfig.suppressRefreshEvent){if(J){YAHOO.Bubbling.fire("metadataRefresh",{currentPath:this.showConfig.path,highlightFile:J})}else{YAHOO.Bubbling.fire("metadataRefresh",{currentPath:this.showConfig.path})}}}}}this._clear();this.widgets.panel.hide();a.addClass(this.id+"-flashuploader-div","hidden");this.widgets.escapeListener.disable();if(H){Alfresco.util.PopupManager.displayPrompt({text:H})}},onUploadButtonClick:function m(){if(this.state===this.STATE_BROWSING){var F=this.widgets.dataTable.getRecordSet().getLength();if(F>0){this.state=this.STATE_UPLOADING;this.widgets.uploadButton.set("disabled",true);this.minorVersion.disabled=true;this.majorVersion.disabled=true;this.description.disabled=true;this.uploader.disable();this._updateStatus()}this._uploadFromQueue(2)}},_applyConfig:function e(){var K;if(this.showConfig.mode===this.MODE_SINGLE_UPLOAD){K=this.msg("header.singleUpload")}else{if(this.showConfig.mode===this.MODE_MULTI_UPLOAD){K=this.msg("header.multiUpload")}else{if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){K=this.msg("header.singleUpdate")}}}this.titleText.innerHTML=K;if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){this.singleUpdateTip.innerHTML=YAHOO.lang.substitute(this.msg("label.singleUpdateTip"),{"0":this.showConfig.updateFilename});a.removeClass(this.versionSection,"hidden");var G=(this.showConfig.updateVersion||"1.0").split("."),F=parseInt(G[0],10),J=parseInt(G[1],10);a.get(this.id+"-minorVersion").innerHTML=this.msg("label.minorVersion.more",F+"."+(1+J));a.get(this.id+"-majorVersion").innerHTML=this.msg("label.majorVersion.more",(1+F)+".0")}else{a.addClass(this.versionSection,"hidden")}if(this.showConfig.mode===this.MODE_MULTI_UPLOAD){a.removeClass(this.statusText,"hidden");a.removeClass(this.multiUploadTip,"hidden");a.addClass(this.singleUpdateTip,"hidden");this.widgets.dataTable.set("height","204px",true)}else{a.addClass(this.statusText,"hidden");a.addClass(this.multiUploadTip,"hidden");if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){a.removeClass(this.singleUpdateTip,"hidden")}else{a.addClass(this.singleUpdateTip,"hidden")}this.widgets.dataTable.set("height","40px")}var I=a.get(this.id+"-flashuploader-div");var H=a.getFirstChild(I);if(H&&H.tagName.toLowerCase()=="p"){a.setStyle(I,"height","30px");a.setStyle(I,"height","200px")}else{this._applyUploaderConfig({multiSelect:this.showConfig.mode===this.MODE_MULTI_UPLOAD,filter:this.showConfig.filter},0)}},_applyUploaderConfig:function(I,F){try{this.uploader.enable();this.uploader.setAllowMultipleFiles(I.multiSelect);this.uploader.setFileFilters(I.filter)}catch(H){if(F==7){Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.flashError.title"),text:this.msg("message.flashError.message"),buttons:[{text:Alfresco.util.message("button.ok"),handler:{fn:function J(L,M){this.destroy();M.widgets.panel.destroy();var K=M._disableFlashUploader();if(K){K.show(M.suppliedConfig)}},obj:this},isDefault:true},{text:Alfresco.util.message("button.refreshPage"),handler:function G(){window.location.reload(true)}}]})}else{YAHOO.lang.later(100,this,this._applyUploaderConfig,[I,++F])}}},_disableFlashUploader:function l(){var F=Alfresco.util.ComponentManager.findFirst("Alfresco.FileUpload");if(F){F.options.adobeFlashEnabled=false}return F},_createEmptyDataTable:function h(){var F=this;var G=function(M,N,O,P){F._formatCellElements(M,N,F.fileItemTemplates.left)};var L=function(M,N,O,P){F._formatCellElements(M,N,F.fileItemTemplates.center)};var J=function(M,N,O,P){F._formatCellElements(M,N,F.fileItemTemplates.right)};this._formatCellElements=function(O,ac,Y){var V=ac.getData(),Z=V.id;if(!this.fileStore[Z]){var ab=this.STATE_BROWSING;var Q={id:Z,value:V.name};if(!Alfresco.forms.validation.nodeName(Q,{},null,null,true,null)){ab=this.STATE_ILLEGAL_FILENAME}else{}this.fileStore[Z]={state:ab,fileName:V.name,nodeRef:null}}var aa=new n(O);var T=Y.cloneNode(true);T.setAttribute("id",T.getAttribute("id")+Z);var N=a.getElementsByClassName("fileupload-progressSuccess-span","span",T);if(N.length==1){this.fileStore[Z].progress=N[0]}var W=a.getElementsByClassName("fileupload-progressInfo-span","span",T);if(W.length==1){var P=V.name;T.setAttribute("title",P);W=W[0];this.fileStore[Z].progressInfo=W;this.fileStore[Z].progressInfo.innerHTML=p(P);this.fileStore[Z].progressInfoCell=O}var S=a.getElementsByClassName("fileupload-filesize-span","span",T);if(S.length==1){var P=Alfresco.util.formatFileSize(V.size);S=S[0];this.fileStore[Z].fileSizeInfo=S;S.innerHTML=P}var X=a.getElementsByClassName("fileupload-contentType-select","select",T);if(X.length==1){this.fileStore[Z].contentType=X[0]}else{X=a.getElementsByClassName("fileupload-contentType-input","input",T);if(X.length==1){this.fileStore[Z].contentType=X[0]}}var U=a.getElementsByClassName("fileupload-percentage-span","span",T);if(U.length==1){this.fileStore[Z].progressPercentage=U[0]}var M=a.getElementsByClassName("fileupload-file-button","button",T);if(M.length==1){var R=new YAHOO.widget.Button(M[0],{type:"button",disabled:false});R.subscribe("click",function(){this._onFileButtonClickHandler(Z,ac.getId())},this,true);this.fileStore[Z].fileButton=R}aa.appendChild(T)};var K=[{key:"id",className:"col-left",resizable:false,formatter:G},{key:"name",className:"col-center",resizable:false,formatter:L},{key:"created",className:"col-right",resizable:false,formatter:J}];var I=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});YAHOO.widget.DataTable._bStylesheetFallback=!!YAHOO.env.ua.ie;var H=a.get(this.id+"-filelist-table");this.widgets.dataTable=new YAHOO.widget.DataTable(H,K,I,{scrollable:true,height:"100px",width:"620px",renderLoopSize:1,MSG_EMPTY:this.msg("label.noFiles")});this.widgets.dataTable.subscribe("postRenderEvent",this.onPostRenderEvent,this,true);this.widgets.dataTable.subscribe("rowDeleteEvent",this.onRowDeleteEvent,this,true)},_getUniqueFileToken:function D(F){return F.name+":"+F.size+":"+F.cDate+":"+F.mDate},_updateStatus:function g(){this.statusText.innerHTML=YAHOO.lang.substitute(this.msg("label.uploadStatus"),{"0":this.noOfSuccessfulUploads,"1":this.widgets.dataTable.getRecordSet().getLength(),"2":this.noOfFailedUploads})},_clearStatus:function j(){this.statusText.innerHTML=""},_adjustGuiIfFinished:function y(){var H={successful:[],failed:[]};var G=null;for(var F in this.fileStore){G=this.fileStore[F];if(G){if(G.state==this.STATE_SUCCESS){H.successful.push({fileName:G.fileName,nodeRef:G.nodeRef,response:G.rawJson})}else{if(G.state==this.STATE_FAILURE){H.failed.push({fileName:G.fileName})}else{return}}}}this.state=this.STATE_FINISHED;if(!this.showConfig.suppressRefreshEvent){this.widgets.cancelOkButton.set("label",this.msg("button.ok"));this.widgets.cancelOkButton.focus()}else{this.widgets.cancelOkButton.set("disabled",true)}this.widgets.uploadButton.set("disabled",true);a.addClass(this.id+"-upload-button","hidden");var I=this.showConfig.onFileUploadComplete;if(I&&typeof I.fn=="function"){I.fn.call((typeof I.scope=="object"?I.scope:this),H,I.obj)}},_uploadFromQueue:function A(N){var G;if(this.showConfig.uploadURL===null){G=Alfresco.constants.PROXY_URI+"api/upload"}else{G=Alfresco.constants.PROXY_URI+this.showConfig.uploadURL}G+=";jsessionid="+YAHOO.util.Cookie.get("JSESSIONID")+"?lang="+Alfresco.constants.JS_LOCALE;if(Alfresco.util.CSRFPolicy.isFilterEnabled()){G+="&"+Alfresco.util.CSRFPolicy.getParameter()+"="+encodeURIComponent(Alfresco.util.CSRFPolicy.getToken())}var F=0,H=this.widgets.dataTable.getRecordSet().getLength(),K,M,L,I;for(var J=0;J<H&&F<N;J++){K=this.widgets.dataTable.getRecordSet().getRecord(J);M=K.getData("id");L=this.fileStore[M];if(L.state===this.STATE_BROWSING){L.state=this.STATE_UPLOADING;I={username:this.showConfig.username};if(this.showConfig.siteId!==null){I.siteId=this.showConfig.siteId;I.containerId=this.showConfig.containerId}else{if(this.showConfig.destination!==null){I.destination=this.showConfig.destination}}if(this.showConfig.mode===this.MODE_SINGLE_UPDATE){I.updateNodeRef=this.showConfig.updateNodeRef;I.majorVersion=!this.minorVersion.checked;I.description=this.description.value}else{if(this.showConfig.uploadDirectory!==null){I.uploadDirectory=this.showConfig.uploadDirectory}if(L.contentType){if(L.contentType.tagName.toLowerCase()=="select"){I.contentType=L.contentType.options[L.contentType.selectedIndex].value}else{I.contentType=L.contentType.value}}I.overwrite=this.showConfig.overwrite;if(this.showConfig.thumbnails){I.thumbnails=this.showConfig.thumbnails}}this.uploader.upload(M,G,"POST",I,"filedata");F++}}},_cancelAllUploads:function s(){var I=this.widgets.dataTable.getRecordSet().getLength();for(var H=0;H<I;H++){var F=this.widgets.dataTable.getRecordSet().getRecord(H);var G=F.getData("id");this.uploader.cancel(G)}},_clear:function v(){var F=this.widgets.dataTable.getRecordSet().getLength();this.addedFiles={};this.fileStore={};this.widgets.dataTable.deleteRows(0,F);this.uploader.clearFileList()}})})();