(function(){var b=YAHOO.util.Dom,v=YAHOO.util.Selector,z=YAHOO.util.Event,n=YAHOO.util.KeyListener,l=Alfresco.util.combinePaths,s=Alfresco.util.encodeHTML,f=Alfresco.util.fromISO8601,i=Alfresco.util.toISO8601,q=Alfresco.util.formatDate,u,o,d;Alfresco.EventInfo=function(A){this.name="Alfresco.EventInfo";this.id=A;this.panel=null;Alfresco.util.YUILoaderHelper.require(["button","container","connection"],this.onComponentsLoaded,this);return this};Alfresco.EventInfo.prototype={panel:null,event:null,options:{siteId:"",onClose:null,eventUri:null,displayDate:null},setOptions:function e(A){this.options=YAHOO.lang.merge(this.options,A);return this},onComponentsLoaded:function j(){if(this.id===null){return}},show:function r(A){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/calendar/info",dataObj:{htmlid:this.id,uri:A.uri},successCallback:{fn:this.templateLoaded,scope:this},failureMessage:"Could not load event info panel",execScripts:true});this.event=A},templateLoaded:function t(B){var H=b.get("eventInfoPanel");H.innerHTML=B.serverResponse.responseText;this.panel=Alfresco.util.createYUIPanel(H,{width:"35em",zIndex:10});this.widgets=this.widgets||{};this.widgets.deleteButton=Alfresco.util.createYUIButton(this,"delete-button",this.onDeleteClick);this.widgets.editButton=Alfresco.util.createYUIButton(this,"edit-button",this.onEditClick);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelClick);this.widgets.escapeListener=new n(document,{keys:n.KEY.ESCAPE},{fn:function(J,I){this.onCancelClick()},scope:this,correctScope:true});this.widgets.escapeListener.enable();if(b.get(this.id+"-edit-available")==null){if(this.widgets.deleteButton){this.widgets.deleteButton.set("disabled",true)}if(this.widgets.editButton){this.widgets.editButton.set("disabled",true)}}var E=[this.id+"-startdate",this.id+"-enddate"];for(var D=0,A=E.length;D<A;D++){var F=b.get(E[D]);var C=f(F.innerHTML);if(b.hasClass(F,"allDayEvent")){F.innerHTML=q(C,Alfresco.util.message("date-format.fullDate"))}else{F.innerHTML=q(C,Alfresco.util.message("date-format.fullDateTime"))}}var G=v.query(".yui-gd .yui-u",H);for(var D=1;D<6;D+=2){G[D].innerHTML=Alfresco.util.decodeHTML(G[D].innerHTML)}this.panel.show()},onCancelClick:function x(A){this._hide()},onEditClick:function(A){if(this.isShowing){this._hide()}this.eventDialog=this.initEditDialog();this.eventDialog.show()},onEdited:function(A){if(!A.json.error){YAHOO.Bubbling.fire("eventEdited",{id:this.options.event,data:A.json.data})}else{this.onEditFailed(A)}if(this.panel){this.panel.hide();this.panel.destroy()}this.eventDialog.dialog.destroy()},onEditFailed:function(A){Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.edited.failure","Alfresco.CalendarView")})},onDeleteClick:function m(D){var C=this,A=q(f(this.event.startAt.iso8601),this._msg("date-format.fullDate"));Alfresco.util.PopupManager.displayPrompt({noEscape:true,title:this._msg("message.confirm.delete.title"),text:this._msg("message.confirm.delete",s(this.event.title),A),buttons:[{text:this._msg("button.delete"),handler:function B(){this.destroy();C._onDeleteConfirm.call(C)}},{text:this._msg("button.cancel"),handler:function E(){this.destroy()},isDefault:true}]})},_onDeleteConfirm:function y(){Alfresco.util.Ajax.request({method:Alfresco.util.Ajax.DELETE,url:Alfresco.constants.PROXY_URI+this.event.uri+"&page=calendar",successCallback:{fn:this.onDeleted,scope:this},failureMessage:this._msg("message.delete.failure",this.event.title)})},onDeleted:function p(A){this._hide();Alfresco.util.PopupManager.displayMessage({text:this._msg("message.delete.success",this.event.title)});YAHOO.Bubbling.fire("eventDeleted",{id:this.options.event});if(this.panel){this.panel.destroy()}},initEditDialog:function h(E){u=this;o=new Alfresco.module.SimpleDialog();d=Alfresco.util.ComponentManager.findFirst("Alfresco.CalendarView");o.setOptions({site:u.options.siteId,displayDate:u.options.displayDate,width:"42em",actionUrl:Alfresco.constants.PROXY_URI+u.options.eventUri+"&page=calendar",ajaxSubmitMethod:Alfresco.util.Ajax.PUT,templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"components/calendar/add-event",templateRequestParams:{site:u.options.siteId,uri:"/"+u.options.eventUri||""},doBeforeFormSubmit:{fn:function F(H,K){o.tagLibrary.updateForm(o.id+"-form","tags");var S=b.get(o.id+"-tag-input-field");if(S){S.disabled=true}var R=b.getElementsByClassName("error",null,b.get(o.id+"-form"));for(var L=0;L<R.length;L++){b.removeClass(R[L],"error")}b.get(o.id+"-title").disabled=false;b.get(o.id+"-location").disabled=false;o.widgets.okButton.set("disabled",true);o.widgets.cancelButton.set("disabled",true);var P=document.getElementsByName("start")[0],J=Alfresco.util.parseTime(P.value),Q=document.getElementsByName("end")[0],O=Alfresco.util.parseTime(Q.value),G=document.getElementsByName("startAt")[0],M=document.getElementsByName("endAt")[0],I=f(G.value),N=f(M.value);I.setHours(J.getHours(),J.getMinutes());N.setHours(O.getHours(),O.getMinutes());b.setAttribute(G,"value",i(I));b.setAttribute(M,"value",i(N));o.form.setAjaxSubmitMethod(o.options.ajaxSubmitMethod)},scope:o},doBeforeAjaxRequest:{fn:function D(J,K){var H=document.getElementsByName("allday").checked===true;var I=document.getElementsByName("start")[0];var G=document.getElementsByName("end")[0];if(J.dataObj.tags){J.dataObj.tags=J.dataObj.tags.join()}if(YAHOO.lang.isUndefined(J.dataObj.start)){J.dataObj.start=I.value;J.dataObj.end=G.value}if(!H&&(J.dataObj.start=="00:00"&&J.dataObj.end=="00:00")){J.dataObj.end="01:00"}return true},scope:o},doBeforeDialogShow:{fn:function B(){var I=u.event,H=(I)?f(I.startAt.iso8601):this.options.displayDate,L=(I)?f(I.endAt.iso8601):this.options.displayDate;Alfresco.CalendarHelper.writeDateToField(H,b.get("fd"));Alfresco.CalendarHelper.writeDateToField(L,b.get("td"));b.get(o.id+"-startAt").value=i(H);b.get(o.id+"-endAt").value=i(L);var Q=b.get(o.id+"-tag-input-field");Q.disabled=false;Q.tabIndex=9;b.get(o.id+"-add-tag-button").tabIndex=10;var R=Q.value;Q.value="";o.tagLibrary.setTags(R.split(","));o.form.errorContainer=null;var M=document.getElementsByName("start")[0],N=document.getElementsByName("end")[0];if(document.getElementsByName("allday")[0].checked===true){b.addClass(M.parentNode,"hidden");b.addClass(N.parentNode,"hidden")}else{b.removeClass(M.parentNode,"hidden");b.removeClass(N.parentNode,"hidden")}if(I){b.setAttribute(M,"value",q(H,this.msg("date-format.shortTime")));b.setAttribute(N,"value",q(L,this.msg("date-format.shortTime")))}else{var K=Alfresco.util.parseTime(M.value),P=Alfresco.util.parseTime(N.value);b.setAttribute(M,"value",q(K,this.msg("date-format.shortTime")));b.setAttribute(N,"value",q(P,this.msg("date-format.shortTime")))}o.dialog.hideEvent.subscribe(function(){if(d&&d.oCalendar){d.oCalendar.hide()}},o,true);var O=["what","where","desc"];for(var J=0;J<O.length;J++){var G=document.getElementsByName(O[J])[0];G.value=Alfresco.util.decodeHTML(G.value)}},scope:o},doSetupFormsValidation:{fn:function C(L){var H={pattern:/({|})/,match:false};var K=[o.id+"-title",o.id+"-location",o.id+"-description"];L.addValidation(K[0],Alfresco.forms.validation.mandatory,null,"blur");L.addValidation(K[0],Alfresco.forms.validation.mandatory,null,"keyup");for(var J=0;J<K.length;J++){L.addValidation(K[J],Alfresco.forms.validation.regexMatch,H,"blur");L.addValidation(K[J],Alfresco.forms.validation.regexMatch,H,"keyup")}o.tagLibrary.initialize(L);var G=["td","fd",o.id+"-start",o.id+"-end"];for(var J=0;J<G.length;J++){L.addValidation(G[J],u._onDateValidation,{obj:o},"blur")}L.addValidation("td",u._onDateValidation,{obj:o},"focus");L.addValidation("fd",u._onDateValidation,{obj:o},"focus");L.setSubmitElements(o.widgets.okButton);var M=function(){return function(N){if(N.keyCode===n.KEY.ENTER){u.onDateSelectButton.apply(o,arguments);return false}}}();var I=Alfresco.util.createYUIButton(o,"browse-button",function(){if(o.browsePanel){delete o.browsePanel}o.hide();var N=Alfresco.util.ComponentManager.findFirst("Alfresco.CollaborationTitle"),O=(N&&N.options)?N.options.siteTitle:o.options.site;Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"components/calendar/browse-docfolder",dataObj:{site:O},successCallback:{fn:function(Q){var W=document.createElement("div");W.innerHTML=Q.serverResponse.responseText;var S=b.getFirstChild(W);o.browsePanel=Alfresco.util.createYUIPanel(S);var T=b.get(o.id+"-docfolder").value;Alfresco.util.createYUIButton(o.browsePanel,"ok",function(){if(T.charAt(T.length-1)=="/"){T=T.substring(0,T.length-1)}b.get(o.id+"-docfolder").value=T;o.browsePanel.hide();o.dialog.show()});Alfresco.util.createYUIButton(o.browsePanel,"cancel",function(){o.browsePanel.hide();o.dialog.show()});Alfresco.util.createTwister("twister");var P=new YAHOO.widget.TreeView("treeview");P.setDynamicLoad(function(aa,X){var Y=aa.data.path;var Z=Alfresco.constants.PROXY_URI+"slingshot/doclib/treenode/site/"+l(encodeURIComponent(d.options.siteId),encodeURIComponent("documentLibrary"),Alfresco.util.encodeURIPath(Y));var ab={success:function(af){var ae=YAHOO.lang.JSON.parse(af.responseText),ag,ah;if(ae.items){for(var ad=0,ac=ae.items.length;ad<ac;ad++){ag=ae.items[ad];ag.path=l(Y,ag.name);ah=u._buildTreeNode(ag,aa,false);if(!ag.hasChildren){ah.isLeaf=true}}}af.argument.fnLoadComplete()},failure:function(ac){Alfresco.logger.error("",ac)},argument:{node:aa,fnLoadComplete:X},scope:o};YAHOO.util.Connect.asyncRequest("GET",Z,ab)});var R=function V(X){T="documentLibrary"+X};P.subscribe("expand",function(X){R(X.data.path)});P.subscribe("clickEvent",function(X){R(X.node.data.path)});P.subscribe("collapseComplete",function(X){R(X.data.path)});var U=u._buildTreeNode({name:"documentLibrary",path:"/",nodeRef:""},P.getRoot(),false);P.render();o.browsePanel.setFirstLastFocusable();o.browsePanel.show()},scope:o}})});if(!o.startButton){o.startButton=new YAHOO.widget.Button({type:"link",id:"calendarpicker",label:"",href:"",tabindex:6,container:o.id+"-startdate"});o.startButton.on("click",u.onDateSelectButton,{},o);z.on(b.get("fd"),"click",u.onDateSelectButton,{},o);o.startButton.on("keypress",M)}if(!o.endButton){o.endButton=new YAHOO.widget.Button({type:"link",id:"calendarendpicker",label:"",href:"",tabindex:8,container:o.id+"-enddate"});o.endButton.on("click",u.onDateSelectButton,{},o);z.on(b.get("td"),"click",u.onDateSelectButton,{},o);o.endButton.on("keypress",M)}z.addListener(document.getElementsByName("allday")[0],"click",function(O){if(z.getTarget(O).checked===true){b.addClass(document.getElementsByName("start")[0].parentNode,"hidden");b.addClass(document.getElementsByName("end")[0].parentNode,"hidden")}else{b.removeClass(document.getElementsByName("start")[0].parentNode,"hidden");b.removeClass(document.getElementsByName("end")[0].parentNode,"hidden");var N=new Date();N.setHours(12);N.setMinutes(0);document.getElementsByName("start")[0].value=Alfresco.util.formatDate(N,Alfresco.messages.global["date-format.shortTime"]);N.setHours(13);document.getElementsByName("end")[0].value=Alfresco.util.formatDate(N,Alfresco.messages.global["date-format.shortTime"])}})},scope:o},onSuccess:{fn:u.onEdited,scope:u},onFailure:{fn:u.onEditFailed,scope:u}});if(E){o.setOptions(E)}o.id="eventEditPanel";o.event=u.event;if(o.tagLibrary==undefined){var A=Alfresco.util.ComponentManager.find({name:"Alfresco.module.TagLibrary"});if(A.length>0){o.tagLibrary=A[0]}else{o.tagLibrary=new Alfresco.module.TagLibrary(o.id);o.tagLibrary.setOptions({siteId:o.options.siteId})}}o.tags=[];YAHOO.Bubbling.on("onTagLibraryTagsChanged",function(G,H){o.tags=H[1].tags},o);return o},onDateSelectButton:function a(E){z.stopEvent(E);var B=d,I=z.getTarget(E),A=(I.id==="calendarpicker-button"||I.id==="fd")?true:false;B.oCalendarMenu=new YAHOO.widget.Overlay("calendarmenu",{context:[I,"tr","br"],fixedcenter:true});B.oCalendarMenu.setBody("&#32;");B.oCalendarMenu.body.id="calendarcontainer";B.oCalendarMenu.render(b.getAncestorByTagName(I.id,"div"));var C=(A)?b.get("fd"):b.get("td");var G=Alfresco.CalendarHelper.getDateFromField(C);var F=Alfresco.CalendarHelper.padZeros(G.getMonth()+1)+"/"+G.getFullYear();var D={pagedate:F,close:true},H={pagedate:F,close:true,mindate:f(b.get("fd").title)};var J=(A)?D:H;B.oCalendar=new YAHOO.widget.Calendar("buttoncalendar",B.oCalendarMenu.body.id,J);Alfresco.util.calI18nParams(B.oCalendar);B.oCalendar.render();B.oCalendar.selectEvent.subscribe(function(O,M){var L;if(M){L=M[0][0];var N=new Date(L[0],(L[1]-1),L[2]);Alfresco.CalendarHelper.writeDateToField(N,C);var K;if(A){K=Alfresco.CalendarHelper.getDateFromField(b.get("td"));if(YAHOO.widget.DateMath.before(K,N)){var P=b.get("td");Alfresco.CalendarHelper.writeDateToField(N,P);document.getElementsByName("endAt")[0].value=i(N)}document.getElementsByName("startAt")[0].value=i(N)}else{K=Alfresco.CalendarHelper.getDateFromField(C);document.getElementsByName("endAt")[0].value=i(K)}}B.oCalendarMenu.hide();(A)?b.get("calendarpicker-button").focus():b.get("calendarendpicker-button").focus()},B,true);B.oCalendarMenu.body.tabIndex=-1;B.oCalendar.oDomContainer.tabIndex=-1;B.oCalendarMenu.show();B.oCalendar.show();B.oCalendarMenu.body.focus();return false},_onDateValidation:function w(J,H,B,C,G){var I=Alfresco.util.parseTime(b.get(H.obj.id+"-start").value);var F=Alfresco.util.parseTime(b.get(H.obj.id+"-end").value);if(I===null||F===null){return false}var D=Alfresco.CalendarHelper.getDateFromField(b.get("fd"));D.setHours(I.getHours(),I.getMinutes());var E=Alfresco.CalendarHelper.getDateFromField(b.get("td"));E.setHours(F.getHours(),F.getMinutes());if(D.getTime()===E.getTime()){return true}var A=YAHOO.widget.DateMath.after(E,D);if(Alfresco.logger.isDebugEnabled()){Alfresco.logger.debug("Current start date: "+D+" "+b.get(H.obj.id+"-start").value);Alfresco.logger.debug("Current end date: "+E+" "+b.get(H.obj.id+"-end").value);Alfresco.logger.debug("End date is after start date: "+A)}if(!A&&!G){C.addError(Alfresco.util.message("message.invalid-date","Alfresco.CalendarView"),J)}return A},_msg:function c(A){return Alfresco.util.message.call(this,A,"Alfresco.EventInfo",Array.prototype.slice.call(arguments).slice(1))},_hide:function k(){if(this.widgets&&this.widgets.escapeListener){this.widgets.escapeListener.disable()}if(this.panel){this.panel.hide()}var A=this.options.onClose;if(A&&typeof A.fn=="function"){A.fn.call((typeof A.scope=="object"?A.scope:this),A.obj)}},_buildTreeNode:function g(A,C,B){return new YAHOO.widget.TextNode({label:Alfresco.util.encodeHTML(A.name),path:A.path,nodeRef:A.nodeRef,description:A.description},C,B)}}})();