(function(){var F=YAHOO.util.Dom,E=YAHOO.util.Event,k=YAHOO.util.Selector,D=Alfresco.util.encodeHTML,N=Alfresco.util.fromISO8601,d=Alfresco.util.toISO8601,t=Alfresco.thirdparty.dateFormat;Alfresco.CalendarView=function u(O){this.id=O;Alfresco.CalendarView.superclass.constructor.call(this,"Alfresco.CalendarView",O,["calendar","button","resize","datasource","datatable","history"]);return this};YAHOO.extend(Alfresco.CalendarView,Alfresco.component.Base,{widgets:{},modules:{},popups:{},handlers:{},data:{},calendarView:"",setOptions:function c(O){this.options=YAHOO.lang.merge(this.options,O);if(typeof this.options.startDate=="string"){this.options.startDate=Alfresco.util.fromISO8601(this.options.startDate)}if(typeof this.options.endDate=="string"){this.options.endDate=Alfresco.util.fromISO8601(this.options.endDate)}if(typeof this.options.titleDate=="string"){this.options.titleDate=Alfresco.util.fromISO8601(this.options.titleDate)}return this},initEvents:function a(){E.on(this.id,"click",this.onInteractionEvent,this,true);E.on(this.id,"dblclick",this.onInteractionEvent,this,true);YAHOO.Bubbling.on("eventEdited",this.onEventEdited,this);YAHOO.Bubbling.on("eventEditedAfter",this.onAfterEventEdited,this);YAHOO.Bubbling.on("eventSaved",this.onEventSaved,this);YAHOO.Bubbling.on("eventSavedAfter",this.onAfterEventSaved,this);YAHOO.Bubbling.on("eventDeleted",this.onEventDeleted,this);YAHOO.Bubbling.on("eventDeletedAfter",this.onAfterEventDeleted,this);YAHOO.Bubbling.on("tagSelected",this.onTagSelected,this);YAHOO.Bubbling.on("viewChanged",this.onViewChanged,this);YAHOO.Bubbling.on("dateChanged",this.onCalSelect,this);if(this.calendarView==Alfresco.CalendarView.VIEWTYPE_DAY|this.calendarView==Alfresco.CalendarView.VIEWTYPE_WEEK){YAHOO.Bubbling.on("eventResized",this.onEventResized,this)}},getEvents:function n(){Alfresco.util.Ajax.request({url:Alfresco.constants.PROXY_URI+"calendar/events/"+this.options.siteId+"/user",dataObj:{from:d(this.options.startDate).split("T")[0],to:d(this.options.endDate).split("T")[0],repeating:"all"},successCallback:{fn:this.onEventsLoaded,scope:this},failureMessage:Alfresco.util.message("load.fail","Alfresco.CalendarView")})},render:function w(){if(this.calendarView===Alfresco.CalendarView.VIEWTYPE_AGENDA){this.initEvents();this.getEvents(t(this.options.startDate,"yyyy-mm-dd"))}else{this.renderEvents()}},displayMessage:function j(P,O){Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message(P,O||this.name)})},getEventObj:function K(O){if(typeof(O.innerHTML)==="string"){return this.parseRel(O)}else{return O}},getRel:function q(O){return O.from.split("T")[0]},parseRel:function l(R){var S="",P="",O=false;if(k.test(R,"div.yui-dt-liner")){R=F.getElementsByClassName("summary","a",R.parentNode.parentNode)[0]}if(R.rel!==""&&R.rel!==undefined){P=R.rel;S=this.widgets.Data[P].events;for(var Q=0;Q<S.length;Q++){if(S[Q].uri==="/calendar/event/"+R.href.split("/calendar/event/")[1]){O=S[Q]}}}return O},toggleEarlyTableRows:function M(){var R=YAHOO.util.Dom.get("collapseTrigger");this.earlyEls=YAHOO.util.Dom.getElementsByClassName("early","tr",R.parentNode);var O=(YAHOO.env.ua.ie)?"block":"table-row";for(var P=0;P<this.earlyEls.length;P++){var Q=this.earlyEls[P];YAHOO.util.Dom.setStyle(Q,"display",(this.isShowingEarlyRows)?"none":O)}this.isShowingEarlyRows=!this.isShowingEarlyRows},onEventsLoaded:function y(P){var T=YAHOO.lang.JSON.parse(P.serverResponse.responseText).events;var V=[];var aa=[];var R=null;var Z=this.options.startDate;var X=this.options.endDate;var O=this.options.siteId;YAHOO.Bubbling.fire("eventDataLoad",T);for(var S=0;S<T.length;S++){var W=T[S];W.title=D(W.title);W.where=D(W.where);W.description=D(W.description);if(W.site==O){V.push(W)}}T=V;R=function(){return function(ad,af){var ac=(ad<=Z&&X<=af);var ab=(ad>=Z&&ad<X);var ae=(af>=Z&&af<X);return(ac||ab||ae)}}.apply(this);for(var S=0;S<T.length;S++){var W=T[S];var Q=N(W.startAt.iso8601);var U=N(W.endAt.iso8601);if(R(Q,U)){var Y={};Y.desc=W.description||"";Y.name=W.title;Y.isoutlook=W.isoutlook=="true"?"isoutlook":"";Y.contEl="div";Y.from=d(Q);Y.to=d(U);Y.uri="/calendar/event/"+this.options.siteId+"/"+W.name+"?date="+W.startAt.iso8601;Y.hidden="";Y.allday="";Y.isMultiDay=(!Alfresco.CalendarHelper.isSameDay(Q,U));Y.isAllDay=(W.allday=="true")?true:false;Y.el="div";Y.key=Y.from.split(":")[0]+":00";Y=YAHOO.lang.merge(W,Y);aa.push(Y)}}this.renderEvents(aa)},add:function z(P,O){this.add(P,O)},remove:function o(O){this.remove(O)},update:function x(P,O){this.data.update(O)},filterMultiday:function H(Z){var R=YAHOO.widget.DateMath;for(var T=0,Y=Z.length;T<Y;T++){var O=Z[T];if(O.isMultiDay){var W=O.from.split("T"),X=O.to.split("T"),U=N(W[0]),Q=N(X[0]),V=new Date(U+86400000);if(!O.isAllDay){O.displayEnd="00:00"}for(var S=0,V=R.add(U,R.DAY,1);V.getTime()<=Q.getTime();V=R.add(V,R.DAY,1)){var P=YAHOO.lang.merge(O);P.isCloned=true;P.clonedFromDate=O.from;if(!O.isAllDay){if(!Alfresco.CalendarHelper.isSameDay(V,Q)){P.isAllDay=true}else{P.displayStart="00:00";delete P.displayEnd}}P.displayFrom=d(V);Z.push(P)}}}return Z},getDateFromUrl:function i(){var O=Alfresco.util.getQueryStringParameter("date"),P=window.location.hash.split("date=");if(P[1]){O=P[1].split("&")[0]}return O},showAddDialog:function A(P){var O;if(YAHOO.lang.isUndefined(P)){P=Alfresco.util.fromISO8601(this.getDateFromUrl())||new Date()}this.currentDate=O=P;var Q=new Alfresco.EventInfo(this.id);this.eventDialog=Q.initEditDialog({actionUrl:Alfresco.constants.PROXY_URI+"calendar/create",ajaxSubmitMethod:Alfresco.util.Ajax.POST,destroyOnHide:true,displayDate:O,templateRequestParams:{site:this.options.siteId},onSuccess:{fn:this.onEventSaved,scope:this},onFailure:{fn:this.onEventSaveFailed,scope:this}});this.eventDialog.show()},showDialog:function(P,Q){var O=this.getEventObj(Q);this.setUpDialog(P,Q,O);if(!this.eventInfoPanel.isShowing){this.eventInfoPanel.show(O)}E.preventDefault(P)},deleteDialog:function(P,Q){var O=this.getEventObj(Q);this.setUpDialog(P,Q,O);this.eventInfoPanel.onDeleteClick();E.preventDefault(P)},editDialog:function(P,Q){var O=this.getEventObj(Q);this.setUpDialog(P,Q,O);this.eventInfoPanel.onEditClick();E.preventDefault(P)},setUpDialog:function(P,Q,O){var R=document.createElement("div");R.id="eventInfoPanel";document.body.appendChild(R);this.eventInfoPanel=new Alfresco.EventInfo(this.id);this.eventInfoPanel.event=O;if(!this.eventInfoPanel.isShowing){this.eventInfoPanel.setOptions({siteId:this.options.siteId,eventUri:O.uri.substring(1,O.uri.length),displayDate:this.currentDate,event:O,permitToEditEvents:this.options.permitToCreateEvents})}},isValidDateForView:function(O){return(O.getTime()>=this.options.startDate.getTime())&&(O.getTime()<this.options.endDate.getTime())},onDateSelected:function C(Q,O){if(this.currPopUpCalContext){for(var P=1;P<O[0][0].length;P++){O[0][0][P]=Alfresco.CalendarHelper.padZeros(O[0][0][P])}F.get(this.currPopUpCalContext).value=O[0][0].join("-");if(this.currPopUpCalContext==="dtend"){F.get(this.currPopUpCalContext+"time").value=YAHOO.widget.DateMath.add(N(F.get("dtstart").value+"T"+F.get("dtstarttime").value),YAHOO.widget.DateMath.HOUR,1).format(t.masks.isoTime)}}},onReady:function h(){this.calendarView=this.options.view;this.startDate=(YAHOO.lang.isString(this.options.startDate))?N(this.options.startDate):this.options.startDate;this.container=F.get(this.id);this.containerRegion=F.getRegion(this.container);this.isShowingEarlyRows=true;this.titleEl=F.get("calTitle");if(!YAHOO.widget.DateMath.HOUR){YAHOO.widget.DateMath.add=function(){var O=YAHOO.widget.DateMath.add;YAHOO.widget.DateMath.HOUR="H";YAHOO.widget.DateMath.SECOND="S";YAHOO.widget.DateMath.MINUTE="Mn";return function(Q,S,R){switch(S){case YAHOO.widget.DateMath.MONTH:case YAHOO.widget.DateMath.DAY:case YAHOO.widget.DateMath.YEAR:case YAHOO.widget.DateMath.WEEK:return O.apply(YAHOO.widget.DateMath,arguments);break;case YAHOO.widget.DateMath.HOUR:var T=Q.getHours()+R;var P=0;if(T<0){while(T<0){T+=24;P-=1}}if(T>24){while(T>24){T-=24;P+=1}}YAHOO.widget.DateMath._addDays(Q,P);Q.setHours(T);break;case YAHOO.widget.DateMath.MINUTE:Q.setMinutes(Q.getMinutes()+R);break;case YAHOO.widget.DateMath.SECOND:Q.setMinutes(Q.getSeconds()+R)}return Q}}()}this.render()},onInteractionEvent:function e(R,O){var Q,P;if(typeof(R.event)==="object"&&typeof(R.target)==="object"){P=R.event;Q=R.target}else{P=R;Q=E.getTarget(P)}if(P.type==="mouseover"){if(k.test(Q,"div."+this.dragGroup)){F.addClass(Q,"highlight");if(this.options.permitToCreateEvents){if(!F.hasClass(Q,"disabled")){Q.appendChild(this.addButton)}}}}else{if(P.type==="mouseout"){if(k.test(Q,"div."+this.dragGroup)){F.addClass(Q,"highlight")}}else{if(P.type==="click"){if(k.test(Q,"a#collapseTriggerLink")){this.toggleEarlyTableRows();E.preventDefault(P)}else{if(k.test(Q,"button#addEventButton")||k.test(Q.offsetParent,"button#addEventButton")||k.test(Q,"a.addEvent")){this.showAddDialog();E.preventDefault(P)}else{if(k.test(Q,"a.summary")||k.test(Q,"div.yui-dt-liner")){this.showDialog(P,Q)}else{if(k.test(Q,"li.moreEvents a")){this.onShowMore(P,O,Q)}else{if(k.test(Q,"a.showMore")){this.expandDescription(Q);E.preventDefault(P)}else{if(k.test(Q,"a.showLess")){this.collapseDescription(Q);E.preventDefault(P)}else{if(k.test(Q,"a.deleteAction")){this.deleteDialog(P,Q)}else{if(k.test(Q,"a.editAction")){this.editDialog(P,Q)}}}}}}}}}}}},onTodayNav:function r(){var O=new Date();var P=Alfresco.util.getQueryStringParameters();P.date=O.getFullYear()+"-"+Alfresco.CalendarHelper.padZeros((~~(1*(O.getMonth())))+1)+"-"+Alfresco.CalendarHelper.padZeros(O.getDate());window.location=window.location.href.split("?")[0]+Alfresco.util.toQueryString(P)},onViewChanged:function J(){var Q=Alfresco.util.getQueryStringParameters(),P=this.getDateFromUrl();Q.view=Alfresco.util.ComponentManager.findFirst("Alfresco.CalendarToolbar").enabledViews[arguments[1][1].activeView];if(P!==""){Q.date=P}var R=window.location.href.split("?")[0].split("#")[0],O=Alfresco.util.toQueryString(Q);if(Q.view==="agenda"){R+=O}else{R+=O.replace("?","#")}window.location=R},onCalSelect:function s(R,Q){var P=Q[1].date;var S=Alfresco.util.getQueryStringParameters();S.date=t(P,"yyyy-mm-dd");var O=window.location.href.split("?")[0]+Alfresco.util.toQueryString(S);window.location=O},onTagSelected:function p(Q,O){var P=arguments[1][1].tagname;if(P==Alfresco.util.message("label.all-tags","Alfresco.TagComponent")){this.options.tag=null}else{this.options.tag=P}this.updateTitle();this.getEvents()},onEventEdited:function f(O,P){this.getEvents();YAHOO.Bubbling.fire("eventEditedAfter")},onEventSaved:function B(P){this.getEvents();var O=YAHOO.lang.JSON.parse(P.serverResponse.responseText);if(!O.error){YAHOO.Bubbling.fire("eventSavedAfter");this.displayMessage("message.created.success",this.name)}else{this.onEventSaveFailed()}},onEventSaveFailed:function v(){Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("message.created.failure",this.name)})},onEventDeleted:function L(){this.getEvents();YAHOO.Bubbling.fire("eventDeletedAfter");this.msg("message.deleted.success",this.name)},onAfterEventSaved:function b(P,O){this.refreshTags();this.displayMessage("message.created.success",this.name)},onAfterEventDeleted:function m(P,O){this.refreshTags();this.displayMessage("message.deleted.success",this.name)},onAfterEventEdited:function m(P,O){this.refreshTags()},refreshTags:function g(){YAHOO.lang.later(500,YAHOO.Bubbling,"fire","tagRefresh")},updateTitle:function G(){return},tagFilter:function I(T){var Q=[],S=this.options.tag;if(!S){return T}else{for(var R=0,O=T.length;R<O;R++){var P=T[R].tags;if(typeof(P)==="string"){P=P.split(",")}if(Alfresco.util.arrayContains(P,S)){Q.push(T[R])}}return Q}}});Alfresco.CalendarView.VIEWTYPE_WEEK="week";Alfresco.CalendarView.VIEWTYPE_MONTH="month";Alfresco.CalendarView.VIEWTYPE_DAY="day";Alfresco.CalendarView.VIEWTYPE_AGENDA="agenda"})();Alfresco.CalendarHelper=(function Alfresco_CalendarHelper(){var h=YAHOO.util.Dom,a=Alfresco.util.fromISO8601,l=Alfresco.util.toISO8601,c=Alfresco.thirdparty.dateFormat;var m=[];return{padZeros:function f(n){return(n<10)?"0"+n:n},getDateFromField:function g(o){var n=h.getAttribute(o,"rel");var p=(n!=="")?a(n):new Date();return p},writeDateToField:function b(n,o){var p=c(n,Alfresco.util.message("date-format.fullDate"));o.value=p;h.setAttribute(o,"rel",l(n))},addTemplate:function e(n,o){m[n]=o},getTemplate:function d(n){return m[n]},renderTemplate:function k(n,q){var p=document.createElement("div");if(m[n]&&p){var p=YAHOO.lang.isString(p)?h.get(p):p;var o=m[n];var r=document.createElement("div");if(q){o=YAHOO.lang.substitute(o,q)}r.innerHTML=o;p.appendChild(r.firstChild);return p.lastChild}},isSameDay:function j(o,n){if(typeof(o)==="string"){o=a(o)}if(typeof(n)==="string"){n=a(n)}return(o.getDate()===n.getDate()&&o.getMonth()===n.getMonth()&&o.getFullYear()===n.getFullYear())},isAllDay:function i(o){var p=this.isSameDay(o.from,o.to);var n=(o.end==o.start&&"00:00")?true:false;return(!p&&n)}}})();Alfresco.CalendarHelper.addTemplate("vevent",'<{el} class="vevent {allday} {hidden} {isoutlook} theme-bg-color-1 theme-border-2"> <{contEl}><p class="dates"><span class="dtstart" title="{from}">{start}</span> - <span class="dtend" title="{to}">{end}</span></p><p class="description">{desc}</p><a class="summary theme-color-1" href="{uri}">{name}</a><span class="location">{where}</span><span class="duration" title="{duration}">{duration}</span><span class="category">{tags}</span></{contEl}></{el}>');Alfresco.CalendarHelper.addTemplate("agendaDay","<h2>{date}</h2>");Alfresco.CalendarHelper.addTemplate("agendaDayItem",'<li class="vevent"><span>{start} - {end}</span><a href="{uri}" class="summary">{name}</a></li>');Alfresco.CalendarHelper.addTemplate("createEventButton",'<button id="addEventButton"><img src="{addEventUrl}" alt="{addEvent}" /></button>');Alfresco.CalendarHelper.addTemplate("taggedTitle",'<span class="tagged">{taggedWith} <span class="theme-color-2">\'{tag}\'</span></span>');