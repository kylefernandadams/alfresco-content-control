(function(){var i=YAHOO.util.Dom;var f=Alfresco.util.encodeHTML,g=Alfresco.util.combinePaths,h=Alfresco.util.siteURL;Alfresco.DocumentActions=function(m){Alfresco.DocumentActions.superclass.constructor.call(this,"Alfresco.DocumentActions",m,["button"]);this.actionsView="details";YAHOO.Bubbling.on("filesPermissionsUpdated",this.doRefresh,this);YAHOO.Bubbling.on("metadataRefresh",this.doRefresh,this);YAHOO.Bubbling.on("registerAction",this.onRegisterAction,this);return this};YAHOO.extend(Alfresco.DocumentActions,Alfresco.component.Base);YAHOO.lang.augmentProto(Alfresco.DocumentActions,Alfresco.doclib.Actions);YAHOO.lang.augmentObject(Alfresco.DocumentActions.prototype,{options:{nodeRef:null,siteId:null,containerId:"documentLibrary",inlineEditMimetypes:{"text/plain":true,"text/html":true,"text/xml":true},rootNode:"alfresco://company/home",replicationUrlMapping:{},documentDetails:null,repositoryBrowsing:true},recordData:null,doclistMetadata:null,currentPath:null,onReady:function d(){var z=this;this.recordData=this.options.documentDetails.item;this.doclistMetadata=this.options.documentDetails.metadata;this.currentPath=this.recordData.location.path;this.recordData.jsNode=new Alfresco.util.Node(this.recordData.node);var v=this.recordData,o=v.node,p=v.actions,q=i.get(this.id+"-actionSet"),y="",u;v.actionParams={};for(var t=0,C=p.length;t<C;t++){y+=this.renderAction(p[t],v)}var n=this.getActionUrls(v);q.innerHTML=YAHOO.lang.substitute(y,n);i.addClass(q,"action-set");i.setStyle(q,"visibility","visible");var A=v.displayName,s=n.downloadUrl;var B=function w(F,E){var D=YAHOO.Bubbling.getOwnerByTagName(E[1].anchor,"div");if(D!==null){if(typeof z[D.id]==="function"){E[1].stop=true;try{z[D.id].call(z,z.recordData,D)}catch(G){Alfresco.logger.error("DocumentActions_fnActionHandler",D.id,G)}}}return true};YAHOO.Bubbling.addDefaultAction("action-link",B,true);this.modules.actions=new Alfresco.module.DoclibActions();if(window.location.hash=="#editOffline"){window.location.hash="";var m=false;YAHOO.Bubbling.on("editingCanceled",function(E,D){if(v.workingCopy.sourceNodeRef==D[1].record.workingCopy.sourceNodeRef){m=true}},this);if(YAHOO.env.ua.ie>6){Alfresco.util.PopupManager.displayPrompt({title:this.msg("message.edit-offline.success",A),text:this.msg("message.edit-offline.success.ie7"),buttons:[{text:this.msg("button.download"),handler:function r(){window.location=s;this.destroy()},isDefault:true},{text:this.msg("button.close"),handler:function x(){this.destroy()}}]})}else{Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-offline.success",A)});YAHOO.lang.later(3000,this,function(){if(!m){window.location=s}})}}if(window.location.hash=="#editCancelled"){window.location.hash="";Alfresco.util.PopupManager.displayMessage({text:this.msg("message.edit-cancel.success",A)})}if(window.location.hash=="#unlockDocument"){window.location.hash="";Alfresco.util.PopupManager.displayMessage({text:this.msg("message.unlock-document.success",A)})}if(window.location.hash=="#newVersionUpload"){window.location.hash="";Alfresco.util.PopupManager.displayMessage({text:this.msg("message.new-version-upload.success")})}},onActionEditOffline:function c(o){var m=o.displayName,n=new Alfresco.util.NodeRef(o.nodeRef);this.modules.actions.genericAction({success:{callback:{fn:function p(q){this.recordData.jsNode.setNodeRef(q.json.results[0].nodeRef);window.location=this.getActionUrls(this.recordData).documentDetailsUrl+"#editOffline"},scope:this}},failure:{message:this.msg("message.edit-offline.failure",m)},webscript:{method:Alfresco.util.Ajax.POST,name:"checkout/node/{nodeRef}",params:{nodeRef:n.uri}}})},onActionCancelEditing:function j(p){var m=p.displayName,o=new Alfresco.util.NodeRef(p.nodeRef);this.modules.actions.genericAction({success:{callback:{fn:function n(s){var r=this.recordData.jsNode.nodeRef.nodeRef,q=s.json.results[0].nodeRef;this.recordData.jsNode.setNodeRef(q);window.location=this.getActionUrls(this.recordData).documentDetailsUrl+"#editCancelled";if(r==q){window.location.reload()}},scope:this}},failure:{message:this.msg("message.edit-cancel.failure",m)},webscript:{method:Alfresco.util.Ajax.POST,name:"cancel-checkout/node/{nodeRef}",params:{nodeRef:o.uri}}});YAHOO.Bubbling.fire("editingCanceled",{record:p})},onActionUnlockDocument:function b(p){var m=p.displayName,o=new Alfresco.util.NodeRef(p.nodeRef);this.modules.actions.genericAction({success:{callback:{fn:function n(s){var r=this.recordData.jsNode.nodeRef.nodeRef,q=s.json.results[0].nodeRef;this.recordData.jsNode.setNodeRef(q);window.location=this.getActionUrls(this.recordData).documentDetailsUrl+"#unlockDocument";if(r==q){window.location.reload()}},scope:this}},failure:{message:this.msg("message.unlock-document.failure",m)},webscript:{method:Alfresco.util.Ajax.POST,name:"unlock-document/node/{nodeRef}",params:{nodeRef:o.uri}}});YAHOO.Bubbling.fire("editingCanceled",{record:p})},onActionUploadNewVersion:function k(q){var n=q.displayName,p=new Alfresco.util.NodeRef(q.nodeRef),m=q.version;if(!this.fileUpload){this.fileUpload=Alfresco.getFileUploadInstance()}var s=this.msg("label.filter-description",n),o="*";if(n&&new RegExp(/[^\.]+\.[^\.]+/).exec(n)){o="*"+n.substring(n.lastIndexOf("."))}if(q.workingCopy&&q.workingCopy.workingCopyVersion){m=q.workingCopy.workingCopyVersion}var r={updateNodeRef:p.toString(),updateFilename:n,updateVersion:m,suppressRefreshEvent:true,overwrite:true,filter:[{description:s,extensions:o}],mode:this.fileUpload.MODE_SINGLE_UPDATE,onFileUploadComplete:{fn:this.onNewVersionUploadCompleteCustom,scope:this}};if(Alfresco.util.isValueSet(this.options.siteId)){r.siteId=this.options.siteId;r.containerId=this.options.containerId}this.fileUpload.show(r)},onNewVersionUploadCompleteCustom:function a(m){this.recordData.jsNode.setNodeRef(m.successful[0].nodeRef);var p=this.getActionUrls(this.recordData).documentDetailsUrl+"#newVersionUpload";var o=this.recordData.jsNode.nodeRef.nodeRef,n=this.recordData.nodeRef;Alfresco.Share.postActivity(this.options.siteId,"org.alfresco.documentlibrary.file-updated",m.successful[0].fileName,"document-details?nodeRef="+m.successful[0].nodeRef,{fileName:m.successful[0].fileName,nodeRef:m.successful[0].nodeRef},function(){window.location=p;if(o==n){window.location.reload()}})},_onActionDeleteConfirm:function l(o){var u=o.location.path;if(Alfresco.constants.PAGECONTEXT=="mine"||Alfresco.constants.PAGECONTEXT=="shared"){var v=u.substring(1);if(Alfresco.constants.PAGECONTEXT=="mine"){v=v.substring(v.indexOf("/")+1)}var m=v.indexOf("/");if(m!=-1){u=v.substring(m)}else{u=""}}var n=o.fileName,s=o.displayName,t=new Alfresco.util.NodeRef(o.nodeRef),r="",p=u.length>1?"?path="+encodeURIComponent(u):"";if(Alfresco.constants.PAGECONTEXT=="mine"){r="myfiles"}else{if(Alfresco.constants.PAGECONTEXT=="shared"){r="sharedfiles"}else{r=Alfresco.util.isValueSet(this.options.siteId)?"documentlibrary":"repository"}}this.modules.actions.genericAction({success:{activity:{siteId:this.options.siteId,activityType:"file-deleted",page:"documentlibrary",activityData:{fileName:n,path:u,nodeRef:t.toString()}},callback:{fn:function q(w){window.location=h(r+p)}}},failure:{message:this.msg("message.delete.failure",s)},webscript:{method:Alfresco.util.Ajax.DELETE,name:"file/node/{nodeRef}",params:{nodeRef:t.uri}}})},doRefresh:function e(){YAHOO.Bubbling.unsubscribe("filesPermissionsUpdated",this.doRefresh,this);YAHOO.Bubbling.unsubscribe("metadataRefresh",this.doRefresh,this);this.refresh("components/document-details/document-actions?nodeRef={nodeRef}"+(this.options.siteId?"&site={siteId}":""))}},true)})();