(function(){var c=YAHOO.util.Dom,B=YAHOO.util.Event,u=YAHOO.util.Element;var v=Alfresco.util.encodeHTML;Alfresco.DiscussionsTopic=function(C){this.name="Alfresco.DiscussionsTopic";this.id=C;this.widgets={};this.modules={};this.tagId={id:0,tags:{}};Alfresco.util.ComponentManager.register(this);Alfresco.util.YUILoaderHelper.require(["datasource","json","connection","event","button","menu","editor"],this.onComponentsLoaded,this);YAHOO.Bubbling.on("tagSelected",this.onTagSelected,this);YAHOO.Bubbling.on("addedNewReply",this.onAddedNewReply,this);return this};Alfresco.DiscussionsTopic.prototype={options:{siteId:"",containerId:"discussions",topicId:""},topicData:null,widgets:null,modules:null,tagId:null,busy:false,setOptions:function g(C){this.options=YAHOO.lang.merge(this.options,C);return this},setMessages:function n(C){Alfresco.util.addMessages(C,this.name);return this},onComponentsLoaded:function p(){B.onContentReady(this.id,this.onReady,this,true)},onReady:function f(){var C=this;var D=function E(H,G){var F=YAHOO.Bubbling.getOwnerByTagName(G[1].anchor,"div");if(F!==null){var I="";I=F.className;if(typeof C[I]=="function"){C[I].call(C,C.topicData.name);G[1].stop=true}}return true};YAHOO.Bubbling.addDefaultAction("topic-action-link-div",D);Alfresco.util.tags.registerTagActionHandler(this);Alfresco.util.rollover.registerHandlerFunctions(this.id,this.onTopicElementMouseEntered,this.onTopicElementMouseExited,this);this._loadTopicData()},_loadTopicData:function k(){var D=function E(F){var H=F.json;if(H){this.topicData=H.item;this.renderUI();this._fireTopicDataChangedEvent()}else{var G=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/discussions-topiclist",{site:this.options.siteId});window.location=G}};var C=YAHOO.lang.substitute(Alfresco.constants.URL_SERVICECONTEXT+"components/forum/post/site/{site}/{container}/{topicId}",{site:this.options.siteId,container:this.options.containerId,topicId:this.options.topicId});Alfresco.util.Ajax.request({url:C,successCallback:{fn:D,scope:this},failureMessage:this._msg("message.loadtopicdata.failure")})},renderUI:function e(){var C=c.get(this.id+"-topic-view-div");var D=this.renderTopic(this.topicData);C.innerHTML=D;Alfresco.util.rollover.registerListenersByClassName(this.id,"topic","div")},renderTopic:function A(E){var D="";D+='<div id="'+this.id+'-topicview" class="node topic topicview">';D+='<div class="nodeEdit">';if(E.permissions.reply){D+='<div class="onAddReply"><a href="#" class="topic-action-link-div">'+this._msg("action.reply")+"</a></div>"}if(E.permissions.edit){D+='<div class="onEditTopic"><a href="#" class="topic-action-link-div">'+this._msg("action.edit")+"</a></div>"}if(E.permissions["delete"]){D+='<div class="onDeleteTopic"><a href="#" class="topic-action-link-div">'+this._msg("action.delete")+"</a></div>"}D+="</div>";D+='<div class="authorPicture">'+Alfresco.util.people.generateUserAvatarImg(E.author)+"</div>";D+='<div class="nodeContent">';D+='<div class="nodeTitle"><a href="'+Alfresco.util.discussions.getTopicViewPage(this.options.siteId,this.options.containerId,E.name)+'">'+v(E.title)+"</a> ";if(E.isUpdated){D+='<span class="theme-color-2 nodeStatus">('+this._msg("post.updated")+")</span>"}D+="</div>";D+='<div class="published">';D+='<span class="nodeAttrLabel">'+this._msg("post.createdOn")+": </span>";D+='<span class="nodeAttrValue">'+Alfresco.util.formatDate(E.createdOn)+"</span>";D+='<span class="separator">&nbsp;</span>';D+='<span class="nodeAttrLabel">'+this._msg("post.author")+": </span>";D+='<span class="nodeAttrValue">'+Alfresco.util.people.generateUserLink(E.author)+"</span>";D+="<br />";if(E.lastReplyBy){D+='<span class="nodeAttrLabel">'+this._msg("post.lastReplyBy")+": </span>";D+='<span class="nodeAttrValue">'+Alfresco.util.people.generateUserLink(E.lastReplyBy)+"</span>";D+='<span class="separator">&nbsp;</span>';D+='<span class="nodeAttrLabel">'+this._msg("post.lastReplyOn")+": </span>";D+='<span class="nodeAttrValue">'+Alfresco.util.formatDate(E.lastReplyOn)+"</span>"}else{D+='<span class="nodeAttrLabel">'+this._msg("replies.label")+": </span>";D+='<span class="nodeAttrValue">'+this._msg("replies.noReplies")+"</span>"}D+="</div>";D+='<div class="userLink">'+Alfresco.util.people.generateUserLink(E.author)+" "+this._msg("said")+":</div>";D+='<div class="content yuieditor">'+E.content+"</div>";D+="</div>";D+='<div class="nodeFooter">';D+='<span class="nodeAttrLabel replyTo">'+this._msg("replies.label")+": </span>";D+='<span class="nodeAttrValue">('+E.totalReplyCount+")</span>";D+='<span class="separator">&nbsp;</span>';D+='<span class="nodeAttrLabel tagLabel">'+this._msg("tags.label")+": </span>";if(E.tags.length>0){for(var C=0;C<E.tags.length;C++){if(C>0){D+=", "}D+=Alfresco.util.tags.generateTagLink(this,E.tags[C])}}else{D+='<span class="nodeAttrValue">'+this._msg("tags.noTags")+"</span>"}D+="</div></div></div>";return D},onAddReply:function w(D,C,E){YAHOO.Bubbling.fire("addReplyToPost",{postRef:this.topicData.nodeRef})},onEditTopic:function i(){window.location.href=Alfresco.constants.URL_PAGECONTEXT+"site/"+this.options.siteId+"/discussions-createtopic?topicId="+this.options.topicId},onDeleteTopic:function x(){var D=this;Alfresco.util.PopupManager.displayPrompt({title:this._msg("message.confirm.delete.title"),text:this._msg("message.confirm.delete",v(this.topicData.title)),buttons:[{text:this._msg("button.delete"),handler:function E(){this.destroy();D._deleteTopicConfirm.call(D)}},{text:this._msg("button.cancel"),handler:function C(){this.destroy()},isDefault:true}]})},_deleteTopicConfirm:function m(){if(!this._setBusy(this._msg("message.wait"))){return}var C=function C(E){var F=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/discussions-topiclist",{site:this.options.siteId});window.location=F};var D=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/forum/post/site/{site}/{container}/{topicId}?page=discussions-topicview",{site:this.options.siteId,container:this.options.containerId,topicId:encodeURIComponent(this.options.topicId)});Alfresco.util.Ajax.request({url:D,method:"DELETE",responseContentType:"application/json",successMessage:this._msg("message.delete.success"),successCallback:{fn:C,scope:this},failureMessage:this._msg("message.delete.failure"),failureCallback:{fn:function(E){this._releaseBusy()},scope:this}})},onTagSelected:function r(E,D){var F=D[1];if(F&&(F.tagName!==null)){var C=YAHOO.lang.substitute(Alfresco.constants.URL_PAGECONTEXT+"site/{site}/discussions-topiclist?filterId={filterId}&filterOwner={filterOwner}&filterData={filterData}",{site:this.options.siteId,filterId:"tag",filterOwner:"Alfresco.TagFilter",filterData:encodeURIComponent(F.tagName)});window.location=C}},onAddedNewReply:function o(D,C){this.topicData.totalReplyCount=C[1];this.renderUI()},_loadEditForm:function a(){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/discussions/topic/edit-topic",dataObj:{htmlid:this.id+"-form"},successCallback:{fn:this.onEditFormLoaded,scope:this},failureMessage:this._msg("message.loadeditform.failure")})},onEditFormLoaded:function q(C){var G=this.id+"-form";var F=this.topicData;var D=c.get(this.id+"-topic-edit-div");D.innerHTML=C.serverResponse.responseText;var E=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/forum/post/site/{site}/{container}/{topicId}",{site:this.options.siteId,container:this.options.containerId,topicId:this.options.topicId});c.get(G+"-form").setAttribute("action",E);c.get(G+"-site").setAttribute("value",this.options.siteId);c.get(G+"-container").setAttribute("value",this.options.containerId);c.get(G+"-title").setAttribute("value",F.title);c.get(G+"-content").value=F.content;this._registerEditTopicForm(F,G)},_registerEditTopicForm:function l(D,E){if(this.modules.tagLibrary==undefined){this.modules.tagLibrary=new Alfresco.module.TagLibrary(E);this.modules.tagLibrary.setOptions({siteId:this.options.siteId})}this.modules.tagLibrary.setTags(this.topicData.tags);this.widgets.okButton=new YAHOO.widget.Button(E+"-submit",{type:"submit"});this.widgets.cancelButton=new YAHOO.widget.Button(E+"-cancel",{type:"button"});this.widgets.cancelButton.subscribe("click",this.onEditFormCancelButtonClick,this,true);this.widgets.editor=new YAHOO.widget.SimpleEditor(E+"-content",{height:"180px",width:"700px",dompath:false,animate:false,toolbar:Alfresco.util.editor.getTextOnlyToolbarConfig(this._msg)});this.widgets.editor.addPageUnloadBehaviour(this._msg("message.unsavedChanges.reply"));this.widgets.editor.render();var C=new Alfresco.forms.Form(E+"-form");C.setSubmitElements(this.widgets.okButton);C.setAjaxSubmitMethod(Alfresco.util.Ajax.PUT);C.setAJAXSubmit(true,{successMessage:this._msg("message.savetopic.success"),successCallback:{fn:this.onEditFormSubmitSuccess,scope:this},failureMessage:this._msg("message.savetopic.failure"),failureCallback:{fn:this.onEditFormSubmitFailure,scope:this}});C.setSubmitAsJSON(true);C.doBeforeFormSubmit={fn:function(F,G){this.widgets.cancelButton.set("disabled",true);this.widgets.editor.saveHTML();this.modules.tagLibrary.updateForm(E+"-form","tags");this.widgets.feedbackMessage=Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message(this._msg("message.submitting")),spanClass:"wait",displayTime:0})},scope:this};this.modules.tagLibrary.initialize(C);C.init();this._showEditView()},onEditFormSubmitSuccess:function z(C,D){this._releaseBusy();this.topicData=C.json.item;this.renderUI();this._hideEditView();this._fireTopicDataChangedEvent()},onEditFormSubmitFailure:function d(C,D){this._releaseBusy();this.widgets.cancelButton.set("disabled",false)},onEditFormCancelButtonClick:function(D,C){this._hideEditView()},_hideEditView:function(){var D=c.get(this.id+"-topic-edit-div");var C=c.get(this.id+"-topic-view-div");c.addClass(D,"hidden");c.removeClass(C,"hidden");D.innerHTML=""},_showEditView:function(){var D=c.get(this.id+"-topic-edit-div");var C=c.get(this.id+"-topic-view-div");c.addClass(C,"hidden");c.removeClass(D,"hidden")},onTopicElementMouseEntered:function h(D,C){var E=this.topicData.permissions;if(!(E.edit||E["delete"])){return}c.addClass(C[1].target,"over")},onTopicElementMouseExited:function b(D,C){c.removeClass(C[1].target,"over")},_fireTopicDataChangedEvent:function y(){var C={topicRef:this.topicData.nodeRef,topicTitle:this.topicData.title,topicId:this.topicData.name,topicTotalReplyCount:this.topicData.totalReplyCount};YAHOO.Bubbling.fire("topicDataChanged",C)},_setBusy:function t(C){if(this.busy){return false}this.busy=true;this.widgets.busyMessage=Alfresco.util.PopupManager.displayMessage({text:C,spanClass:"wait",displayTime:0});return true},_releaseBusy:function j(){if(this.busy){this.widgets.busyMessage.destroy();this.busy=false;return true}else{return false}},_msg:function s(C){return Alfresco.util.message.call(this,C,"Alfresco.DiscussionsTopic",Array.prototype.slice.call(arguments).slice(1))}}})();