(function(){var d=YAHOO.util.Dom,E=YAHOO.util.Event;var w=Alfresco.util.encodeHTML,p=Alfresco.util.combinePaths,C=Alfresco.util.hasEventInterest;Alfresco.module.DocumentPicker=function(F,G){Alfresco.module.DocumentPicker.superclass.constructor.call(this,"Alfresco.module.DocumentPicker",F,["button","menu","container","resize","datatable","datasource"]);this.eventGroup=F;YAHOO.Bubbling.on("renderCurrentValue",this.onRenderCurrentValue,this);YAHOO.Bubbling.on("selectedItemAdded",this.onSelectedItemAdded,this);YAHOO.Bubbling.on("selectedItemRemoved",this.onSelectedItemRemoved,this);YAHOO.Bubbling.on("parentChanged",this.onParentChanged,this);YAHOO.Bubbling.on("parentDetails",this.onParentDetails,this);this.pickerId=F+"-cntrl-picker";this.widgets={};this.columns=[];this.currentValueMeta=[];this.selectedItems=[];var G=G||Alfresco.ObjectRenderer;this.options.objectRenderer=new G(this);return this};YAHOO.extend(Alfresco.module.DocumentPicker,Alfresco.component.Base,{options:{objectRenderer:null,currentValue:"",itemType:"cm:content",compactMode:false,multipleSelectMode:true,showLinkToTarget:false,targetLinkTemplate:null,minSearchTermLength:3,maxSearchResults:100,maintainAddedRemovedItems:true,disabled:false,mandatory:false,restrictParentNavigationToDocLib:true,docLibNameAlias:null,objectRendererClass:null},columns:null,currentValueMeta:null,singleSelectedItem:null,selectedItems:null,setOptions:function B(F){Alfresco.module.DocumentPicker.superclass.setOptions.call(this,F);this.options.objectRenderer.setOptions(F);return this},setMessages:function v(F){Alfresco.module.DocumentPicker.superclass.setMessages.call(this,F);this.options.objectRenderer.setMessages(F);return this},onComponentsLoaded:function h(){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/document-picker",dataObj:{htmlid:this.id},successCallback:{fn:this.onTemplateLoaded,scope:this},execScripts:true,failureMessage:"Could not load create site template"})},onReady:function i(){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/document-picker",dataObj:{htmlid:this.id},successCallback:{fn:this.onTemplateLoaded,scope:this},execScripts:true,failureMessage:"Could not load create site template"})},_templateLoaded:false,onTemplateLoaded:function m(F){if(!this._templateLoaded){var H=document.createElement("div");H.innerHTML=F.serverResponse.responseText;var G=d.getFirstChild(H);this.widgets.panel=Alfresco.util.createYUIPanel(G);this._getCurrentValueMeta();if(this.options.disabled==false){if(this.options.compactMode){d.addClass(this.pickerId,"compact")}this._createNavigationControls();this._createSelectedItemsControls();this.widgets.showPicker=Alfresco.util.createYUIButton(this,"showPicker-button",this.onShowPicker);this.widgets.ok=Alfresco.util.createYUIButton(this,"cntrl-ok",this.onOK);this.widgets.cancel=Alfresco.util.createYUIButton(this,"cntrl-cancel",this.onCancel);this._renameGeneratedButton(this.id+"-showPicker-button-button");this._renameGeneratedButton(this.id+"-cntrl-ok-button");this._renameGeneratedButton(this.id+"-cntrl-cancel-button");this._getSavedItems()}this._templateLoaded=true}},_renameGeneratedButton:function e(G){var F=d.get(G);if(F!=null){d.setAttribute(F,"name","-")}},onShowPicker:function u(F,G){if(G!=null){G.set("disabled",true)}this.widgets.panel.show();this._createResizer();this._populateSelectedItems();this.options.objectRenderer.onPickerShow();this.widgets.ok.set("disabled",(this.currentValueMeta&&this.currentValueMeta.length==0)?false:true);YAHOO.Bubbling.fire("refreshItemList",{eventGroup:this});if(F!=null){E.preventDefault(F)}},onFolderUp:function f(G,H){var F=H.get("value");YAHOO.Bubbling.fire("parentChanged",{eventGroup:this,label:F.name,nodeRef:F.nodeRef});E.preventDefault(G)},onOK:function y(H,J){var F=this.getSelectedItems();var I=[];for(var G in this.selectedItems){I.push(G)}this.options.currentValue=I.join(",");if(YAHOO.env.ua.ie!=8){YAHOO.Bubbling.fire("onDocumentsSelected",{items:F})}Alfresco.util.setVar("DocumentPickerSelection",F);this.widgets.panel.hide();d.setAttribute(this.widgets.showPicker,"disabled",false);this.resetSelection();E.preventDefault(H);if(YAHOO.env.ua.ie==8){YAHOO.Bubbling.fire("onDocumentsSelected",{items:F})}},onCancel:function n(F,G){this.widgets.panel.hide();d.setAttribute(this.widgets.showPicker,"disabled",false);this.resetSelection();E.preventDefault(F)},resetSelection:function j(){this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());this.selectedItems=[];Alfresco.util.setVar("DocumentPickerSelection",[])},canItemBeSelected:function z(F){if(!this.options.multipleSelectMode&&this.singleSelectedItem!==null){return false}return(this.selectedItems[F]===undefined)},getSelectedItems:function s(){var G=[];for(var F in this.selectedItems){if(this.selectedItems.hasOwnProperty(F)){G.push(this.selectedItems[F])}}return G},getAddedItems:function b(){var G=[],F=Alfresco.util.arrayToObject(this.options.currentValue.split(","));for(var H in this.selectedItems){if(this.selectedItems.hasOwnProperty(H)){if(!(H in F)){G.push(H)}}}return G},getRemovedItems:function a(){var G=[],F=Alfresco.util.arrayToObject(this.options.currentValue.split(","));for(var H in F){if(F.hasOwnProperty(H)){if(!(H in this.selectedItems)){G.push(H)}}}return G},onRenderCurrentValue:function t(K,H){if(C(this,H)){var F=this.currentValueMeta,J="";if(F===null){J='<span class="error">'+this.msg("label.document-picker-current.failure")+"</span>"}else{for(var I=0,L=F.length;I<L;I++){if(this.options.showLinkToTarget&&this.options.targetLinkTemplate!=null){J+=this.options.objectRenderer.renderItem(F[I],16,"<div>{icon} <a href='"+this.options.targetLinkTemplate+"'>{name}</a></div>")}else{J+=this.options.objectRenderer.renderItem(F[I],16,"<div>{icon} {name}</div>")}}}var G=d.get(this.id+"-currentValueDisplay");if(G){G.innerHTML=J}}},onSelectedItemAdded:function g(G,F){if(C(this,F)){var H=F[1];if(H&&H.item){this.addItem(H.item)}}},addItem:function(F){this.widgets.dataTable.addRow(F);this.selectedItems[F.nodeRef]=F;this.singleSelectedItem=F;this.widgets.ok.set("disabled",false)},onSelectedItemRemoved:function o(G,F){if(C(this,F)){var H=F[1];if(H&&H.item){delete this.selectedItems[H.item.nodeRef];this.singleSelectedItem=null}if(this.selectedItems.length==0){this.widgets.ok.set("disabled",true)}}},onParentChanged:function r(G,F){if(C(this,F)){var H=F[1];if(H&&H.label){this.widgets.navigationMenu.set("label",'<div><span class="item-icon"><img src="'+Alfresco.constants.URL_RESCONTEXT+'components/images/ajax_anim.gif" width="16" height="16" alt="'+this.msg("message.please-wait")+'"></span><span class="item-name">'+w(H.label)+"</span></div>")}}},onParentDetails:function c(J,M){if(C(this,M)){var I=M[1];if(I&&I.parent){var O=[],Q=I.parent,N=this.widgets.navigationMenu,L=N.getMenu(),K=L.getItemGroups()[0],G="";while(Q){O=[Q].concat(O);if(Q.name=="documentLibrary"){if(this.options.docLibNameAlias){Q.name=this.options.docLibNameAlias}if(this.options.restrictParentNavigationToDocLib){break}}Q=Q.parent}var H,P;for(H=0,P=K.length;H<P;H++){L.removeItem(0,0,true)}Q=O[O.length-1];N.set("label",this.options.objectRenderer.renderItem(Q,16,'<div><span class="item-icon">{icon}</span><span class="item-name">{name}</span></div>'));if(O.length>1){this.widgets.folderUp.set("value",O[O.length-2]);this.widgets.folderUp.set("disabled",false)}else{this.widgets.folderUp.set("disabled",true)}var F;for(H=0,P=O.length;H<P;H++){Q=O[H];F=new YAHOO.widget.MenuItem(this.options.objectRenderer.renderItem(Q,16,G+'<span class="item-icon">{icon}</span><span class="item-name">{name}</span>'),{value:Q.nodeRef});F.cfg.addProperty("label",{value:Q.name});L.addItem(F,0);G+="&nbsp;&nbsp;&nbsp;"}L.render()}}},_getCurrentValueMeta:function l(F){var J=this.options.currentValue.split(",");var K=function G(L){this.currentValueMeta=L.json.data.items;YAHOO.Bubbling.fire("renderCurrentValue",{eventGroup:this})};var I=function H(L){this.currentValueMeta=null};Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.PROXY_URI+"api/forms/picker/items",method:"POST",dataObj:{items:J},successCallback:{fn:K,scope:this},failureCallback:{fn:I,scope:this}})},_createNavigationControls:function D(){var F=this;this.widgets.folderUp=new YAHOO.widget.Button(this.pickerId+"-folderUp",{disabled:true});this.widgets.folderUp.on("click",this.onFolderUp,this.widgets.folderUp,this);this.widgets.navigationMenu=new YAHOO.widget.Button(this.pickerId+"-navigator",{type:"menu",menu:this.pickerId+"-navigatorMenu",lazyloadmenu:false});d.get(this.pickerId+"-folderUp-button").name="-";d.get(this.pickerId+"-navigator-button").name="-";this.widgets.navigationMenu.getMenu().subscribe("click",function(H,G){var I=G[1];if(I){YAHOO.Bubbling.fire("parentChanged",{eventGroup:F,label:I.cfg.getProperty("label"),nodeRef:I.value})}})},_createSelectedItemsControls:function k(){var L=this;this.widgets.dataSource=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});var H=function K(R,Q,S,T){var P=L.options.compactMode?16:32;S.width=P-6;d.setStyle(R.parentNode,"width",S.width+"px");R.innerHTML=L.options.objectRenderer.renderItem(Q.getData(),P,'<div class="icon'+P+'">{icon}</div>')};var M=function N(R,Q,S,T){var P;if(L.options.compactMode){P='<h3 class="name">{name}</h3>'}else{P='<h3 class="name">{name}</h3><div class="description">{description}</div>'}R.innerHTML=L.options.objectRenderer.renderItem(Q.getData(),0,P)};var G=function F(Q,P,R,S){d.setStyle(Q.parentNode,"width",R.width+"px");Q.innerHTML='<a href="#" class="remove-item remove-'+L.eventGroup+'" title="'+L.msg("label.document-picker-remove-item")+'"><span class="removeIcon">&nbsp;</span></a>'};var I=[{key:"nodeRef",label:"Icon",sortable:false,formatter:H,width:this.options.compactMode?10:26},{key:"name",label:"Item",sortable:false,formatter:M},{key:"remove",label:"Remove",sortable:false,formatter:G,width:16}];this.widgets.dataTable=new YAHOO.widget.DataTable(this.pickerId+"-selectedItems",I,this.widgets.dataSource,{MSG_EMPTY:this.msg("label.document-picker-selected-items-empty")});var J=function O(S,R){var P=YAHOO.Bubbling.getOwnerByTagName(R[1].anchor,"div");if(P!==null){var V,U,Q,T;V=R[1].target;U=V.offsetParent;Q=L.widgets.dataTable.getRecord(U);if(Q){L.widgets.dataTable.deleteRow(U);YAHOO.Bubbling.fire("selectedItemRemoved",{eventGroup:L,item:Q.getData()})}}return true};YAHOO.Bubbling.addDefaultAction("remove-"+this.eventGroup,J)},_populateSelectedItems:function x(){this.widgets.dataTable.set("MSG_EMPTY",this.msg("label.document-picker-selected-items-empty"));this.widgets.dataTable.deleteRows(0,this.widgets.dataTable.getRecordSet().getLength());this.selectedItems={};this.currentValueMeta=this._getSavedItems();for(var F in this.currentValueMeta){if(this.currentValueMeta.hasOwnProperty(F)){this.selectedItems[this.currentValueMeta[F].nodeRef]=this.currentValueMeta[F];YAHOO.Bubbling.fire("selectedItemAdded",{eventGroup:this,item:this.currentValueMeta[F]})}}},_createResizer:function q(){if(!this.widgets.resizer){var F=parseInt(d.getStyle(this.pickerId+"-body","width"),10);this.columns[0]=d.get(this.pickerId+"-left");this.columns[1]=d.get(this.pickerId+"-right");this.widgets.resizer=new YAHOO.util.Resize(this.pickerId+"-left",{handles:["r"],minWidth:200,maxWidth:(F-200)});this.widgets.resizer.on("resize",function(H){var G=H.width;d.setStyle(this.columns[0],"height","");d.setStyle(this.columns[1],"width",(F-G-10)+"px")},this,true);this.widgets.resizer.fireEvent("resize",{ev:"resize",target:this.widgets.resizer,width:this.widgets.resizer.get("width")})}},_getSavedItems:function A(){var F=Alfresco.util.getVar("DocumentPickerSelection")||[];if(F.length!==0){YAHOO.Bubbling.fire("onDocumentsSelected",{items:F})}return F}})})();