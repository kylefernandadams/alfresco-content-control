(function(){var c=YAHOO.util.Dom,t=YAHOO.util.Event;var n=Alfresco.util.encodeHTML;Alfresco.module.TagLibrary=function(u){Alfresco.module.TagLibrary.superclass.constructor.call(this,"Alfresco.module.TagLibrary",u+"-tagLibrary",["button"]);this.id=u;this.tagId={id:0,tags:{}};this.currentTags=[];this.setTags([]);return this};YAHOO.extend(Alfresco.module.TagLibrary,Alfresco.component.Base,{options:{siteId:"",topN:10},balloon:null,tagId:null,currentTags:null,setCurrentTags:function f(u){this.currentTags=u;return this},formsRuntime:null,initialize:function p(z){var E=this;var F=function A(M,K){var J=YAHOO.Bubbling.getOwnerByTagName(K[1].anchor,"li");if(J!==null){var N="";N=J.getAttribute("class");if(typeof E[N]=="function"){var L=E.findTagName(E,J.id);E[N].call(E,L);K[1].stop=true}}return true};YAHOO.Bubbling.addDefaultAction("taglibrary-action",F);t.addListener(this.id+"-load-popular-tags-link","click",this.onPopularTagsLinkClicked,this,true);var u=new YAHOO.util.KeyListener(this.id+"-load-popular-tags-link",{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:function D(J,K,L){E.onPopularTagsLinkClicked(K[1],this);return true},scope:this,correctScope:true},"keypress");u.enable();var B=new YAHOO.util.KeyListener(this.id+"-tag-input-field",{keys:YAHOO.util.KeyListener.KEY.ENTER},{fn:function D(J,L,M){var K=this.formsRuntime._runValidations(true);if(K){E.onAddTagButtonClick();this.balloon.hide()}t.stopEvent(L[1]);return false},scope:this,correctScope:true},"keypress");B.enable();var v=Alfresco.util.createYUIButton(this,"add-tag-button",this.onAddTagButtonClick,{type:"button",htmlName:"-"});if(z){var H=c.get(this.id+"-tag-input-field");this.balloon=Alfresco.util.createBalloon(H);this.balloon.onClose.subscribe(function(J){try{H.focus()}catch(J){}},this,true);var x=new Alfresco.forms.Form(z.formId);x.setSubmitElements(v);x.setAJAXSubmit(true);x.doBeforeAjaxRequest={fn:function y(J,K){return false},obj:null,scope:this};var G=function(P,K,O,N,J,M){if(!K){K={}}K.pattern=/([\*\\\>\<\?\/\:\|]+)|([\.]?[\.]+$)/;K.match=false;var L=Alfresco.forms.validation.regexMatch(P,K,O,N,J,M);v.set("disabled",!L);return L};var w=Alfresco.util.message("validation-hint.tagName");x.addValidation(this.id+"-tag-input-field",G,null,"keyup",w);x.addValidation(this.id+"-tag-input-field",Alfresco.forms.validation.mandatory);x.addValidation(this.id+"-tag-input-field",Alfresco.forms.validation.length,{max:256,crop:true},"keyup");var I=this;x.addError=function C(K,J){I.balloon.html(K);I.balloon.show()};this.formsRuntime=x}},generateTagId:function q(w,u,x){var y=0,v=w.tagId;if(u in v.tags){y=v.tags[u]}else{v.id++;y=v.tags[u]=v.id}return w.id+"-"+x+"-"+y},findTagName:function d(x,w){var y=w.substring(x.id.length+1),v=y.substring(y.indexOf("-")+1);for(var u in x.tagId.tags){if(x.tagId.tags[u]==v){return u}}return null},setTags:function r(u){var x=c.get(this.id+"-current-tags");if(x!==null){x.innerHTML="";this.currentTags=[];for(var v=0,w=u.length;v<w;v++){this._addTagImpl(u[v])}c.setStyle(this.id+"-load-popular-tags-link","display","inline");c.get(this.id+"-popular-tags").innerHTML="<li></li>"}},getTags:function b(){return this.currentTags},updateForm:function j(D,A){var E=A+"[]";var v=c.get(D);var B=v.getElementsByTagName("input"),C,u;for(C=0;C<B.length;C++){if(B[C].name==E){B[C].parentNode.removeChild(B[C]);C--}}var z=c.getElementsBy(function(x){return(x.name==A||x.name==E)},"input",v);for(i=0;i<z.length;i++){v.removeChild(z[i])}var w,y;if(this.currentTags.length>0){for(C=0,u=this.currentTags.length;C<u;C++){w=this.currentTags[C];y=document.createElement("input");y.setAttribute("name",E);y.setAttribute("value",w);y.setAttribute("type","hidden");v.appendChild(y)}}else{y=document.createElement("input");y.setAttribute("name",A);y.setAttribute("value","");y.setAttribute("type","hidden");v.appendChild(y)}},onRemoveTag:function s(u){this._removeTagImpl(u)},onAddTag:function m(u){this._addTagImpl(u)},onPopularTagsLinkClicked:function a(w,v){var u=YAHOO.lang.substitute(Alfresco.constants.PROXY_URI+"api/tagscopes/site/{site}/tags?d={d}&topN={tn}",{site:Alfresco.constants.SITE,d:new Date().getTime(),tn:this.options.topN});Alfresco.util.Ajax.request({url:u,method:"GET",responseContentType:"application/json",successCallback:{fn:this._onPopularTagsLoaded,scope:this},failureMessage:this.msg("taglibrary.msg.failedLoadTags")});t.stopEvent(w)},_onPopularTagsLoaded:function e(u){this._displayPopularTags(u.json.tags)},_displayPopularTags:function l(u){c.setStyle(this.id+"-load-popular-tags-link","display","none");var z=c.get(this.id+"-popular-tags"),A=Alfresco.util.arrayToObject(this.currentTags),w,y,B;z.innerHTML="";for(var v=0,x=u.length;v<x;v++){w=u[v].name;if(!(w in A)){y=document.createElement("li");B=this.generateTagId(this,w,"onAddTag");y.setAttribute("id",B);y.setAttribute("class","onAddTag");y.innerHTML='<a href="#" class="taglibrary-action"><span>'+n(w)+'</span><span class="add">&nbsp;</span></a>';z.appendChild(y)}}},onAddTagButtonClick:function g(z,y){var v=c.get(this.id+"-tag-input-field"),B=v.value,w=Alfresco.util.getTags(B);for(var u=0,A=w.length;u<A;u++){this._addTagImpl(w[u])}v.value=""},_fireTagsChangedEvent:function h(){YAHOO.Bubbling.fire("onTagLibraryTagsChanged",{tags:this.currentTags})},_addTagImpl:function k(w){if(w===null||w.length<1){return}for(var u=0,A=this.currentTags.length;u<A;u++){if(w==this.currentTags[u]){return}}this.currentTags.push(w);var v=c.get(this.id+"-current-tags"),y=document.createElement("li"),z=this.generateTagId(this,w,"onRemoveTag");y.setAttribute("id",z);y.setAttribute("class","onRemoveTag");y.innerHTML='<a href="#" class="taglibrary-action"><span>'+n(w)+'</span><span class="remove">&nbsp;</span></a>';v.appendChild(y);this._fireTagsChangedEvent()},_removeTagImpl:function o(v){if(v===null||v.length<1){return}for(var u=0;u<this.currentTags.length;u++){if(v==this.currentTags[u]){this.currentTags.splice(u,1);u--}}var y=this.generateTagId(this,v,"onRemoveTag"),w=c.get(y);w.parentNode.removeChild(w);this._fireTagsChangedEvent()}})})();