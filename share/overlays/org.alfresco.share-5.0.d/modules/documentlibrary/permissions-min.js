(function(){var i=YAHOO.util.Dom;var f=Alfresco.util.encodeHTML;Alfresco.module.DoclibPermissions=function(o){Alfresco.module.DoclibPermissions.superclass.constructor.call(this,"Alfresco.module.DoclibPermissions",o,["button","container","connection","json"]);this.rolePickers={};this.hiddenRoles={};return this};YAHOO.extend(Alfresco.module.DoclibPermissions,Alfresco.component.Base,{options:{siteId:"",roles:null,files:null,width:"44em"},rolePickers:null,hiddenRoles:null,containerDiv:null,showDialog:function g(){this.hiddenRoles={};if(!this.modules.actions){this.modules.actions=new Alfresco.module.DoclibActions()}if(!this.containerDiv){Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"modules/documentlibrary/permissions",dataObj:{htmlid:this.id,site:this.options.siteId},successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:"Could not load Document Library Permissions template",execScripts:true})}else{this.nodeRefToRefresh=YAHOO.lang.isArray(this.options.files)?this.options.files[0].node.nodeRef:this.options.files.node.nodeRef;Alfresco.util.Ajax.jsonRequest({url:Alfresco.constants.URL_SERVICECONTEXT+"components/document-details/document-permissions",dataObj:{nodeRef:this.nodeRefToRefresh,site:this.options.siteId,format:"json"},successCallback:{fn:this.onDataRefresh,scope:this},failureMessage:"Could not refresh permissions",execScripts:true})}},onDataRefresh:function b(o){this.setOptions({siteId:o.json.siteId,files:{displayName:this.options.files.displayName,node:{nodeRef:o.json.nodeRef,permissions:{roles:o.json.roles}}}});this._showDialog()},onTemplateLoaded:function d(p){this.containerDiv=document.createElement("div");this.containerDiv.setAttribute("style","display:none");this.containerDiv.innerHTML=p.serverResponse.responseText;var t=i.getFirstChild(this.containerDiv);while(t&&t.tagName.toLowerCase()!="div"){t=i.getNextSibling(t)}this.widgets.dialog=Alfresco.util.createYUIPanel(t,{width:this.options.width});this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok",this.onOK);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel",this.onCancel);var s=YAHOO.util.Selector.query("button.site-group",this.widgets.dialog.element),u,o;for(var r=0,q=s.length;r<q;r++){u=s[r].id;o=s[r].value;this.rolePickers[o]=new YAHOO.widget.Button(u,{type:"menu",menu:u+"-select"});this.rolePickers[o].getMenu().subscribe("click",this.onRoleSelected,this.rolePickers[o])}this.widgets.resetAll=Alfresco.util.createYUIButton(this,"reset-all",this.onResetAll);this._showDialog()},onRoleSelected:function n(p,o,q){var r=o[1];q.set("label",r.cfg.getProperty("text"));q.set("name",r.value)},onResetAll:function c(o,p){this._applyPermissions("reset-all")},onOK:function j(p,q){var o=this._parseUI();this._applyPermissions("set",o)},_applyPermissions:function e(r,u){var p,x=[];p=this.options.files;for(var t=0,s=p.length;t<s;t++){x.push(p[t].node.nodeRef)}var w=function v(B){var y,C=B.json.successCount,D=B.json.failureCount;this._hideDialog();if(!B.json.overallSuccess){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.permissions.failure")});return}YAHOO.Bubbling.fire("filesPermissionsUpdated",{successCount:C,failureCount:D});for(var A=0,z=B.json.totalResults;A<z;A++){y=B.json.results[A];if(y.success){YAHOO.Bubbling.fire(y.type=="folder"?"folderPermissionsUpdated":"filePermissionsUpdated",{multiple:true,nodeRef:y.nodeRef})}}Alfresco.util.PopupManager.displayMessage({text:this.msg("message.permissions.success",C)})};var q=function o(y){this._hideDialog();Alfresco.util.PopupManager.displayMessage({text:this.msg("message.permissions.failure")})};this.modules.actions.genericAction({success:{callback:{fn:w,scope:this}},failure:{callback:{fn:q,scope:this}},webscript:{method:Alfresco.util.Ajax.POST,name:"permissions/{operation}/site/{site}",params:{site:this.options.siteId,operation:r}},config:{requestContentType:Alfresco.util.Ajax.JSON,dataObj:{nodeRefs:x,permissions:u}}});this.widgets.okButton.set("disabled",true);this.widgets.cancelButton.set("disabled",true)},onCancel:function a(o,p){this._hideDialog()},_showDialog:function h(){var t,s;this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false);var q=i.get(this.id+"-title");if(YAHOO.lang.isArray(this.options.files)){q.innerHTML=this.msg("title.multi",this.options.files.length)}else{var o='<span class="light">'+f(this.options.files.displayName)+"</span>";q.innerHTML=this.msg("title.single",o);this.options.files=[this.options.files]}for(var w in this.rolePickers){if(this.rolePickers.hasOwnProperty(w)){this.rolePickers[w].set("name","");this.rolePickers[w].set("label",this.msg("role.None"))}}var r=this.options.files[0].node.permissions.roles,v;for(t=0,s=r.length;t<s;t++){v=r[t].split(";");if(v[1] in this.rolePickers){if(v[2].indexOf("Site")===0){this.rolePickers[v[1]].set("name",v[2]);var p=this.msg("role."+v[2]);if(p==="role."+v[2]){p=v[2]}this.rolePickers[v[1]].set("label",p)}else{this.hiddenRoles[v[1]]={user:v[1],role:v[2]}}}else{if(v[1]!=="GROUP_EVERYONE"||this.options.isSitePublic){this.hiddenRoles[v[1]]={user:v[1],role:v[2]}}}}var u=new YAHOO.util.KeyListener(document,{keys:YAHOO.util.KeyListener.KEY.ESCAPE},{fn:function(y,x){this.onCancel()},scope:this,correctScope:true});u.enable();this.widgets.dialog.show()},_hideDialog:function k(){var o=i.get(this.id+"-form");Alfresco.util.undoCaretFix(o);this.widgets.dialog.hide()},_parseUI:function l(){var q=[],r;for(var o in this.hiddenRoles){q.push({group:this.hiddenRoles[o].user,role:this.hiddenRoles[o].role})}for(var p in this.rolePickers){if(this.rolePickers.hasOwnProperty(p)){r=this.rolePickers[p].get("name");if(r&&r!=="None"){q.push({group:this.rolePickers[p].get("value"),role:r})}}}return q}});var m=new Alfresco.module.DoclibPermissions("null")})();