(function(){var b=YAHOO.util.Dom,C=YAHOO.util.Event,q=YAHOO.util.KeyListener,v=YAHOO.util.Selector;var s=Alfresco.util.encodeHTML,p=Alfresco.util.combinePaths,z=Alfresco.util.hasEventInterest;Alfresco.module.DoclibGlobalFolder=function(D){Alfresco.module.DoclibGlobalFolder.superclass.constructor.call(this,"Alfresco.module.DoclibGlobalFolder",D,["button","container","connection","json","treeview"]);this.containers={};if(D!="null"){this.eventGroup=D;try{YAHOO.Bubbling.unsubscribe("siteChanged",null,this);YAHOO.Bubbling.unsubscribe("containerChanged",null,this)}catch(E){}YAHOO.Bubbling.on("siteChanged",this.onSiteChanged,this);YAHOO.Bubbling.on("containerChanged",this.onContainerChanged,this)}return this};var x=Alfresco.module.DoclibGlobalFolder;YAHOO.lang.augmentObject(x,{VIEW_MODE_SITE:0,VIEW_MODE_REPOSITORY:1,VIEW_MODE_USERHOME:2,VIEW_MODE_RECENT_SITES:3,VIEW_MODE_FAVOURITE_SITES:4,VIEW_MODE_SHARED:5});YAHOO.extend(Alfresco.module.DoclibGlobalFolder,Alfresco.component.Base,{options:{siteId:"",siteTitle:"",containerId:"documentLibrary",containerType:"cm:folder",rootNode:"alfresco://company/home",sharedRoot:"alfresco://company/shared",userHome:"alfresco://user/home",path:"",pathNodeRef:null,width:"60em",files:null,templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/documentlibrary/global-folder",viewMode:x.VIEW_MODE_RECENT_SITES,defaultView:x.VIEW_MODE_RECENT_SITES,allowedViewModes:[x.VIEW_MODE_SITE,x.VIEW_MODE_RECENT_SITES,x.VIEW_MODE_FAVOURITE_SITES,x.VIEW_MODE_SHARED,x.VIEW_MODE_REPOSITORY,x.VIEW_MODE_USERHOME],evaluateChildFoldersSite:true,maximumFolderCountSite:-1,webscriptTimeout:7000,evaluateChildFoldersRepo:true,maximumFolderCountRepo:-1,siteTreeContainerTypes:{},sitesAPI:Alfresco.constants.PROXY_URI+"api/people/"+encodeURIComponent(Alfresco.constants.USERNAME)+"/sites",recentSitesAPI:Alfresco.constants.PROXY_URI+"api/people/"+encodeURIComponent(Alfresco.constants.USERNAME)+"/sites/recent",favouriteSitesAPI:Alfresco.constants.PROXY_URI+"api/people/"+encodeURIComponent(Alfresco.constants.USERNAME)+"/sites/favourites",containersAPI:Alfresco.constants.PROXY_URI+"slingshot/doclib/containers/",templateFailMessage:"Could not load 'global-folder' template"},containerDiv:null,pathsToExpand:null,selectedNode:null,containers:null,showDialog:function k(){if(!this.containerDiv){Alfresco.util.Ajax.request({url:this.options.templateUrl,dataObj:{htmlid:this.id},successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:this.options.templateFailMessage,execScripts:true})}else{this._beforeShowDialog()}},onTemplateLoaded:function m(E){var I=this;this.containerDiv=document.createElement("div");this.containerDiv.setAttribute("style","display:none");this.containerDiv.innerHTML=E.serverResponse.responseText;var G=b.getFirstChild(this.containerDiv);this.widgets.dialog=Alfresco.util.createYUIPanel(G,{width:this.options.width});this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok",this.onOK);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel",this.onCancel);var K=new YAHOO.widget.ButtonGroup(this.id+"-modeGroup");K.on("checkedButtonChange",this.onViewModeChange,this.widgets.modeButtons,this);this.widgets.modeButtons=K;var H=this.widgets.modeButtons.getButtons(),J=function(L){if(q.KEY.ENTER==L.keyCode){this.set("checked",true)}};for(var F=0;F<H.length;F++){H[F].addListener("keydown",J)}this.fnLoadNodeData=function D(P,M){var N=P.data.path;var O=I._buildTreeNodeUrl.call(I,N);var R={success:function L(V){var U=Alfresco.util.parseJSON(V.responseText);if(U.parent){if(P.data.nodeRef.indexOf("alfresco://")===0){P.data.nodeRef=U.parent.nodeRef}if(typeof P.data.userAccess=="undefined"){P.data.userAccess=U.parent.userAccess;P.setUpLabel({label:P.label,style:U.parent.userAccess.create?"":"no-permission"});if(U.parent.userAccess.create==false){P.parent.refresh();if(this.selectedNode==P){this.widgets.okButton.set("disabled",true)}}}}if(U.items){var W,Y;for(var T=0,S=U.items.length;T<S;T++){W=U.items[T];var X=this.options.mode=="sync"&&Alfresco.util.arrayContains(W.aspects,"sync:syncSetMemberNode");Y=new YAHOO.widget.TextNode({label:W.name,path:p(N,W.name),nodeRef:W.nodeRef,description:W.description,userAccess:X?false:W.userAccess,style:X?"no-permission":(W.userAccess.create?"":"no-permission")},P,false);if(!W.hasChildren){Y.isLeaf=true}}if(U.resultsTrimmed){Y=new YAHOO.widget.TextNode({label:"<"+this.msg("message.folders-trimmed",U.items.length)+">",hasIcon:false,style:"folders-trimmed"},P,false)}}V.argument.fnLoadComplete()},failure:function Q(V){try{var U=YAHOO.lang.JSON.parse(V.responseText);var T=this.widgets.treeview.getRoot();var S=T.children[0];S.isLoading=false;S.isLeaf=true;S.label=U.message;S.labelStyle="ygtverror";T.refresh()}catch(W){}},scope:I,argument:{node:P,fnLoadComplete:M},timeout:I.options.webscriptTimeout};if(YAHOO.env.ua.ie>0){O+=(O.indexOf("?")==-1?"?":"&")+"noCache="+new Date().getTime()}YAHOO.util.Connect.asyncRequest("GET",O,R)};this._beforeShowDialog()},_beforeShowDialog:function r(){if(this.options.pathNodeRef){var D=Alfresco.constants.PROXY_URI+"slingshot/doclib/node/"+this.options.pathNodeRef.uri+"/location";if(this.options.rootNode){D+="?libraryRoot="+encodeURIComponent(this.options.rootNode.toString())}Alfresco.util.Ajax.jsonGet({url:D,successCallback:{fn:function(F){if(F.json!==undefined){var E=F.json;if(E.site){this.options.viewMode=x.prototype.options.defaultView;this.options.path=p(E.site.path,E.site.file);this.options.siteId=E.site.site;this.options.siteTitle=E.site.siteTitle}else{this.options.viewMode=x.VIEW_MODE_REPOSITORY;this.options.path=p(E.repo.path,E.repo.file);this.options.siteId=null;this.options.siteTitle=null}this._showDialog()}},scope:this},failureMessage:this.msg("message.failure")})}else{this._showDialog()}},_showDialog:function o(){this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false);var D=b.get(this.id+"-title");if(this.options.title){D.innerHTML=this.options.title}else{if(YAHOO.lang.isArray(this.options.files)){D.innerHTML=this.msg("title.multi",this.options.files.length)}else{D.innerHTML=this.msg("title.single",'<span class="light">'+s(this.options.files.displayName)+"</span>")}}var L=Alfresco.util.arrayToObject(this.options.allowedViewModes);for(var G=0;G<Alfresco.constants.HIDDEN_PICKER_VIEW_MODES.length;G++){delete L[x[Alfresco.constants.HIDDEN_PICKER_VIEW_MODES[G]]]}var I=this.widgets.modeButtons.getButtons(),E,F;if(!(this.options.viewMode in L)){this.options.viewMode=this.options.allowedViewModes[0]}for(var G=0,M=I.length;G<M;G++){E=I[G];F=parseInt(E.get("name"),10);E.set("disabled",!(F in L));E.setStyle("display",F in L?"block":"none");if(F==this.options.viewMode){if(E.get("checked")){this.setViewMode(F)}else{E.set("checked",true)}}}if(!this.widgets.escapeListener){this.widgets.escapeListener=new q(document,{keys:q.KEY.ESCAPE},{fn:function(O,N){this.onCancel()},scope:this,correctScope:true})}if(this.options.zIndex!==undefined&&this.options.zIndex>0){var J=this.options.zIndex+2;var K=this.widgets.dialog;var H=function(){elements=b.getElementsByClassName("mask");if(elements.length>0){b.setStyle(elements[0],"zIndex",J-1)}b.setStyle(K.element,"zIndex",J);K.cfg.setProperty("zIndex",J,true)};this.widgets.dialog.beforeShowEvent.subscribe(H,this.widgets.dialog,true)}this.widgets.escapeListener.enable();this.widgets.dialog.show()},setViewMode:function i(D){this.options.viewMode=D;if(this._isSiteViewMode(D)){b.get(this.id+"-treeview").innerHTML="";b.removeClass(this.id+"-wrapper","repository-mode");this._populateSitePicker(D)}else{b.addClass(this.id+"-wrapper","repository-mode");var E=this.options.rootNode;if(D==x.VIEW_MODE_USERHOME){E=this.options.userHome}else{if(D==x.VIEW_MODE_SHARED){E=this.options.sharedRoot}}this._buildTree(E);this.onPathChanged(this.options.path?this.options.path:"/")}},onSiteChanged:function y(I,G){if(z(this,G)){var K=G[1];if(K!==null){if(K.site!==null){this.options.siteId=K.site;this.options.siteTitle=K.siteTitle;this._populateContainerPicker();var J=v.query("a",this.id+"-sitePicker"),F,H,E,D=b.get(this.id+"-sitePicker");for(H=0,E=J.length;H<E;H++){F=J[H];if(F.getAttribute("rel")==K.site){b.addClass(F,"selected");if(K.scrollTo){D.scrollTop=b.getY(F)-b.getY(D)}}else{b.removeClass(F,"selected")}}}}}},onContainerChanged:function f(I,G){if(z(this,G)){var K=G[1];if(K!==null){if(K.container!==null){this.options.containerId=K.container;this.options.containerType=this.containers[K.container].type;this._buildTree(this.containers[K.container].nodeRef);this.onPathChanged(this.options.path);var J=v.query("a",this.id+"-containerPicker"),D,H,F,E=b.get(this.id+"-containerPicker");for(H=0,F=J.length;H<F;H++){D=J[H];if(D.getAttribute("rel")==K.container){b.addClass(D,"selected");if(K.scrollTo){E.scrollTop=b.getY(D)-b.getY(E)}}else{b.removeClass(D,"selected")}}}}}},onOK:function j(E,F){this.widgets.escapeListener.disable();this.widgets.dialog.hide();var D=this.selectedNode?this.selectedNode.data:null;if(D&&this._isSiteViewMode(this.options.viewMode)){D.siteId=this.options.siteId;D.siteTitle=this.options.siteTitle;D.containerId=this.options.containerId}YAHOO.Bubbling.fire("folderSelected",{selectedFolder:D,eventGroup:this})},onCancel:function a(D,E){this.widgets.escapeListener.disable();this.widgets.dialog.hide()},onViewModeChange:function l(F,G){var E=this.options.viewMode;try{E=parseInt(F.newValue.get("name"),10);this.setViewMode(E)}catch(D){}},onExpandComplete:function h(G){Alfresco.logger.debug("DLGF_onExpandComplete");this.widgets.treeview.render();this._showHighlight(true);if(this.pathsToExpand&&this.pathsToExpand.length>0){var F=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift());if(F!==null){var E=F.getContentEl(),D=b.get(this.id+"-treeview");D.scrollTop=b.getY(E)-(D.scrollHeight/3);if(F.data.path==this.currentPath){this._updateSelectedNode(F)}F.expand()}}},onNodeClicked:function u(E){Alfresco.logger.debug("DLGF_onNodeClicked");var G=E.event,F=E.node,D=F.data.userAccess;if((D&&D.create)||(F.data.nodeRef=="")||(F.data.nodeRef.indexOf("alfresco://")===0)){this.onPathChanged(F.data.path);this._updateSelectedNode(F)}C.preventDefault(G);return false},onPathChanged:function d(H){this._showHighlight(false);this.selectedNode=null;Alfresco.logger.debug("DLGF_onPathChanged:"+H);if(H.charAt(0)!="/"){H="/"+H}this.currentPath=H;var G=this.widgets.treeview.getNodeByProperty("path",H);if(G!==null){this._updateSelectedNode(G);G.expand();while(G.parent!==null){G=G.parent;G.expand()}return}var I=H.split("/"),F="/";if(H==="/"){I=[""]}this.pathsToExpand=[];for(var E=0,D=I.length;E<D;E++){F=p("/",F,I[E]);this.pathsToExpand.push(F)}Alfresco.logger.debug("DLGF_onPathChanged paths to expand:"+this.pathsToExpand.join(","));do{G=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift());if(this.selectedNode==null){this._updateSelectedNode(G)}}while(this.pathsToExpand.length>0&&G.expanded);if(G!==null){G.expand()}},_populateSitePicker:function w(G){var E=b.get(this.id+"-sitePicker"),I=this;E.innerHTML="";var H=function D(M,Q){var R=M.json,O,K,P,N,T=null;var S=function L(U){return function(){YAHOO.Bubbling.fire("siteChanged",{site:U.shortName,siteTitle:U.title,eventGroup:I});return false}};if(R.length>0){T=R[0]}for(P=0,N=R.length;P<N;P++){K=R[P];if(Alfresco.util.arrayToObject(K.shortName)){if(T==null){T=K}O=document.createElement("div");if(P==N-1){b.addClass(O,"last")}O.innerHTML='<a rel="'+K.shortName+'" href="#""><h4>'+s(K.title)+"</h4><span>"+s(K.description)+"</span></a>";O.onclick=S(K);Q.appendChild(O)}}if(T!=null){YAHOO.Bubbling.fire("siteChanged",{site:(this.options.siteId&&this.options.siteId.length>0)?this.options.siteId:T.shortName,siteTitle:(this.options.siteId&&this.options.siteId.length>0)?this.options.siteTitle:T.title,eventGroup:this,scrollTo:true})}};var J=this.options.sitesAPI;if(G===x.VIEW_MODE_RECENT_SITES){J=this.options.recentSitesAPI}else{if(G===x.VIEW_MODE_FAVOURITE_SITES){J=this.options.favouriteSitesAPI}}var F={url:J,responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:H,scope:this,obj:E},failureCallback:null};Alfresco.util.Ajax.request(F)},_populateContainerPicker:function e(){var K=b.get(this.id+"-containerPicker"),H=this;K.innerHTML="";var G=function D(N,S){var M=N.json.containers,P,L,Q,O;this.containers={};var T=function R(U){return function(){YAHOO.Bubbling.fire("containerChanged",{container:U,eventGroup:H});return false}};for(Q=0,O=M.length;Q<O;Q++){L=M[Q];this.containers[L.name]=L;P=document.createElement("div");if(Q==O-1){b.addClass(P,"last")}P.innerHTML='<a rel="'+L.name+'" href="#"><h4>'+L.name+"</h4><span>"+L.description+"</span></a>";P.onclick=T(L.name);S.appendChild(P)}YAHOO.Bubbling.fire("containerChanged",{container:this.options.containerId,eventGroup:this,scrollTo:true})};var J=function I(N){try{var M=this.widgets.treeview.getRoot(),L=M.children[0];L.isLoading=false;L.isLeaf=true;L.label=this.msg("message.error");L.labelStyle="ygtverror";M.refresh()}catch(O){}K.innerHTML=""};var F=Alfresco.util.parseURL(this.options.containersAPI);F.pathname+=this.options.siteId;var E={url:F.getUrl(),responseContentType:Alfresco.util.Ajax.JSON,successCallback:{fn:G,scope:this,obj:K},failureCallback:{fn:J,scope:this}};Alfresco.util.Ajax.request(E)},_buildTree:function g(G){Alfresco.logger.debug("DLGF__buildTree");var D=new YAHOO.widget.TreeView(this.id+"-treeview");this.widgets.treeview=D;YAHOO.widget.TreeView.FOCUS_CLASS_NAME="";D.setDynamicLoad(this.fnLoadNodeData);var E="location.path.repository";if(this._isSiteViewMode(this.options.viewMode)){var F=this.options.siteTreeContainerTypes[this.options.containerType]||{};E=F.rootLabel||"location.path.documents"}else{if(this.options.viewMode==x.VIEW_MODE_USERHOME){E="location.path.myfiles"}else{if(this.options.viewMode==x.VIEW_MODE_SHARED){E="location.path.shared"}}}var H=new YAHOO.widget.TextNode({label:this.msg(E),path:"/",nodeRef:G},D.getRoot(),false);D.subscribe("clickEvent",this.onNodeClicked,this,true);D.subscribe("expandComplete",this.onExpandComplete,this,true);D.render()},_showHighlight:function n(D){Alfresco.logger.debug("DLGF__showHighlight");if(this.selectedNode!==null){if(D){b.addClass(this.selectedNode.getEl(),"selected")}else{b.removeClass(this.selectedNode.getEl(),"selected")}}},_updateSelectedNode:function t(D){Alfresco.logger.debug("DLGF__updateSelectedNode");this._showHighlight(false);this.selectedNode=D;this._showHighlight(true);if(D.data.userAccess&&!D.data.userAccess.create){this.widgets.okButton.set("disabled",true)}else{this.widgets.okButton.set("disabled",false)}},_buildTreeNodeUrl:function c(F){var G=Alfresco.constants.PROXY_URI;if(this._isSiteViewMode(this.options.viewMode)){var D=this.options.siteTreeContainerTypes[this.options.containerType]||{};if(D.uri){G+=D.uri}else{G+="slingshot/doclib/treenode/site/{site}/{container}{path}";G+="?children={evaluateChildFoldersSite}";G+="&max={maximumFolderCountSite}"}}else{if(this.options.viewMode==x.VIEW_MODE_USERHOME){G+="slingshot/doclib/treenode/node/{userHome}{path}";G+="?children={evaluateChildFoldersRepo}"}else{if(this.options.viewMode==x.VIEW_MODE_SHARED){G+="slingshot/doclib/treenode/node/{sharedRootPath}{path}";G+="?children={evaluateChildFoldersRepo}";G+="&libraryRoot={sharedRoot}"}else{G+="slingshot/doclib/treenode/node/alfresco/company/home{path}";G+="?children={evaluateChildFoldersRepo}";G+="&libraryRoot={rootNode}"}}G+="&max={maximumFolderCountRepo}"}var E=YAHOO.lang.substitute(G,{site:encodeURIComponent(this.options.siteId),container:encodeURIComponent(this.options.containerId),rootNode:this.options.rootNode,userHome:(this.options.userHome||"").replace(":/",""),sharedRoot:this.options.sharedRoot,sharedRootPath:this.options.sharedRoot.replace(":/",""),path:Alfresco.util.encodeURIPath(F),evaluateChildFoldersSite:this.options.evaluateChildFoldersSite+"",maximumFolderCountSite:this.options.maximumFolderCountSite,evaluateChildFoldersRepo:this.options.evaluateChildFoldersRepo+"",maximumFolderCountRepo:this.options.maximumFolderCountRepo});return E},_isSiteViewMode:function B(E){var D=[x.VIEW_MODE_SITE,x.VIEW_MODE_FAVOURITE_SITES,x.VIEW_MODE_RECENT_SITES];return(Alfresco.util.arrayContains(D,E))}});var A=new Alfresco.module.DoclibGlobalFolder("null")})();