(function(){var k=YAHOO.util.Dom,c=YAHOO.util.KeyListener;var g=Alfresco.util.encodeHTML,i=Alfresco.util.combinePaths;Alfresco.module.DoclibSiteFolder=function(r){Alfresco.module.DoclibSiteFolder.superclass.constructor.call(this,"Alfresco.module.DoclibSiteFolder",r,["button","container","connection","json","treeview"]);this.pathsToExpand=[];return this};YAHOO.extend(Alfresco.module.DoclibSiteFolder,Alfresco.component.Base,{options:{siteId:"",containerId:"documentLibrary",path:"",width:"40em",files:null,templateUrl:null,evaluateChildFolders:true,maximumFolderCount:-1},containerDiv:null,pathsToExpand:null,selectedNode:null,showDialog:function m(){if(!this.containerDiv){Alfresco.util.Ajax.request({url:this.options.templateUrl,dataObj:{htmlid:this.id},successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:"Could not load template:"+this.options.templateUrl,execScripts:true})}else{this._showDialog()}},onTemplateLoaded:function a(r){var u=this;this.containerDiv=document.createElement("div");this.containerDiv.setAttribute("style","display:none");this.containerDiv.innerHTML=r.serverResponse.responseText;var t=k.getFirstChild(this.containerDiv);this.widgets.dialog=Alfresco.util.createYUIPanel(t,{width:this.options.width});this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok",this.onOK);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel",this.onCancel);this.fnLoadNodeData=function s(z,w){var x=z.data.path;var y=u._buildTreeNodeUrl.call(u,x);var B={success:function A(F){var E=Alfresco.util.parseJSON(F.responseText);if(E.items){var G,H;for(var D=0,C=E.items.length;D<C;D++){G=E.items[D];H=new YAHOO.widget.TextNode({label:g(G.name),path:i(x,G.name),nodeRef:G.nodeRef,description:G.description,userAccess:G.userAccess,style:G.userAccess.create?"":"no-permission"},z,false);if(!G.hasChildren){H.isLeaf=true}}if(E.resultsTrimmed){H=new YAHOO.widget.TextNode({label:"<"+this.msg("message.folders-trimmed",E.items.length)+">",hasIcon:false,style:"folders-trimmed"},z,false)}}F.argument.fnLoadComplete()},failure:function v(F){try{var E=YAHOO.lang.JSON.parse(F.responseText);var D=this.widgets.treeview.getRoot();var C=D.children[0];C.isLoading=false;C.isLeaf=true;C.label=E.message;C.labelStyle="ygtverror";D.refresh()}catch(G){}},scope:u,argument:{node:z,fnLoadComplete:w},timeout:7000};YAHOO.util.Connect.asyncRequest("GET",y,B)};this._showDialog()},_showDialog:function l(){if(this.options.files===null){Alfresco.util.PopupManager.displayMessage({text:this.msg("message.no-files")});return}this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false);var s=k.get(this.id+"-title");if(YAHOO.lang.isArray(this.options.files)){s.innerHTML=this.msg("title.multi",this.options.files.length)}else{s.innerHTML=this.msg("title.single",'<span class="light">'+g(this.options.files.displayName)+"</span>")}this._buildTree();var r=new c(document,{keys:c.KEY.ESCAPE},{fn:function(u,t){this.onCancel()},scope:this,correctScope:true});r.enable();this.widgets.dialog.show();if(this.options.path!==null){this.onPathChanged(this.options.path)}},onOK:function d(r,s){this.widgets.dialog.hide()},onCancel:function f(r,s){this.widgets.dialog.hide()},onExpandComplete:function o(u){Alfresco.logger.debug("DLSF_onExpandComplete");this.widgets.treeview.render();this._showHighlight(true);if(this.pathsToExpand&&this.pathsToExpand.length>0){var t=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift());if(t!==null){var s=t.getContentEl(),r=k.get(this.id+"-treeview");r.scrollTop=k.getY(s)-(r.scrollHeight/3);if(t.data.path==this.currentPath){this._updateSelectedNode(t)}t.expand()}}},onNodeClicked:function j(s){Alfresco.logger.debug("DLSF_onNodeClicked");var t=s.node,r=t.data.userAccess;if((r&&r.create)||(t.data.nodeRef=="")){this.onPathChanged(t.data.path);this._updateSelectedNode(t)}return false},onPathChanged:function b(v){Alfresco.logger.debug("DLSF_onPathChanged");v=i("/",v);this.currentPath=v;var u=this.widgets.treeview.getNodeByProperty("path",v);if(u!==null){this._updateSelectedNode(u);u.expand();while(u.parent!==null){u=u.parent;u.expand()}return}var w=v.split("/"),t="/";if(v==="/"){w=[""]}this.pathsToExpand=[];for(var s=0,r=w.length;s<r;s++){t=i(t,w[s]);this.pathsToExpand.push(t)}do{u=this.widgets.treeview.getNodeByProperty("path",this.pathsToExpand.shift())}while(this.pathsToExpand.length>0&&u.expanded);if(u!==null){u.expand()}},_buildTree:function q(){Alfresco.logger.debug("DLSF__buildTree");var r=new YAHOO.widget.TreeView(this.id+"-treeview");this.widgets.treeview=r;YAHOO.widget.TreeView.FOCUS_CLASS_NAME="";r.setDynamicLoad(this.fnLoadNodeData);var s=new YAHOO.widget.TextNode({label:this.msg("node.root"),path:"/",nodeRef:""},r.getRoot(),false);r.subscribe("clickEvent",this.onNodeClicked,this,true);r.subscribe("expandComplete",this.onExpandComplete,this,true);r.render()},_showHighlight:function e(r){Alfresco.logger.debug("DLSF__showHighlight");if(this.selectedNode!==null){if(r){k.addClass(this.selectedNode.getEl(),"selected")}else{k.removeClass(this.selectedNode.getEl(),"selected")}}},_updateSelectedNode:function n(r){Alfresco.logger.debug("DLSF__updateSelectedNode");this._showHighlight(false);this.selectedNode=r;this._showHighlight(true)},_buildTreeNodeUrl:function h(s){var t=Alfresco.constants.PROXY_URI+"slingshot/doclib/treenode/site/{site}/{container}{path}";t+="?children="+this.options.evaluateChildFolders+"&max="+this.options.maximumFolderCount;var r=YAHOO.lang.substitute(t,{site:encodeURIComponent(this.options.siteId),container:encodeURIComponent(this.options.containerId),path:Alfresco.util.encodeURIPath(s)});return r}});var p=new Alfresco.module.DoclibSiteFolder("null")})();