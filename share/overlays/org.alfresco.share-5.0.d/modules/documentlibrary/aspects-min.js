(function(){var g=YAHOO.util.Dom,n=YAHOO.util.Event;var d=Alfresco.util.encodeHTML;Alfresco.module.DoclibAspects=function(o){Alfresco.module.DoclibAspects.superclass.constructor.call(this,o,["button","container","datasource","datatable"]);this.eventGroup=o;this.currentValues=[];this.selectedValues={};return this};YAHOO.extend(Alfresco.module.DoclibAspects,Alfresco.module.SimpleDialog,{currentValues:null,selectedValues:null,setOptions:function f(o){Alfresco.module.DoclibAspects.superclass.setOptions.call(this,{width:"50em",templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/documentlibrary/aspects",doBeforeDialogShow:{fn:this.doBeforeDialogShow,obj:null,scope:this},doBeforeAjaxRequest:{fn:this.doBeforeAjaxRequest,obj:null,scope:this}});this.options=YAHOO.lang.merge(this.options,o);return this},renderItem:function b(q,p){var o=function(v,x,w){var s="";if(v.toLowerCase()=="icon"){var u="",r="",t;if(w&&w.length>0){t=w.split(" ");u=' width="'+t[0]+'"';if(t.length>1){r=' height="'+t[1]+'"'}}s='<img src="'+x+'"'+u+r+' alt="'+d(q.name)+'" title="'+d(q.name)+'" />'}else{s=d(x)}return s};return YAHOO.lang.substitute(p,q,o)},i18n:function l(o,p){return this.msg("aspect."+o.replace(":","_"))},doBeforeDialogShow:function i(p,r,q){var o='<span class="light">'+d(this.options.file.displayName)+"</span>";g.get(this.id+"-title").innerHTML=this.msg("title",o);if(!this.modules.actions){this.modules.actions=new Alfresco.module.DoclibActions(Alfresco.doclib.MODE_REPOSITORY)}this._createAspectsControls();this._requestAspectData();this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false)},doBeforeAjaxRequest:function a(r){var p=function q(t){this.hide();Alfresco.util.PopupManager.displayMessage({text:this.msg(t.json.overallSuccess?"message.aspects.success":"message.aspects.failure")});if(t.json.results[0].tagScope){}};var s=function o(t){this.hide();Alfresco.util.PopupManager.displayMessage({text:this.msg("message.aspects.failure")})};this.modules.actions.genericAction({success:{event:{name:"metadataRefresh",obj:{highlightFile:this.options.file.name}},callback:{fn:p,scope:this}},failure:{callback:{fn:s,scope:this}},webscript:{method:Alfresco.util.Ajax.POST,name:"aspects/node/{nodeRef}",params:{nodeRef:this.options.file.jsNode.nodeRef.uri}},config:{requestContentType:Alfresco.util.Ajax.JSON,dataObj:{added:this.getAddedValues(),removed:this.getRemovedValues()}}});return false},getAddedValues:function m(){var q=[],o=Alfresco.util.arrayToObject(this.currentValues);for(var p in this.selectedValues){if(this.selectedValues.hasOwnProperty(p)){if(!(p in o)){q.push(p)}}}return q},getRemovedValues:function k(){var q=[],o=Alfresco.util.arrayToObject(this.currentValues);for(var p in o){if(o.hasOwnProperty(p)){if(!(p in this.selectedValues)){q.push(p)}}}return q},_createAspectsControls:function j(){var v=this;var t=function t(z,y,A,B){g.setStyle(z.parentNode,"width",A.width+"px");z.innerHTML=v.renderItem(y.getData(),"<div>{icon 16 16}</div>")};var w=function w(z,y,A,B){z.innerHTML=v.renderItem(y.getData(),'<h3 class="name">{name}</h3>')};var o=function o(z,y,A,B){g.setStyle(z.parentNode,"width",A.width+"px");if(y.getData("canAdd")){z.innerHTML='<a href="#" class="add-item add-'+v.eventGroup+'" title="'+v.msg("button.add")+'"><span class="addIcon">&nbsp;</span></a>'}};var r=function r(z,y,A,B){g.setStyle(z.parentNode,"width",A.width+"px");if(y.getData("canRemove")){z.innerHTML='<a href="#" class="remove-item remove-'+v.eventGroup+'" title="'+v.msg("button.remove")+'"><span class="removeIcon">&nbsp;</span></a>'}};this.widgets.dataSourceLeft=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});var u=[{key:"icon",label:"icon",sortable:false,formatter:t,width:10},{key:"name",label:"name",sortable:false,formatter:w},{key:"id",label:"add",sortable:false,formatter:o,width:16}];this.widgets.dataTableLeft=new YAHOO.widget.DataTable(this.id+"-left",u,this.widgets.dataSourceLeft,{MSG_EMPTY:this.msg("label.loading")});var q=function p(B,A){var y=YAHOO.Bubbling.getOwnerByTagName(A[1].anchor,"div");if(y!==null){var D=A[1].target,C=D.offsetParent,z=v.widgets.dataTableLeft.getRecord(C);if(z){v.widgets.dataTableRight.addRow(z.getData());v.selectedValues[z.getData("id")]=z;v.widgets.dataTableLeft.deleteRow(C)}}return true};YAHOO.Bubbling.addDefaultAction("add-"+this.eventGroup,q,true);this.widgets.dataSourceRight=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});var s=[{key:"icon",label:"icon",sortable:false,formatter:t,width:10},{key:"name",label:"name",sortable:false,formatter:w},{key:"id",label:"remove",sortable:false,formatter:r,width:16}];this.widgets.dataTableRight=new YAHOO.widget.DataTable(this.id+"-right",s,this.widgets.dataSourceRight,{MSG_EMPTY:this.msg("label.loading")});var x=function x(B,A){var y=YAHOO.Bubbling.getOwnerByTagName(A[1].anchor,"div");if(y!==null){var D=A[1].target,C=D.offsetParent,z=v.widgets.dataTableRight.getRecord(C);if(z){v.widgets.dataTableLeft.addRow(z.getData());delete v.selectedValues[z.getData("id")];v.widgets.dataTableRight.deleteRow(C)}}return true};YAHOO.Bubbling.addDefaultAction("remove-"+this.eventGroup,x,true)},_requestAspectData:function e(){this.selectedValues={};Alfresco.util.Ajax.request({method:"GET",url:Alfresco.constants.PROXY_URI+"slingshot/doclib/aspects/node/"+this.options.file.jsNode.nodeRef.uri,successCallback:{fn:this._requestAspectDataSuccess,scope:this},failureCallback:{fn:this._requestAspectDataFailure,scope:this}})},_requestAspectDataFailure:function h(){this.widgets.dataTableLeft.set("MSG_EMPTY",this.msg("label.load-failure"));this.widgets.dataTableRight.set("MSG_EMPTY",this.msg("label.load-failure"))},_requestAspectDataSuccess:function c(r){this.currentValues={};if(typeof r.json!="undefined"){var q=r.json.current,o=Alfresco.util.arrayToObject(q),B=this.options.visible,A=Alfresco.util.arrayToObject(B),x=this.options.addable,s=this.options.removeable,t,z;this.currentValues=q;if(x.length===0){x=B.slice(0)}if(s.length===0){s=B.slice(0)}var v=Alfresco.util.arrayToObject(x),p=Alfresco.util.arrayToObject(s);var w,y,u;for(t=0,z=q.length;t<z;t++){w=q[t];u={id:w,icon:Alfresco.constants.URL_RESCONTEXT+"components/images/aspect-16.png",name:this.i18n(w),canAdd:w in v,canRemove:w in p};if(w in A){this.widgets.dataTableRight.addRow(u)}this.selectedValues[w]=u}for(t=0,z=x.length;t<z;t++){y=x[t];if((y in A)&&!(y in o)){this.widgets.dataTableLeft.addRow({id:y,icon:Alfresco.constants.URL_RESCONTEXT+"components/images/aspect-16.png",name:this.i18n(y),canAdd:true,canRemove:true})}}this.widgets.dataTableLeft.set("MSG_EMPTY",this.msg("label.no-addable"));this.widgets.dataTableRight.set("MSG_EMPTY",this.msg("label.no-current"));this.widgets.dataTableLeft.render();this.widgets.dataTableRight.render()}}})})();var doclibAspects=new Alfresco.module.DoclibAspects("null");