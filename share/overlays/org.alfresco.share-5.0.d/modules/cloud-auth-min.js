(function(){var f=YAHOO.util.Dom,a=YAHOO.util.KeyListener;Alfresco.module.CloudAuth=function(p){Alfresco.module.CloudAuth.superclass.constructor.call(this,p);this.name="Alfresco.module.CloudAuth";Alfresco.util.ComponentManager.reregister(this);if(p!="null"){this.eventGroup=p}return this};YAHOO.extend(Alfresco.module.CloudAuth,Alfresco.component.Base,{options:{getAuthURL:Alfresco.constants.PROXY_URI+"cloud/person/credentials"},authDetails:{},isAuthenticated:function b(){return(typeof(this.getAuthUser())!=="undefined")?true:false},checkAuth:function l(){var p=this.displayPrompt;YAHOO.Bubbling.on("authDetailsAvailable",this.onAuthDetailsAvailable,this);Alfresco.util.Ajax.jsonGet({url:this.options.getAuthURL,successCallback:{fn:function q(r){if(r.json!==undefined){this.authDetails=r.json;YAHOO.Bubbling.fire("authDetailsAvailable",{authDetails:this.authDetails})}},scope:this},failureMessage:"Error checking cloud authentication details"})},getAuthUser:function o(){return this.authDetails.username},onAuthDetailsAvailable:function c(){YAHOO.Bubbling.unsubscribe("authDetailsAvailable",this.onAuthDetailsAvailable,this);if(this.isAuthenticated()){this.callAuthCallback()}else{this.displayPrompt()}},displayPrompt:function h(){this.options.formId=this.id+"-authForm";Alfresco.util.Ajax.request({url:Alfresco.constants.URL_SERVICECONTEXT+"cloud/cloud-auth-form?htmlid="+this.options.formId,successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:"Could not load html template for cloud authentication",execScripts:true});this.widgets.escapeListener=new a(document,{keys:a.KEY.ESCAPE},{fn:this.onCancel,scope:this,correctScope:true})},onTemplateLoaded:function i(p){var q=document.createElement("div");q.innerHTML=p.serverResponse.responseText;this.widgets.panel=Alfresco.util.createYUIPanel(q,{width:"498px"});this._showPanel();this.setUpForm()},_showPanel:function m(p){this.widgets.escapeListener.enable();this.widgets.panel.show();if(p){f.addClass(f.get(this.options.formId+"-form"),"show-error")}},callAuthCallback:function j(){this.options.authCallback.apply(this.options.authCallbackContext)},setUpForm:function e(){this.widgets.ok=Alfresco.util.createYUIButton(this,"authForm-button-ok",null,{type:"submit"});this.widgets.cancel=Alfresco.util.createYUIButton(this,"authForm-button-cancel",this.onCancel);var q=new Alfresco.forms.Form(this.id+"-authForm-form");q.setSubmitElements(this.widgets.ok);q.setSubmitAsJSON(true);q.setAJAXSubmit(true,{successCallback:{fn:this.onFormSubmitSuccess,scope:this},failureCallback:{fn:this.onFormSubmitFailure,scope:this}});q.doBeforeFormSubmit={fn:function p(){Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("label.validating")})},scope:this};q.init()},onCancel:function d(){this.destroy()},onFormSubmitSuccess:function g(p){if(p.json.loginValid===true){YAHOO.Bubbling.fire("authDetailsAvailable",{authDetails:p.json});this.callAuthCallback();this.widgets.panel.destroy()}else{if(p.json.loginValid===false&&p.json.remoteSystemAvailable===true){this._showPanel(true)}else{this.onFormSubmitFailure(p)}}},onFormSubmitFailure:function k(p){Alfresco.util.PopupManager.displayMessage({text:Alfresco.util.message("label.validationError")})}});var n=new Alfresco.module.CloudAuth("null")})();