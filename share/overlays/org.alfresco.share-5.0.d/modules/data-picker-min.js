(function(){var b=YAHOO.util.Dom,e=YAHOO.util.KeyListener,l=YAHOO.util.Selector;var j=Alfresco.util.encodeHTML,d=Alfresco.util.combinePaths,o=Alfresco.util.hasEventInterest;Alfresco.module.DataPicker=function(s){Alfresco.module.DataPicker.superclass.constructor.call(this,"Alfresco.module.DataPicker",s,["button","container","connection","datasource","datatable","json","tabview","treeview","resize"]);this.widgets.dataSources={};this.widgets.dataTables={};return this};YAHOO.extend(Alfresco.module.DataPicker,Alfresco.component.Base,{options:{templateUrl:Alfresco.constants.URL_SERVICECONTEXT+"modules/data-picker",urlTokens:{"person.username":encodeURIComponent(Alfresco.constants.USERNAME),"url.proxy":Alfresco.constants.PROXY_URI_RELATIVE,"url.service":Alfresco.constants.URL_SERVICECONTEXT},tabs:[],dataTableSelectionMode:"single",dataTableColumnDefinitions:[{key:"label",sortable:true}]},selectedItem:null,showDialog:function r(){if(!this.containerDiv){Alfresco.util.Ajax.request({url:this.options.templateUrl,dataObj:{htmlid:this.id},successCallback:{fn:this.onTemplateLoaded,scope:this},failureMessage:"Could not load template:"+this.options.templateUrl,execScripts:true})}else{this._showDialog()}},onTemplateLoaded:function k(s){var u=this;this.containerDiv=document.createElement("div");this.containerDiv.setAttribute("style","display:none");this.containerDiv.innerHTML=s.serverResponse.responseText;var t=b.getFirstChild(this.containerDiv);this.widgets.dialog=Alfresco.util.createYUIPanel(t);this.widgets.okButton=Alfresco.util.createYUIButton(this,"ok-button",this.onOkButtonClick);this.widgets.cancelButton=Alfresco.util.createYUIButton(this,"cancel-button",this.onCancelButtonClick);this._createTabs();this._showDialog()},_createTabs:function k(){var v=this.options.tabs.length;if(v>1){this.widgets.tabView=new YAHOO.widget.TabView(this.id+"-tabs")}else{b.setStyle(this.id+"-tabs","display","none")}var t=0,u,s,x;for(var w=0;w<v;w++){u=this.options.tabs[w];if(v>1){x=new YAHOO.widget.Tab({label:this.msg("tabs."+u.id),content:"",active:t==0});this.widgets.tabView.addTab(x);s=x.get("contentEl");b.addClass(s,u.id)}else{s=this.widgets.dialog.body}if(u.treeNodes){this._setupTree(u,s)}if(u.listItems){this._setupList(u,s);this._loadListItems(u,null,u.listItems,"tabs."+u.id+".list.data")}t++}},_setupTree:function f(w,t){var x=this;var v=document.createElement("div");b.addClass(v,"data-picker-tree");t.appendChild(v);var s=new YAHOO.widget.TreeView(v),u=s.getRoot();this._loadTreeNodes(u,null,w.treeNodes,"tabs."+w.id+".tree.data",null);var z=function(C,E){var A=C.data.node;var D=C,B="";do{B="."+D.data.node.id+B;D=D.parent}while(!D.isRoot());x._loadTreeNodes(C,A,A.treeNodes,"tabs."+w.id+".tree.data"+B,E)};var y=function(A){var C=A.node.data,B=C.listItems;if(B){var E=A.node,D="";do{D="."+E.data.id+D;E=E.parent}while(!E.isRoot());x._loadListItems(w,C,B,"tabs."+w.id+".tree"+D+".list.data")}};s.setDynamicLoad(z);s.subscribe("clickEvent",y);s.render(v)},_setupList:function f(u,s){var z=new YAHOO.util.DataSource([],{responseType:YAHOO.util.DataSource.TYPE_JSARRAY});for(var v=0,t=this.options.dataTableColumnDefinitions.length,x;v<t;v++){x=this.options.dataTableColumnDefinitions[v];if(!x.label){x.label=this.msg("tabs."+u.id+".list."+x.key)}}var y=document.createElement("div");b.addClass(y,"data-picker-list");s.appendChild(y);var w=new YAHOO.widget.DataTable(y,this.options.dataTableColumnDefinitions,z,{renderLoopSize:32,initialLoad:false,MSG_EMPTY:this.msg("message.instructions"),selectionMode:this.options.dataTableSelectionMode});w.subscribe("rowMouseoverEvent",w.onEventHighlightRow);w.subscribe("rowMouseoutEvent",w.onEventUnhighlightRow);w.subscribe("rowClickEvent",function(A,D){for(var B in this.widgets.dataTables){var C=this.widgets.dataTables[B];C.unselectAllRows();if(B==D.tabObj.id){C.selectRow(A.target);this.selectedItem=C.getRecord(A.target).getData()}}},{tabObj:u},this);this.widgets.dataTables[u.id]=w},_buildUrl:function n(v,s){var u={},w;if(v){for(var t in v){if(v.hasOwnProperty(t)){w=v[t];u["node."+t]=YAHOO.lang.isString(w)?w.replace(":","_"):w}}}return YAHOO.lang.substitute(s,YAHOO.lang.merge(u,this.options.urlTokens))},_getValue:function c(t,s,x,v){if(x&&x[s]){if(x[s].indexOf("{")>-1){var w={};for(var u in t){if(t.hasOwnProperty(u)){w[v+"."+u]=t[u]}}var y=YAHOO.lang.substitute(x[s],w);if(y!=x[s]){return y}else{return null}}else{return x[s]}}if(t[s]){return t[s]}},_getLabel:function m(s,w,u,v){var t=this._getValue(s,"label",w,v);if(t){return t}else{var y=this._getValue(s,"id",w,v),x=u+"."+y;t=this.msg(x);return t!=x?t:y}},_loadTreeNodes:function a(C,A,D,B,z){if(YAHOO.lang.isObject(D)&&D.url){var t=this._buildUrl(A,D.url,"node");Alfresco.util.Ajax.jsonGet({url:t,successCallback:{fn:function(E,G){var F=E.json;if(G.treeNodeObjs.path){F=Alfresco.util.findValueByDotNotation(F,G.treeNodeObjs.path)}if(YAHOO.lang.isArray(F)){this._loadTreeNodes(G.parentNode,G.parentNodeObj,F,G.msgPath);G.yuiTreeCallback()}else{throw Error("Could not find an array in the response from: "+t)}},obj:{parentNode:C,parentNodeObj:A,treeNodeObjs:D,yuiTreeCallback:z,msgPath:B},scope:this}})}else{if(YAHOO.lang.isArray(D)){var v=A?A.treeNodes:{},u;if(v.dataModifier){D=v.dataModifier.call(this,D,v)}var s=[],w;for(var x=0,y=D.length;x<y;x++){u=D[x];w={id:this._getValue(u,"id",v,"node"),title:this._getValue(u,"title",v,"node"),label:this._getLabel(u,v,B,"node"),listItems:u.listItems?u.listItems:v.listItems,treeNodes:u.treeNodes?u.treeNodes:v.treeNodes,node:u};w.isLeaf=!u.treeNodes;s.push(w)}s.sort(this._sortList);for(x=0,y=s.length;x<y;x++){new YAHOO.widget.TextNode(s[x],C)}}}},_loadListItems:function h(s,A,C,B){var u=this.widgets.dataTables[s.id];u.deleteRows(0,u.getRecordSet().getLength());if(YAHOO.lang.isObject(C)&&C.url){var t=this._buildUrl(A.node,C.url);Alfresco.util.Ajax.jsonGet({url:t,successCallback:{fn:function(E,F){var D=E.json;if(F.listItemObjs.path){D=Alfresco.util.findValueByDotNotation(D,F.listItemObjs.path)}if(YAHOO.lang.isArray(D)){this._loadListItems(F.tabObj,F.parentNodeObj,D,F.msgPath)}else{throw Error("Could not find an array in the response from: "+t)}},obj:{tabObj:s,dataTable:u,parentNodeObj:A,listItemObjs:C,msgPath:B},scope:this}})}else{if(YAHOO.lang.isArray(C)){var v=A?A.listItems:{},y=[],z;if(v.dataModifier){C=v.dataModifier.call(this,C,v)}for(var w=0,x=C.length;w<x;w++){z=C[w];y.push({id:this._getValue(z,"id",v,"item"),type:this._getValue(z,"type",v,"item"),label:this._getLabel(z,v,B,"item"),item:z})}y.sort(this._sortList);u.addRows(y,0)}}},_showDialog:function g(){b.get(this.id+"-title").innerHTML=this.msg("header");this.widgets.okButton.set("disabled",false);this.widgets.cancelButton.set("disabled",false);this.widgets.dialog.show()},_sortList:function g(u,s){var v=u.label?u.label.toLowerCase():"",t=s.label?s.label.toLowerCase():"";return(v>t)?1:(v<t)?-1:0},onOkButtonClick:function i(s,t){this.widgets.dialog.hide();YAHOO.Bubbling.fire("dataItemSelected",{selectedItem:this.selectedItem,eventGroup:this})},onCancelButtonClick:function q(s,t){this.widgets.dialog.hide();YAHOO.Bubbling.fire("dataItemSelectionCancelled",{eventGroup:this})}});var p=new Alfresco.module.DataPicker("null")})();